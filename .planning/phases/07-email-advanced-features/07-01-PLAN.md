---
phase: 07-email-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/package.json
  - functions/src/email/templates/PropertyEmail.tsx
  - functions/src/email/sendPropertyEmail.ts
  - functions/src/index.ts
  - src/components/customer/SendEmailButton.tsx
  - src/pages/CustomerDetail.tsx
autonomous: true
requirements:
  - ILET-06
user_setup:
  - service: resend
    why: "Email sending API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (https://resend.com/api-keys) -> Create API Key"
    dashboard_config:
      - task: "Verify domain for production sending (optional for testing)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "User can click 'E-posta Gonder' button on customer detail page"
    - "Email is sent via Cloud Function with property details"
    - "Toast notification confirms email sent or shows error"
  artifacts:
    - path: "functions/src/email/templates/PropertyEmail.tsx"
      provides: "React Email template for property card"
      contains: "PropertyEmail"
    - path: "functions/src/email/sendPropertyEmail.ts"
      provides: "Callable Cloud Function for sending email"
      exports: ["sendPropertyEmail"]
    - path: "src/components/customer/SendEmailButton.tsx"
      provides: "Email send button component"
      contains: "SendEmailButton"
  key_links:
    - from: "src/components/customer/SendEmailButton.tsx"
      to: "sendPropertyEmail"
      via: "httpsCallable"
      pattern: "httpsCallable.*sendPropertyEmail"
    - from: "functions/src/email/sendPropertyEmail.ts"
      to: "PropertyEmail"
      via: "react email template"
      pattern: "import.*PropertyEmail"
---

<objective>
Implement email sending infrastructure with Resend API and React Email templates, allowing users to send property details to customers directly from the system.

Purpose: Enable direct email communication with customers, satisfying ILET-06 requirement
Output: Cloud Function for email sending, React Email property template, SendEmailButton component
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-advanced-features/07-RESEARCH.md

# Existing code patterns
@functions/src/config.ts
@functions/src/index.ts
@src/pages/CustomerDetail.tsx
@src/types/customer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Resend and create PropertyEmail template</name>
  <files>
    functions/package.json
    functions/src/email/templates/PropertyEmail.tsx
  </files>
  <action>
1. Install required packages in functions/:
   ```bash
   cd functions && npm install resend @react-email/components
   ```

2. Create functions/src/email/templates/PropertyEmail.tsx:
   - Use React Email components (Html, Head, Body, Container, Section, Img, Text, Button, Hr)
   - Accept props: customerName (string), property (object with title, price, location, propertyType, rooms, area, photos, description)
   - Turkish content: "Merhaba {customerName}," greeting, "Size uygun olabilecek bir mulk bulduk:" intro
   - Property card section with:
     - First photo if available (width 560px, border-radius 8px)
     - Title in 20px bold
     - Price in 24px green (format: toLocaleString('tr-TR') + ' TL')
     - Location, property type, rooms, area with emoji icons
     - Description if available
     - "Mulku Incele" button (blue, links to property page)
   - Footer: "Bu e-posta size emlak danisman tarafindan gonderilmistir."
   - All styles inline (email compatibility)
   - Container max-width 600px, white background

3. Use styling patterns from research:
   - main: backgroundColor '#f6f9fc', fontFamily system fonts
   - container: backgroundColor '#ffffff', margin '0 auto', padding '20px 0 48px'
   - propertyCard: padding '24px', border '1px solid #e5e7eb', borderRadius '8px'
  </action>
  <verify>
    - cd functions && npm ls resend @react-email/components
    - Check functions/src/email/templates/PropertyEmail.tsx exists and exports PropertyEmail component
  </verify>
  <done>
    - Resend and React Email packages installed in functions/
    - PropertyEmail template renders Turkish property card email with all styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sendPropertyEmail Cloud Function</name>
  <files>
    functions/src/email/sendPropertyEmail.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/email/sendPropertyEmail.ts:
   - Import onCall, HttpsError from 'firebase-functions/v2/https'
   - Import Resend from 'resend'
   - Import db from '../config'
   - Import PropertyEmail from './templates/PropertyEmail'
   - Initialize Resend with process.env.RESEND_API_KEY
   - Use REGION from config for europe-west1

2. Implement sendPropertyEmail onCall function:
   - Check request.auth exists, throw HttpsError('unauthenticated') if not
   - Extract customerId, propertyId from request.data
   - Fetch customer from users/{userId}/customers/{customerId}
   - Fetch property from users/{userId}/properties/{propertyId}
   - Validate both exist, throw HttpsError('not-found') if not
   - Validate customer.email exists, throw HttpsError('failed-precondition', 'Musterinin e-posta adresi yok')

3. Send email via Resend:
   - from: 'Emlak Danismani <noreply@resend.dev>' (use resend.dev for testing)
   - to: customer.email
   - subject: `Mulk Onerisi: ${property.title}`
   - react: PropertyEmail({ customerName: customer.name, property })
   - tags: [{ name: 'type', value: 'property_email' }, { name: 'customer_id', value: customerId }, { name: 'property_id', value: propertyId }]

4. Handle response:
   - If error, throw HttpsError('internal', error.message)
   - Store email record in users/{userId}/customers/{customerId}/emails subcollection:
     - emailId: data.id (Resend email ID)
     - propertyId
     - subject
     - status: 'sent'
     - sentAt: new Date()
     - events: []
   - Return { success: true, emailId: data.id }

5. Update functions/src/index.ts:
   - Add export: export { sendPropertyEmail } from './email/sendPropertyEmail';
  </action>
  <verify>
    - Check functions/src/email/sendPropertyEmail.ts exports sendPropertyEmail
    - Check functions/src/index.ts includes sendPropertyEmail export
    - cd functions && npx tsc --noEmit (no TypeScript errors)
  </verify>
  <done>
    - sendPropertyEmail Cloud Function created with proper auth, validation, Resend integration
    - Email record stored in Firestore subcollection for tracking
    - Function exported from index.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SendEmailButton and integrate into CustomerDetail</name>
  <files>
    src/components/customer/SendEmailButton.tsx
    src/pages/CustomerDetail.tsx
  </files>
  <action>
1. Create src/components/customer/SendEmailButton.tsx:
   - Props: customerId (string), customerEmail (string | undefined), propertyId (string)
   - State: sending (boolean), showPropertyPicker (boolean)
   - Import httpsCallable from 'firebase/functions', functions from '@/lib/firebase'
   - Import Button, toast (sonner), Mail, Loader2, AlertCircle icons

2. Implement SendEmailButton:
   - If no customerEmail, show disabled button with "E-posta adresi yok" tooltip
   - On click: setSending(true), call httpsCallable(functions, 'sendPropertyEmail')
   - Pass { customerId, propertyId }
   - On success: toast.success('E-posta gonderildi')
   - On error: toast.error('E-posta gonderilemedi')
   - Finally: setSending(false)

3. Button UI:
   - variant="outline", className="gap-2"
   - Show Loader2 with animate-spin when sending
   - Show Mail icon when not sending
   - Text: "E-posta Gonder"

4. Update src/pages/CustomerDetail.tsx:
   - Import SendEmailButton from '@/components/customer/SendEmailButton'
   - Add state: selectedPropertyId (string | null)
   - In the header buttons section (near Edit/Delete), add SendEmailButton
   - For MVP: Use a simple property picker dropdown or just add the button that opens a modal

   For simplicity in this task, add a "E-posta Gonder" button that:
   - Opens a simple modal/dropdown to select a property
   - Uses useProperties hook to list available properties
   - Passes selected property ID to SendEmailButton

5. Alternative simpler approach (implement this):
   - Create SendEmailModal component inside CustomerDetail
   - Modal shows property list with radio selection
   - Send button calls the Cloud Function
   - This keeps the SendEmailButton simpler
  </action>
  <verify>
    - npm run build (no errors)
    - Check src/components/customer/SendEmailButton.tsx exists
    - Check CustomerDetail.tsx imports and uses SendEmailButton or email modal
  </verify>
  <done>
    - SendEmailButton component created with loading state, error handling
    - CustomerDetail page has email sending capability with property selection
    - User can send property details to customer via email
  </done>
</task>

</tasks>

<verification>
1. Run `cd functions && npm run build` - should complete without errors
2. Run `npm run build` - should complete without errors
3. Verify all new files exist:
   - functions/src/email/templates/PropertyEmail.tsx
   - functions/src/email/sendPropertyEmail.ts
   - src/components/customer/SendEmailButton.tsx
4. Check functions/src/index.ts includes sendPropertyEmail export
</verification>

<success_criteria>
- Resend and React Email packages installed in functions/
- PropertyEmail React Email template renders Turkish property card
- sendPropertyEmail Cloud Function handles auth, validation, sending, and storage
- SendEmailButton component allows sending from CustomerDetail page
- User can select a property and send its details to a customer via email
- Email record is stored in Firestore for later tracking
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-advanced-features/07-01-SUMMARY.md`
</output>
