---
phase: 07-email-advanced-features
plan: 02
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - functions/src/http/resendWebhook.ts
  - functions/src/index.ts
  - src/types/email.ts
  - src/hooks/useEmailTracking.ts
  - src/components/customer/EmailHistoryModal.tsx
  - src/pages/CustomerDetail.tsx
autonomous: true
requirements:
  - ILET-07
user_setup:
  - service: resend
    why: "Webhook for email tracking events"
    env_vars:
      - name: RESEND_WEBHOOK_SECRET
        source: "Resend Dashboard -> Webhooks -> Add Webhook -> Signing Secret"
    dashboard_config:
      - task: "Create webhook endpoint pointing to Cloud Function URL"
        location: "Resend Dashboard -> Webhooks -> Add Webhook"
        notes: "URL: https://europe-west1-{project-id}.cloudfunctions.net/resendWebhook"

must_haves:
  truths:
    - "Webhook receives email delivery events from Resend"
    - "Email status updates from sent to delivered to opened"
    - "User can see email history with status badges on customer detail page"
  artifacts:
    - path: "functions/src/http/resendWebhook.ts"
      provides: "Webhook endpoint for Resend delivery events"
      exports: ["resendWebhook"]
    - path: "src/hooks/useEmailTracking.ts"
      provides: "Real-time email status hook"
      exports: ["useEmailTracking"]
    - path: "src/components/customer/EmailHistoryModal.tsx"
      provides: "Email history display component"
      contains: "EmailHistoryModal"
  key_links:
    - from: "functions/src/http/resendWebhook.ts"
      to: "Firestore emails subcollection"
      via: "collectionGroup query"
      pattern: "collectionGroup.*emails"
    - from: "src/hooks/useEmailTracking.ts"
      to: "customers/{customerId}/emails"
      via: "onSnapshot listener"
      pattern: "onSnapshot"
---

<objective>
Implement email tracking via Resend webhooks and display email delivery status (sent/delivered/opened) on the customer detail page.

Purpose: Enable users to track email delivery status, satisfying ILET-07 requirement
Output: Webhook endpoint for Resend events, useEmailTracking hook, EmailHistoryModal component
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-advanced-features/07-RESEARCH.md
@.planning/phases/07-email-advanced-features/07-01-SUMMARY.md

# Existing code patterns
@functions/src/config.ts
@functions/src/index.ts
@src/pages/CustomerDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Resend webhook endpoint with signature verification</name>
  <files>
    functions/src/http/resendWebhook.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/http/resendWebhook.ts:
   - Import onRequest from 'firebase-functions/v2/https'
   - Import db, REGION from '../config'
   - Import createHmac from 'crypto'

2. Implement resendWebhook onRequest handler:
   - Options: { region: REGION, cors: false }
   - Only accept POST requests (return 405 for others)
   - Get svix-signature header and RESEND_WEBHOOK_SECRET from process.env
   - If either missing, return 401 Unauthorized

3. Verify webhook signature:
   - Get raw body: JSON.stringify(req.body)
   - Create HMAC: createHmac('sha256', webhookSecret)
   - Compute expected: hmac.update(rawBody).digest('hex')
   - Parse signature header for v1= prefix
   - Compare signatures (if mismatch, log warning and return 401)

4. Process webhook event:
   - Extract type and data from req.body
   - Get emailId from data.email_id
   - Query Firestore using collectionGroup('emails').where('emailId', '==', emailId).limit(1)
   - If not found, log warning and return 404

5. Update email status based on event type:
   - 'email.sent' -> status: 'sent' (already set on send)
   - 'email.delivered' -> status: 'delivered'
   - 'email.opened' -> status: 'opened'
   - 'email.bounced' -> status: 'bounced'
   - 'email.failed' -> status: 'failed'
   - 'email.clicked' -> just add to events, don't change status

6. Update Firestore document:
   - Update status field
   - Append event to events array: { type, timestamp: new Date(data.created_at), data }
   - Set lastUpdated: new Date()
   - Log success and return 200 OK

7. Wrap in try/catch:
   - Log errors with console.error
   - Return 500 Internal Server Error on exception

8. Update functions/src/index.ts:
   - Add export: export { resendWebhook } from './http/resendWebhook';
  </action>
  <verify>
    - Check functions/src/http/resendWebhook.ts exports resendWebhook
    - Check functions/src/index.ts includes resendWebhook export
    - cd functions && npx tsc --noEmit (no TypeScript errors)
  </verify>
  <done>
    - Webhook endpoint created with HMAC signature verification
    - Email status updates stored in Firestore
    - Event timeline appended for full tracking history
  </done>
</task>

<task type="auto">
  <name>Task 2: Create email types, useEmailTracking hook, and EmailHistoryModal</name>
  <files>
    src/types/email.ts
    src/hooks/useEmailTracking.ts
    src/components/customer/EmailHistoryModal.tsx
  </files>
  <action>
1. Create src/types/email.ts:
   ```typescript
   export interface EmailEvent {
     type: string;
     timestamp: Date | { toDate: () => Date };
     data: Record<string, any>;
   }

   export type EmailStatus = 'sent' | 'delivered' | 'opened' | 'bounced' | 'failed';

   export interface EmailRecord {
     id: string;
     emailId: string;           // Resend email ID
     propertyId: string;
     subject: string;
     status: EmailStatus;
     sentAt: Date | { toDate: () => Date };
     events: EmailEvent[];
     lastUpdated?: Date | { toDate: () => Date };
   }
   ```

2. Create src/hooks/useEmailTracking.ts:
   - Import useState, useEffect from 'react'
   - Import collection, query, orderBy, onSnapshot from 'firebase/firestore'
   - Import db from '@/lib/firebase'
   - Import useAuth from '@/context/AuthContext'
   - Import EmailRecord type

3. Implement useEmailTracking hook:
   - Accept customerId parameter
   - State: emails (EmailRecord[]), loading (boolean)
   - Get user from useAuth()
   - useEffect with onSnapshot listener:
     - Path: users/{userId}/customers/{customerId}/emails
     - Order by sentAt desc
     - Map documents to EmailRecord objects
     - Convert Firestore Timestamps to Date objects
   - Return { emails, loading }

4. Create src/components/customer/EmailHistoryModal.tsx:
   - Import useEmailTracking hook
   - Import Badge, Dialog/Modal components
   - Import format from 'date-fns', tr from 'date-fns/locale'
   - Import icons: Mail, CheckCircle, Eye, XCircle, Clock

5. Define status configuration:
   ```typescript
   const statusConfig = {
     sent: { label: 'Gonderildi', icon: Mail, color: 'bg-blue-100 text-blue-800' },
     delivered: { label: 'Teslim Edildi', icon: CheckCircle, color: 'bg-green-100 text-green-800' },
     opened: { label: 'Acildi', icon: Eye, color: 'bg-purple-100 text-purple-800' },
     bounced: { label: 'Geri Dondu', icon: XCircle, color: 'bg-red-100 text-red-800' },
     failed: { label: 'Basarisiz', icon: XCircle, color: 'bg-red-100 text-red-800' }
   };
   ```

6. Implement EmailHistoryModal component:
   - Props: customerId (string), open (boolean), onClose (() => void)
   - Use useEmailTracking(customerId)
   - Loading state: show spinner
   - Empty state: "Henuz e-posta gonderilmemis"
   - Email list: For each email show:
     - Subject line
     - Date formatted in Turkish: format(sentAt, 'd MMMM yyyy, HH:mm', { locale: tr })
     - Status badge with icon and color from statusConfig
     - Event timeline (optional, show on expand)
  </action>
  <verify>
    - Check src/types/email.ts exports EmailRecord, EmailStatus, EmailEvent
    - Check src/hooks/useEmailTracking.ts exports useEmailTracking
    - Check src/components/customer/EmailHistoryModal.tsx exports EmailHistoryModal
    - npm run build (no errors)
  </verify>
  <done>
    - Email types defined for type safety
    - useEmailTracking hook provides real-time email status
    - EmailHistoryModal displays email history with status badges
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate EmailHistoryModal into CustomerDetail page</name>
  <files>
    src/pages/CustomerDetail.tsx
  </files>
  <action>
1. Import EmailHistoryModal:
   - import EmailHistoryModal from '@/components/customer/EmailHistoryModal'

2. Add state for email history modal:
   - const [showEmailHistory, setShowEmailHistory] = useState(false)

3. Add "E-posta Gecmisi" button to header actions or contact section:
   - Near the existing "E-posta Gonder" button (added in 07-01)
   - Button with History or Clock icon
   - Text: "E-posta Gecmisi"
   - onClick: () => setShowEmailHistory(true)

4. Add EmailHistoryModal to component:
   - <EmailHistoryModal
       customerId={id!}
       open={showEmailHistory}
       onClose={() => setShowEmailHistory(false)}
     />

5. Consider UX improvements:
   - Group email actions together (Send + History)
   - Show badge with email count if available
   - Use consistent styling with other action buttons
  </action>
  <verify>
    - npm run build (no errors)
    - Check CustomerDetail.tsx imports EmailHistoryModal
    - Check CustomerDetail.tsx renders EmailHistoryModal
  </verify>
  <done>
    - EmailHistoryModal integrated into CustomerDetail page
    - User can view email history with delivery status
    - Status badges show sent/delivered/opened states
  </done>
</task>

</tasks>

<verification>
1. Run `cd functions && npm run build` - should complete without errors
2. Run `npm run build` - should complete without errors
3. Verify all new files exist:
   - functions/src/http/resendWebhook.ts
   - src/types/email.ts
   - src/hooks/useEmailTracking.ts
   - src/components/customer/EmailHistoryModal.tsx
4. Check functions/src/index.ts includes resendWebhook export
5. Check CustomerDetail.tsx includes email history functionality
</verification>

<success_criteria>
- Webhook endpoint receives and verifies Resend delivery events
- Email status in Firestore updates as events are received
- useEmailTracking hook provides real-time status updates
- EmailHistoryModal shows email list with status badges
- User can see whether emails were delivered and opened
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-advanced-features/07-02-SUMMARY.md`
</output>
