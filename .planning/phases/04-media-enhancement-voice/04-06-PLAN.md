---
phase: 04-media-enhancement-voice
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/imageHelpers.ts
  - src/pages/PropertyDetail.tsx
  - src/components/photos/PhotoGrid.tsx
  - src/components/photos/PhotoEnhanceButton.tsx
autonomous: true
gap_closure: true
requirements:
  - MULK-07
  - MULK-08

must_haves:
  truths:
    - "Fotoğraf kırpma işlemi başarıyla tamamlanır ve fotoğraf güncellenir"
    - "Sparkles ikonu fotoğraf hover'ında görünür ve tıklanabilir"
    - "Fotoğraf grid'inde 5 buton da görünür (Star, Pencil, Wand2, Sparkles, Trash)"
  artifacts:
    - path: "src/utils/imageHelpers.ts"
      provides: "CORS-safe crop extraction using fetch+createObjectURL"
      contains: "fetch("
    - path: "src/pages/PropertyDetail.tsx"
      provides: "Correct storage path matching upload path"
      contains: "properties/${propertyId}/"
    - path: "src/components/photos/PhotoGrid.tsx"
      provides: "flex-wrap layout preventing button overflow"
      contains: "flex-wrap"
    - path: "src/components/photos/PhotoEnhanceButton.tsx"
      provides: "Normalized button size matching other buttons"
      contains: "h-4 w-4 sm:h-5 sm:w-5"
  key_links:
    - from: "src/utils/imageHelpers.ts"
      to: "canvas.toBlob()"
      via: "fetch URL -> objectURL -> drawImage -> toBlob"
      pattern: "fetch\\(imageSrc\\)"
    - from: "src/pages/PropertyDetail.tsx"
      to: "Firebase Storage"
      via: "storageRef with properties/{id} path"
      pattern: "properties/\\$\\{id\\}"
---

<objective>
Fix photo crop save failure (canvas taint from CORS) and sparkles button overflow clipping.

Purpose: Two separate layout/data bugs prevent core photo editing features from working at all. Users get errors on crop save, and can only see 3 of 5 action buttons.

Output: getCroppedImg uses fetch to bypass CORS taint; storage path matches upload path; PhotoGrid uses flex-wrap so all 5 buttons appear; PhotoEnhanceButton uses consistent button sizing.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/utils/imageHelpers.ts
@src/pages/PropertyDetail.tsx
@src/components/photos/PhotoGrid.tsx
@src/components/photos/PhotoEnhanceButton.tsx
@src/hooks/usePhotoUpload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix photo crop CORS taint and storage path mismatch</name>
  <files>src/utils/imageHelpers.ts, src/pages/PropertyDetail.tsx</files>
  <action>
    In `src/utils/imageHelpers.ts`:
    - Replace `createImage(url)` with a new approach that uses `fetch(imageSrc)` then `createObjectURL(blob)` to bypass Firebase Storage CORS restrictions. The current `crossOrigin='anonymous'` attribute causes canvas taint because Firebase Storage does not serve CORS headers for this auth pattern — canvas.toBlob() silently returns null.
    - New flow in `getCroppedImg`: `const response = await fetch(imageSrc); const blob = await response.blob(); const objectUrl = URL.createObjectURL(blob);` — then call `createImage(objectUrl)` with the object URL. After canvas operations complete (inside the toBlob callback), call `URL.revokeObjectURL(objectUrl)` to avoid memory leaks.
    - Keep `createImage` helper but remove the `crossOrigin='anonymous'` attribute since object URLs are same-origin and don't need it.
    - Keep all existing rotation and crop math unchanged — only the URL loading mechanism changes.

    In `src/pages/PropertyDetail.tsx` around line 241:
    - Change `handleSaveCroppedPhoto`: the storageRef path is currently `users/${user.uid}/properties/${id}/photos/${editingPhoto.id}.jpg`. This does NOT match the upload path used in `usePhotoUpload.ts` which is `properties/${propertyId}/${upload.id}-${upload.file.name}`.
    - Change the storage path to `properties/${id}/${editingPhoto.id}.jpg` — this matches the root-level `properties/` path used on upload. Note: do NOT include `users/${user.uid}/` prefix — the upload hook uses `properties/` at root level.
    - Keep the rest of handleSaveCroppedPhoto (getDownloadURL, cache-buster, Firestore update) unchanged.
  </action>
  <verify>Open property detail with photos, hover a photo, click pencil icon, crop the photo, click Kaydet. Should succeed without "fotoğraf kırpılırken bir hata oluştu" message.</verify>
  <done>Crop save completes successfully, photo updates in the grid with new cropped version.</done>
</task>

<task type="auto">
  <name>Task 2: Fix sparkles button overflow — flex-wrap and normalized button sizes</name>
  <files>src/components/photos/PhotoGrid.tsx, src/components/photos/PhotoEnhanceButton.tsx</files>
  <action>
    In `src/components/photos/PhotoGrid.tsx` around line 144:
    - The action buttons container currently uses `flex items-center justify-center gap-2`. With 5 buttons (Star, Pencil, Wand2, Sparkles, Trash) in a narrow card (lg:grid-cols-4), buttons 4 and 5 overflow and get clipped by `overflow-hidden` on the card wrapper.
    - Add `flex-wrap` to the container div: change the class to include `flex flex-wrap items-center justify-center gap-1 p-2`. Also reduce gap from `gap-2` to `gap-1` to help fit buttons in tight spaces.
    - DO NOT remove `overflow-hidden` from the card div — it's needed for the rounded-lg aesthetic. Instead let the buttons wrap to a second row on small cards.

    In `src/components/photos/PhotoEnhanceButton.tsx` around line 79:
    - The Sparkles icon and Loader2 currently use `h-5 w-5` fixed size while all other buttons in PhotoGrid use `h-4 w-4 sm:h-5 sm:w-5` responsive sizing.
    - Change both icon size classes from `h-5 w-5` to `h-4 w-4 sm:h-5 sm:w-5` to match the Star, Pencil, Wand2, and Trash icons.
    - Keep all other PhotoEnhanceButton logic and styling unchanged.
  </action>
  <verify>Open property edit page with photos. Hover a photo card. Count visible action buttons in the overlay — should see all 5: Star, Pencil, Wand2 (gradient), Sparkles, Trash. On mobile (or narrow viewport) buttons should wrap to two rows rather than disappearing.</verify>
  <done>All 5 action buttons visible on hover; Sparkles button clickable and triggers one-click enhancement; no buttons clipped by overflow.</done>
</task>

</tasks>

<verification>
1. Navigate to a property detail page with uploaded photos
2. Hover over a photo card — verify 5 buttons visible (star, pencil, purple wand, sparkles, trash)
3. Click pencil icon to open crop editor — use crop/zoom/rotate controls
4. Click Kaydet — verify photo updates without error toast
5. Click sparkles icon on a photo — verify enhancement starts (spinner) and completes
</verification>

<success_criteria>
Photo crop save succeeds with no error. All 5 action buttons visible on photo hover. Sparkles one-click enhancement initiates when clicked.
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-06-SUMMARY.md`
</output>
