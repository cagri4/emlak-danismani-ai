---
phase: 04-media-enhancement-voice
plan: 03
type: execute
wave: 2
depends_on:
  - "04-02"
files_modified:
  - functions/src/jobs/photoEnhancement.ts
  - functions/src/services/cloudinaryService.ts
  - functions/package.json
  - src/services/photoEnhancement.ts
  - src/components/photos/AdvancedPhotoEditor.tsx
  - src/components/photos/PhotoEditor.tsx
autonomous: true
requirements:
  - MULK-09
  - MULK-10
user_setup:
  - service: cloudinary
    why: "AI-powered sky replacement and image transformations"
    env_vars:
      - name: CLOUDINARY_CLOUD_NAME
        source: "Cloudinary Dashboard -> Settings -> Account details"
      - name: CLOUDINARY_API_KEY
        source: "Cloudinary Dashboard -> Settings -> Access Keys"
      - name: CLOUDINARY_API_SECRET
        source: "Cloudinary Dashboard -> Settings -> Access Keys"

must_haves:
  truths:
    - "User can select 'Gokyuzu degistir' option for outdoor property photos"
    - "AI replaces cloudy/gray sky with blue sky"
    - "User can select 'Perspektif duzelt' option for interior photos"
    - "AI corrects tilted lines and perspective distortion"
    - "User sees before/after comparison"
    - "Processing shows clear loading state with estimated time"
  artifacts:
    - path: "functions/src/services/cloudinaryService.ts"
      provides: "Cloudinary AI integration for sky replacement and perspective"
      exports: ["replaceSky", "correctPerspective", "initCloudinary"]
    - path: "src/components/photos/AdvancedPhotoEditor.tsx"
      provides: "UI for sky replacement and perspective correction"
      min_lines: 100
  key_links:
    - from: "functions/src/jobs/photoEnhancement.ts"
      to: "functions/src/services/cloudinaryService.ts"
      via: "calls Cloudinary for advanced features"
      pattern: "replaceSky|correctPerspective"
    - from: "src/components/photos/AdvancedPhotoEditor.tsx"
      to: "src/services/photoEnhancement.ts"
      via: "calls enhancement service with advanced options"
      pattern: "enhancePhoto.*skyReplace|perspective"
---

<objective>
Implement AI-powered sky replacement and perspective correction using Cloudinary AI services.

Purpose: Outdoor property photos with gray skies look unappealing. Interior photos with perspective distortion look unprofessional. AI can fix both automatically.
Output: Cloudinary integration in Cloud Functions, advanced photo editor UI with sky and perspective options.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-media-enhancement-voice/04-RESEARCH.md

# Enhancement infrastructure from Plan 02
@functions/src/jobs/photoEnhancement.ts
@src/services/photoEnhancement.ts

# Photo editor from Plan 01
@src/components/photos/PhotoEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Cloudinary service in Cloud Functions</name>
  <files>
    functions/package.json
    functions/src/services/cloudinaryService.ts
  </files>
  <action>
1. Install Cloudinary SDK:
   ```bash
   cd functions && npm install cloudinary
   ```

2. Create functions/src/services/cloudinaryService.ts:

```typescript
import { v2 as cloudinary, UploadApiResponse } from 'cloudinary';

export function initCloudinary(): void {
  cloudinary.config({
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,
    secure: true,
  });
}

interface CloudinaryResult {
  success: boolean;
  url?: string;
  error?: string;
}
```

3. Implement sky replacement:
```typescript
export async function replaceSky(imageUrl: string): Promise<CloudinaryResult> {
  try {
    // Upload to Cloudinary with generative replace transformation
    const result = await cloudinary.uploader.upload(imageUrl, {
      transformation: [
        {
          effect: 'gen_background_replace',
          prompt: 'blue sky with white clouds, sunny day',
        },
      ],
      resource_type: 'image',
    });

    return { success: true, url: result.secure_url };
  } catch (error) {
    return { success: false, error: (error as Error).message };
  }
}
```

4. Implement perspective correction:
```typescript
export async function correctPerspective(imageUrl: string): Promise<CloudinaryResult> {
  try {
    // Cloudinary's perspective correction via AI
    const result = await cloudinary.uploader.upload(imageUrl, {
      transformation: [
        { effect: 'improve' },
        { effect: 'auto_orientation' },
        // Use Cloudinary's generative AI for perspective
        { effect: 'gen_restore' },
      ],
      resource_type: 'image',
    });

    return { success: true, url: result.secure_url };
  } catch (error) {
    return { success: false, error: (error as Error).message };
  }
}
```

5. Add fallback for when Cloudinary is not configured:
```typescript
export function isCloudinaryConfigured(): boolean {
  return !!(
    process.env.CLOUDINARY_CLOUD_NAME &&
    process.env.CLOUDINARY_API_KEY &&
    process.env.CLOUDINARY_API_SECRET
  );
}
```
  </action>
  <verify>
    - `cd functions && npm run build` passes
    - cloudinary in functions/package.json dependencies
    - cloudinaryService.ts exports replaceSky, correctPerspective, initCloudinary, isCloudinaryConfigured
  </verify>
  <done>
    Cloudinary service ready with sky replacement and perspective correction functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend photo enhancement Cloud Function</name>
  <files>
    functions/src/jobs/photoEnhancement.ts
  </files>
  <action>
1. Update EnhanceRequest interface:
```typescript
interface EnhanceRequest {
  photoUrl: string;
  propertyId: string;
  photoIndex: number;
  userId: string;
  options?: {
    brightness?: number;
    saturation?: number;
    sharpen?: boolean;
    clahe?: boolean;
    // New advanced options
    skyReplace?: boolean;    // Requires Cloudinary
    perspectiveCorrect?: boolean;  // Requires Cloudinary
  };
}
```

2. Add Cloudinary processing to enhancement pipeline:
```typescript
import { initCloudinary, replaceSky, correctPerspective, isCloudinaryConfigured } from '../services/cloudinaryService';

// In the function handler:
if (options?.skyReplace || options?.perspectiveCorrect) {
  if (!isCloudinaryConfigured()) {
    throw new functions.https.HttpsError(
      'failed-precondition',
      'Cloudinary not configured. Contact admin to enable advanced features.'
    );
  }

  initCloudinary();

  let processedUrl = imageUrl;

  if (options.skyReplace) {
    const skyResult = await replaceSky(processedUrl);
    if (!skyResult.success) {
      throw new functions.https.HttpsError('internal', skyResult.error || 'Sky replacement failed');
    }
    processedUrl = skyResult.url!;
  }

  if (options.perspectiveCorrect) {
    const perspectiveResult = await correctPerspective(processedUrl);
    if (!perspectiveResult.success) {
      throw new functions.https.HttpsError('internal', perspectiveResult.error || 'Perspective correction failed');
    }
    processedUrl = perspectiveResult.url!;
  }

  // Download from Cloudinary and upload to Firebase Storage
  // (to keep files in our storage, not Cloudinary)
}
```

3. Add new response fields:
```typescript
interface EnhanceResponse {
  success: boolean;
  enhancedUrl?: string;
  error?: string;
  processingTime?: number;
  cloudinaryUsed?: boolean;
}
```
  </action>
  <verify>
    - `cd functions && npm run build` passes
    - Enhancement function handles skyReplace option
    - Enhancement function handles perspectiveCorrect option
    - Graceful error when Cloudinary not configured
  </verify>
  <done>
    Photo enhancement Cloud Function extended with Cloudinary integration for advanced features.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AdvancedPhotoEditor UI</name>
  <files>
    src/services/photoEnhancement.ts
    src/components/photos/AdvancedPhotoEditor.tsx
    src/components/photos/PhotoEditor.tsx
  </files>
  <action>
1. Update src/services/photoEnhancement.ts:
   - Add skyReplace and perspectiveCorrect to EnhancePhotoParams interface
   - Add new preset:
   ```typescript
   export const ENHANCEMENT_PRESETS = {
     // ... existing presets
     sky_replace: { skyReplace: true },
     perspective: { perspectiveCorrect: true },
     full_ai: { brightness: 1.1, saturation: 1.1, sharpen: true, skyReplace: true, perspectiveCorrect: true },
   } as const;
   ```

2. Create AdvancedPhotoEditor.tsx:
```typescript
interface AdvancedPhotoEditorProps {
  isOpen: boolean;
  onClose: () => void;
  imageUrl: string;
  propertyId: string;
  photoIndex: number;
  onSave: (newUrl: string) => Promise<void>;
}
```

Features:
- Tab interface: "Kirpma" (Crop), "Iyilestirme" (Enhance), "Gelismis" (Advanced)
- Enhance tab: brightness/contrast sliders, auto-enhance button
- Advanced tab:
  - "Gokyuzu Degistir" button with cloud-to-sun icon
  - "Perspektif Duzelt" button with align icon
  - Warning text: "Bu islem 10-30 saniye surebilir" (Processing may take 10-30 seconds)
  - Before/after toggle to compare original
- Loading overlay with spinner and Turkish message: "Islem yapiliyor..."
- Progress indicator for long operations

3. Update PhotoEditor.tsx:
- Add "Gelismis" (Advanced) button to open AdvancedPhotoEditor
- Or: integrate AdvancedPhotoEditor tabs directly into PhotoEditor

4. Tailwind styling:
- Consistent with existing UI
- Mobile-friendly button sizes
- Dark overlay for modals
  </action>
  <verify>
    - `npm run build` passes
    - AdvancedPhotoEditor renders with all tabs
    - Sky replace and perspective buttons visible
    - Loading state displays during processing
  </verify>
  <done>
    Advanced photo editor UI with sky replacement and perspective correction options ready.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` and `cd functions && npm run build`
2. Set Cloudinary env vars in Firebase Functions config
3. Deploy: `firebase deploy --only functions`
4. Open photo editor, navigate to Advanced tab
5. Click "Gokyuzu Degistir" on outdoor photo with gray sky
6. Verify sky is replaced with blue sky
7. Click "Perspektif Duzelt" on interior photo with tilted walls
8. Verify perspective is corrected
</verification>

<success_criteria>
- Cloudinary integration works in Cloud Functions
- Sky replacement transforms cloudy sky to blue sky
- Perspective correction straightens tilted lines
- UI shows clear loading state during processing
- Errors display helpful Turkish messages
- Falls back gracefully when Cloudinary not configured
- Processed images saved to Firebase Storage (not Cloudinary)
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-03-SUMMARY.md`
</output>
