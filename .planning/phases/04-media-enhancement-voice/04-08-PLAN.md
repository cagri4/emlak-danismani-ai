---
phase: 04-media-enhancement-voice
plan: "08"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useVoiceCommand.ts
  - src/components/voice/VoiceCommandInput.tsx
autonomous: true
gap_closure: true
requirements:
  - AIUI-09
  - AIUI-10

must_haves:
  truths:
    - "Mikrofon butonuna basılı tutunca kayıt başlar (Chrome, Safari, Firefox)"
    - "Kayıt başlayınca nabız efekti ve zamanlayıcı görünür"
    - "Mikrofon izni reddedilince anlaşılır Türkçe hata mesajı görünür"
    - "Hata mesajı ekran içinde görünür (button en altta olsa bile)"
  artifacts:
    - path: "src/hooks/useVoiceCommand.ts"
      provides: "MIME type fallback chain via MediaRecorder.isTypeSupported()"
      contains: "isTypeSupported"
    - path: "src/components/voice/VoiceCommandInput.tsx"
      provides: "Tooltip positioned bottom-full (above button) not top-full"
      contains: "bottom-full"
  key_links:
    - from: "startRecording"
      to: "MediaRecorder constructor"
      via: "isTypeSupported() fallback chain"
      pattern: "MediaRecorder\\.isTypeSupported"
    - from: "error state"
      to: "error tooltip"
      via: "bottom-full positioning"
      pattern: "bottom-full"
---

<objective>
Fix voice command button doing nothing on Safari and non-Chrome browsers, improve error classification, and fix off-screen error tooltip.

Purpose: Hardcoded `audio/webm;codecs=opus` MIME type throws in Safari/some Firefox because they don't support it, crashing the entire startRecording function before MediaRecorder is created. The catch block then shows "Mikrofon izni reddedildi" for ALL errors, including the MIME type crash. And the error tooltip is positioned below the button but the button lives at the bottom of the viewport, so the tooltip renders off-screen.

Output: Runtime MIME type detection using MediaRecorder.isTypeSupported() with fallback chain; error type discrimination; tooltip repositioned above button.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/hooks/useVoiceCommand.ts
@src/components/voice/VoiceCommandInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix MIME type detection and error classification in useVoiceCommand</name>
  <files>src/hooks/useVoiceCommand.ts</files>
  <action>
    Current line 43-44: `new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' })` — this throws `NotSupportedError` on Safari (which only supports audio/mp4) and some Firefox versions. The crash propagates to the catch block which shows "Mikrofon izni reddedildi" for all errors.

    Fix 1 — Runtime MIME type detection with fallback chain:
    Before the `new MediaRecorder(...)` call, detect the best supported MIME type:
    ```typescript
    const MIME_TYPES = [
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/ogg;codecs=opus',
      'audio/ogg',
      'audio/mp4',
      '',  // empty string = browser default
    ];

    const mimeType = MIME_TYPES.find(type =>
      type === '' || MediaRecorder.isTypeSupported(type)
    ) ?? '';

    const mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
    ```

    Also update the blob creation in `stopRecording` (around line 94): change `new Blob(chunksRef.current, { type: 'audio/webm' })` to use the detected mimeType. Store `mimeType` in a ref so stopRecording can access it:
    ```typescript
    const mimeTypeRef = useRef<string>('');
    ```
    Set `mimeTypeRef.current = mimeType;` after detection, then use `new Blob(chunksRef.current, { type: mimeTypeRef.current || 'audio/webm' })`.

    Fix 2 — Distinguish error types in catch block (lines 68-70):
    Replace the generic `setError('Mikrofon izni reddedildi')` with error type discrimination:
    ```typescript
    } catch (err: any) {
      if (err?.name === 'NotAllowedError' || err?.name === 'PermissionDeniedError') {
        setError('Mikrofon izni reddedildi. Tarayıcı ayarlarından izin verin.');
      } else if (err?.name === 'NotFoundError') {
        setError('Mikrofon bulunamadı. Cihazınızda mikrofon var mı kontrol edin.');
      } else if (err?.name === 'NotSupportedError') {
        setError('Tarayıcınız ses kaydını desteklemiyor.');
      } else {
        setError('Ses kaydı başlatılamadı. Tekrar deneyin.');
      }
    }
    ```

    Add `mimeTypeRef` to the existing refs block near `mediaRecorderRef`, `chunksRef`, `timerRef`, `streamRef`.
  </action>
  <verify>Test on Chrome: hold microphone button, verify recording starts (timer appears). Test error case: deny microphone permission and retry — error message should say "Mikrofon izni reddedildi. Tarayıcı ayarlarından izin verin." not a generic message. TypeScript compilation should pass with no new errors.</verify>
  <done>Voice recording starts on Chrome. Error messages are specific to the failure type (permission denied vs not found vs not supported).</done>
</task>

<task type="auto">
  <name>Task 2: Fix error tooltip position — render above button not below</name>
  <files>src/components/voice/VoiceCommandInput.tsx</files>
  <action>
    Current error tooltip at lines 121-126:
    ```tsx
    <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 text-xs text-red-500 whitespace-nowrap bg-white px-2 py-1 rounded shadow-sm border border-red-200">
    ```

    `top-full` positions the tooltip below the button. The microphone button lives in the chat input bar at the bottom of the viewport, so `top-full` pushes the tooltip below the visible area — it renders off-screen.

    Fix: Change `top-full mt-2` to `bottom-full mb-2` so the tooltip renders ABOVE the button:
    ```tsx
    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 text-xs text-red-500 whitespace-nowrap bg-white px-2 py-1 rounded shadow-sm border border-red-200">
    ```

    Also the timer overlay at lines 74-77 uses `absolute -top-8`. Since the timer is a sibling element inside the same relative container, verify it still renders correctly above the button after the change. The timer is not affected by the tooltip change (they are separate elements), but double-check that `-top-8` still correctly positions it above the button — it should, since that's already relative to the container top.

    No other changes to VoiceCommandInput.tsx needed.
  </action>
  <verify>Deny microphone permission, then tap the microphone button. Verify the error tooltip appears ABOVE the button (not below it, not off-screen). The tooltip should be visible within the viewport even when the chat input is at the very bottom of the screen.</verify>
  <done>Error tooltip appears above the microphone button, fully visible on screen, regardless of button position in viewport.</done>
</task>

</tasks>

<verification>
1. Open chat interface, find microphone button in input bar
2. Press and hold microphone button on Chrome — recording starts (timer shows, pulsing ring appears)
3. Release — transcription begins, result appears in input field
4. Test error: deny mic permission in browser settings, tap mic button — error tooltip appears ABOVE the button in clear view with specific message
5. TypeScript: `npm run build` or `tsc --noEmit` passes without errors
</verification>

<success_criteria>
Voice recording starts on press-and-hold in Chrome. MIME type detected at runtime (no hardcoded crash). Error messages specific to failure type. Error tooltip visible above button, not clipped off-screen.
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-08-SUMMARY.md`
</output>
