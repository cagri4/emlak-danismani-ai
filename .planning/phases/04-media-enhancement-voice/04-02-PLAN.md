---
phase: 04-media-enhancement-voice
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/jobs/photoEnhancement.ts
  - functions/src/index.ts
  - src/services/photoEnhancement.ts
  - src/components/photos/PhotoEnhanceButton.tsx
  - src/components/photos/PhotoGrid.tsx
autonomous: true
requirements:
  - MULK-08

must_haves:
  truths:
    - "User can click enhance button on a property photo"
    - "Photo is sent to Cloud Function for processing"
    - "AI applies brightness, contrast, and saturation improvements"
    - "Enhanced photo replaces or appears alongside original"
    - "User sees loading state while enhancement processes"
    - "Enhancement works on dark/underexposed property photos"
  artifacts:
    - path: "functions/src/jobs/photoEnhancement.ts"
      provides: "Sharp-based photo enhancement Cloud Function"
      min_lines: 80
    - path: "src/services/photoEnhancement.ts"
      provides: "Client service to trigger enhancement"
      exports: ["enhancePhoto", "checkEnhancementStatus"]
    - path: "src/components/photos/PhotoEnhanceButton.tsx"
      provides: "Button component with loading state"
      min_lines: 40
  key_links:
    - from: "src/components/photos/PhotoEnhanceButton.tsx"
      to: "src/services/photoEnhancement.ts"
      via: "calls enhancePhoto service on click"
      pattern: "enhancePhoto"
    - from: "src/services/photoEnhancement.ts"
      to: "functions/src/jobs/photoEnhancement.ts"
      via: "HTTP callable function invocation"
      pattern: "httpsCallable.*enhancePropertyPhoto"
    - from: "functions/src/jobs/photoEnhancement.ts"
      to: "sharp"
      via: "image processing pipeline"
      pattern: "sharp.*modulate.*normalise"
---

<objective>
Implement AI photo enhancement using Sharp in Cloud Functions to automatically improve property photo quality.

Purpose: Real estate photos often suffer from poor lighting. Auto-enhancement makes listings more attractive without manual editing.
Output: Cloud Function for enhancement, client service, enhance button integrated into PhotoGrid.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-media-enhancement-voice/04-RESEARCH.md

# Existing Cloud Functions infrastructure
@functions/src/index.ts
@functions/src/config.ts
@functions/src/jobs/imageProcessor.ts

# Existing photo components
@src/components/photos/PhotoGrid.tsx
@src/types/photo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo enhancement Cloud Function</name>
  <files>
    functions/src/jobs/photoEnhancement.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/jobs/photoEnhancement.ts:

```typescript
import * as functions from 'firebase-functions/v2/https';
import * as admin from 'firebase-admin';
import sharp from 'sharp';
import * as path from 'path';
import * as fs from 'fs';
import * as os from 'os';

interface EnhanceRequest {
  photoUrl: string;
  propertyId: string;
  photoIndex: number;
  userId: string;
  options?: {
    brightness?: number;  // 0.9-1.2, default 1.1
    saturation?: number;  // 0.9-1.2, default 1.1
    sharpen?: boolean;    // default true
    clahe?: boolean;      // adaptive histogram equalization for dark photos
  };
}
```

2. Enhancement pipeline using Sharp:
   - Download image from Storage URL to temp file
   - Apply sharp operations:
     a. `.rotate()` - EXIF auto-rotation (MUST be first)
     b. `.normalise()` - stretch luminance (auto-contrast)
     c. `.modulate({ brightness: 1.1, saturation: 1.1 })` - boost brightness/color
     d. `.sharpen({ sigma: 1.0 })` - mild sharpening
     e. For dark photos: `.clahe({ width: 8, height: 8, maxSlope: 3 })` (optional)
   - Output as JPEG quality 85, progressive: true
   - Upload enhanced version to Storage with `_enhanced` suffix
   - Return new URL

3. Function configuration:
   - Region: europe-west1 (KVKK compliance)
   - Memory: 1GiB (Sharp requirement for large images)
   - Timeout: 120 seconds
   - CPU: 2 (for faster processing)

4. Export from index.ts:
   ```typescript
   export { enhancePropertyPhoto } from './jobs/photoEnhancement';
   ```

5. Error handling:
   - Validate input (photoUrl, propertyId required)
   - Check user authentication via context.auth
   - Handle Sharp errors gracefully
   - Clean up temp files in finally block
  </action>
  <verify>
    - `cd functions && npm run build` passes
    - photoEnhancement.ts exports enhancePropertyPhoto
    - Function uses Sharp with modulate, normalise, sharpen
    - Region set to europe-west1
    - Memory set to 1GiB
  </verify>
  <done>
    Photo enhancement Cloud Function ready for deployment. Uses Sharp for brightness, contrast, saturation, and sharpening.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client enhancement service</name>
  <files>
    src/services/photoEnhancement.ts
  </files>
  <action>
1. Create src/services/photoEnhancement.ts:

```typescript
import { getFunctions, httpsCallable } from 'firebase/functions';
import { app } from '../lib/firebase';

const functions = getFunctions(app, 'europe-west1');

interface EnhancePhotoParams {
  photoUrl: string;
  propertyId: string;
  photoIndex: number;
  options?: {
    brightness?: number;
    saturation?: number;
    sharpen?: boolean;
    clahe?: boolean;
  };
}

interface EnhancePhotoResult {
  success: boolean;
  enhancedUrl?: string;
  error?: string;
}

export async function enhancePhoto(params: EnhancePhotoParams): Promise<EnhancePhotoResult> {
  const enhancePropertyPhoto = httpsCallable<EnhancePhotoParams, EnhancePhotoResult>(
    functions,
    'enhancePropertyPhoto'
  );

  const result = await enhancePropertyPhoto(params);
  return result.data;
}
```

2. Add helper for checking if photo is already enhanced:
```typescript
export function isEnhanced(photoUrl: string): boolean {
  return photoUrl.includes('_enhanced');
}
```

3. Add preset enhancement options:
```typescript
export const ENHANCEMENT_PRESETS = {
  auto: { brightness: 1.1, saturation: 1.1, sharpen: true },
  bright: { brightness: 1.2, saturation: 1.0, sharpen: true },
  vibrant: { brightness: 1.05, saturation: 1.2, sharpen: true },
  dark_room: { brightness: 1.15, saturation: 1.1, sharpen: true, clahe: true },
} as const;
```
  </action>
  <verify>
    - `npm run build` passes
    - photoEnhancement.ts exports enhancePhoto, isEnhanced, ENHANCEMENT_PRESETS
    - Function uses europe-west1 region
  </verify>
  <done>
    Client service ready to call Cloud Function for photo enhancement.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PhotoEnhanceButton and integrate with PhotoGrid</name>
  <files>
    src/components/photos/PhotoEnhanceButton.tsx
    src/components/photos/PhotoGrid.tsx
  </files>
  <action>
1. Create PhotoEnhanceButton.tsx:
```typescript
interface PhotoEnhanceButtonProps {
  photoUrl: string;
  propertyId: string;
  photoIndex: number;
  onEnhanced: (newUrl: string) => void;
  disabled?: boolean;
}
```

Features:
- Sparkles icon (or magic wand) from lucide-react
- Loading spinner during enhancement
- Disabled state if already enhanced (check URL for '_enhanced')
- Turkish tooltip: "Fotoğrafı iyileştir"
- On success: call onEnhanced with new URL
- On error: show toast with Turkish error message
- Small button size, fits in PhotoGrid overlay

2. Update PhotoGrid.tsx:
- Add optional `onPhotoEnhanced?: (index: number, newUrl: string) => void` prop
- Render PhotoEnhanceButton alongside edit button for each photo
- Pass propertyId and photoIndex to button
- When enhanced, call onPhotoEnhanced callback

3. Update PropertyEdit.tsx (or parent component):
- Handle onPhotoEnhanced callback
- Update property.photos array with enhanced URL
- Save to Firestore
- Show success toast: "Fotoğraf iyileştirildi"
  </action>
  <verify>
    - `npm run build` passes
    - PhotoGrid shows enhance button on photos
    - Button shows loading state
    - Enhanced photos show disabled state
  </verify>
  <done>
    Photo enhance button integrated into PhotoGrid. Users can enhance photos with one click.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` and `cd functions && npm run build`
2. Deploy functions: `firebase deploy --only functions`
3. Navigate to property with photos
4. Click enhance button on a dark/underexposed photo
5. Button shows loading spinner
6. After processing, photo updates with enhanced version
7. Enhanced photos show disabled enhance button
</verification>

<success_criteria>
- Cloud Function processes photos with Sharp
- Enhancement improves brightness, contrast, saturation
- Client can trigger enhancement via button
- Loading state shows during processing
- Enhanced photo URL saved to property
- Already-enhanced photos have disabled button
- Works on mobile (touch-friendly button size)
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-02-SUMMARY.md`
</output>
