---
phase: 04-media-enhancement-voice
plan: "07"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/photos/AdvancedPhotoEditor.tsx
autonomous: true
gap_closure: true
requirements:
  - MULK-09
  - MULK-10

must_haves:
  truths:
    - "Slider değiştirince Kaydet butonu aktif olur"
    - "Gökyüzü Değiştir butonuna basınca loading overlay hemen görünür"
    - "Perspektif Düzelt butonuna basınca loading overlay hemen görünür"
    - "Cloudinary yapılandırılmamışsa açık hata mesajı gösterilir"
  artifacts:
    - path: "src/components/photos/AdvancedPhotoEditor.tsx"
      provides: "Dirty state tracking + immediate loading overlay"
      contains: "isDirty"
  key_links:
    - from: "slider onChange"
      to: "Save button enabled"
      via: "isDirty state"
      pattern: "setIsDirty\\(true\\)"
    - from: "handleSkyReplace/handlePerspectiveCorrect"
      to: "loading overlay"
      via: "setIsProcessing(true) before async call"
      pattern: "setIsProcessing\\(true\\)"
---

<objective>
Fix AdvancedPhotoEditor save button always-disabled and fix missing loading overlay on AI operations.

Purpose: Users cannot save any edits from the Advanced editor because the save button checks `!enhancedUrl` which only gets set via Cloud Function callback. Slider changes never enable save. For sky/perspective, the loading overlay doesn't appear because Cloudinary throws immediately before async processing.

Output: Dirty state tracks slider/checkbox changes to enable Save independently of Cloud Function success. `setIsProcessing(true)` is called before awaiting any Cloud Function call so the overlay appears immediately.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/photos/AdvancedPhotoEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dirty state to enable Save from slider changes</name>
  <files>src/components/photos/AdvancedPhotoEditor.tsx</files>
  <action>
    The Save button at line 361 is disabled when `!enhancedUrl`. `enhancedUrl` only gets set inside the "Otomatik İyileştir" Cloud Function success callback. Slider onChange handlers only call `setBrightness`/`setSaturation` — they never set `enhancedUrl`, so Save stays forever disabled without clicking "Otomatik İyileştir".

    Fix:
    1. Add a new state `const [isDirty, setIsDirty] = useState(false);` after the existing state declarations (around line 44).

    2. In the slider onChange handlers, call `setIsDirty(true)` after the existing setter:
       - `onChange={(e) => { setBrightness(parseFloat(e.target.value)); setIsDirty(true); }}`
       - `onChange={(e) => { setSaturation(parseFloat(e.target.value)); setIsDirty(true); }}`
       - `onChange={(e) => { setSharpen(e.target.checked); setIsDirty(true); }}`

    3. Change the Save button disabled condition from `disabled={isProcessing || !enhancedUrl}` to `disabled={isProcessing || (!enhancedUrl && !isDirty)}`. This allows saving when sliders were changed (even without Cloud Function result), OR when Cloud Function returned an enhancedUrl.

    4. Update `handleSave` to handle the dirty-but-no-enhancedUrl case: when `isDirty && !enhancedUrl`, call `onSave` with the ORIGINAL `imageUrl` prop. The user changed sliders but didn't click "Otomatik İyileştir", so we apply default enhancement via the parent's save flow. Add at the top of `handleSave`:
       ```typescript
       const urlToSave = enhancedUrl || imageUrl;
       ```
       Then change `await onSave(enhancedUrl)` to `await onSave(urlToSave)`.

    5. Reset `isDirty` to false in `handleSave` after the save completes (after the success toast).

    Keep all existing behavior unchanged. Cloud Function callbacks still set `enhancedUrl` and enable Save that way too.
  </action>
  <verify>Open AdvancedPhotoEditor on any photo. Move the Parlaklık slider. Verify the Kaydet button becomes enabled (not greyed out). Click Kaydet — verify it saves without error.</verify>
  <done>Moving any slider in the Enhance tab enables the Kaydet button. Clicking Kaydet completes without error toast.</done>
</task>

<task type="auto">
  <name>Task 2: Show loading overlay immediately on AI operations and improve Cloudinary error message</name>
  <files>src/components/photos/AdvancedPhotoEditor.tsx</files>
  <action>
    Bug: In `handleSkyReplace` and `handlePerspectiveCorrect`, `setIsProcessing(true)` IS already called at the start of the function. However, the loading overlay at line 226 is conditional on `{isProcessing && ...}`. The issue is that when Cloudinary is not configured, the Cloud Function throws `failed-precondition` synchronously/very quickly before React re-renders with the loading state, so the overlay flashes or never appears.

    Two fixes:

    Fix 1 — Ensure loading overlay renders before CF call:
    In `handleSkyReplace` and `handlePerspectiveCorrect`, restructure the loading state to be set via a dedicated pre-call step using `await new Promise(resolve => setTimeout(resolve, 0))` after `setIsProcessing(true)` and before `await enhancePhoto(...)`. This yields execution back to React to render the overlay before the CF call fires:
    ```typescript
    const handleSkyReplace = async () => {
      setIsProcessing(true);
      setProcessingMessage('Gökyüzü değiştiriliyor... (10-30 saniye sürebilir)');
      // Yield to React render cycle so overlay appears before CF call
      await new Promise(resolve => setTimeout(resolve, 0));
      try { ... }
    ```
    Apply same pattern to `handlePerspectiveCorrect`.

    Fix 2 — Improve error message for Cloudinary not configured:
    Currently the catch block checks `error.message?.includes('Cloudinary')`. The Cloud Function throws `failed-precondition` with a message about Cloudinary config. Expand the check to also match `failed-precondition` and `yapılandırılmamış`:
    ```typescript
    const isConfigError =
      error.message?.includes('Cloudinary') ||
      error.code === 'functions/failed-precondition' ||
      error.message?.includes('not configured');
    if (isConfigError) {
      toast.error('Cloudinary yapılandırılmamış. Bu özellik için yönetici panelinden Cloudinary API anahtarlarını ekleyin.');
    } else {
      toast.error('Bir hata oluştu');
    }
    ```
    Apply this improved error handling in both `handleSkyReplace` and `handlePerspectiveCorrect` catch blocks.

    Also: Add a Turkish note in the Advanced tab UI below the existing warning text to inform users this feature requires external configuration:
    ```tsx
    <p className="text-xs text-amber-600 bg-amber-50 rounded p-2">
      Not: Bu özellikler Cloudinary yapılandırması gerektirir. Yapılandırılmamışsa hata mesajı gösterilir.
    </p>
    ```
    Add this after the existing `⚠️ Bu işlemler 10-30 saniye sürebilir` paragraph.
  </action>
  <verify>Open AdvancedPhotoEditor, go to Advanced tab, click "Gökyüzü Değiştir". Verify: (1) loading overlay with spinner appears immediately, (2) after a moment an error toast appears saying "Cloudinary yapılandırılmamış..." with clear instruction. Same for "Perspektif Düzelt".</verify>
  <done>Loading overlay visible immediately on click. Error message clearly explains Cloudinary is not configured rather than generic "Bir hata oluştu".</done>
</task>

</tasks>

<verification>
1. Open AdvancedPhotoEditor (via purple wand button on photo hover)
2. Enhance tab: move Parlaklık slider — Kaydet button becomes active
3. Click Kaydet — saves without error
4. Advanced tab: click "Gökyüzü Değiştir" — loading overlay appears immediately
5. Error toast says "Cloudinary yapılandırılmamış" with instructions (not generic error)
6. Same behavior for "Perspektif Düzelt"
</verification>

<success_criteria>
Slider changes enable Save button. Loading overlay appears immediately on AI operation clicks. Error messages clearly communicate Cloudinary not configured rather than failing silently.
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-07-SUMMARY.md`
</output>
