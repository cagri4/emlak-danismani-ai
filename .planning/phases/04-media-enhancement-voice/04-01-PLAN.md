---
phase: 04-media-enhancement-voice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/photos/PhotoCropper.tsx
  - src/components/photos/PhotoEditor.tsx
  - src/utils/imageHelpers.ts
  - src/pages/PropertyEdit.tsx
  - package.json
autonomous: true
requirements:
  - MULK-07

must_haves:
  truths:
    - "User can select a property photo and enter crop mode"
    - "User can drag to position crop area on the photo"
    - "User can zoom in/out using slider or pinch gestures"
    - "User can select aspect ratio (16:9, 4:3, 1:1, free)"
    - "User sees cropped preview before saving"
    - "Cropped image replaces original in property photos"
  artifacts:
    - path: "src/components/photos/PhotoCropper.tsx"
      provides: "Interactive crop UI with react-easy-crop"
      min_lines: 80
    - path: "src/utils/imageHelpers.ts"
      provides: "getCroppedImg utility for Canvas crop extraction"
      exports: ["getCroppedImg", "createImage"]
    - path: "src/components/photos/PhotoEditor.tsx"
      provides: "Modal wrapper for cropping with save/cancel"
      min_lines: 60
  key_links:
    - from: "src/components/photos/PhotoEditor.tsx"
      to: "src/components/photos/PhotoCropper.tsx"
      via: "renders Cropper with onCropComplete callback"
      pattern: "onCropComplete"
    - from: "src/components/photos/PhotoCropper.tsx"
      to: "src/utils/imageHelpers.ts"
      via: "imports getCroppedImg for final crop extraction"
      pattern: "getCroppedImg"
    - from: "src/pages/PropertyEdit.tsx"
      to: "src/components/photos/PhotoEditor.tsx"
      via: "opens editor modal on photo edit button click"
      pattern: "PhotoEditor.*isOpen"
---

<objective>
Implement interactive photo cropping for property images using react-easy-crop.

Purpose: Allow users to crop property photos to highlight the best parts of each image, improving listing quality.
Output: PhotoCropper component, PhotoEditor modal, imageHelpers utilities, integration with PropertyEdit page.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-media-enhancement-voice/04-RESEARCH.md

# Existing photo components
@src/components/photos/PhotoUploader.tsx
@src/components/photos/PhotoGrid.tsx
@src/types/photo.ts
@src/pages/PropertyEdit.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-easy-crop and create image utilities</name>
  <files>
    package.json
    src/utils/imageHelpers.ts
  </files>
  <action>
1. Install react-easy-crop:
   ```bash
   npm install react-easy-crop
   ```

2. Create src/utils/imageHelpers.ts with:
   - `createImage(url: string): Promise<HTMLImageElement>` - loads image from URL/dataURL
   - `getCroppedImg(imageSrc: string, pixelCrop: Area, rotation?: number): Promise<Blob>` - extracts cropped region using Canvas API

   The Area type comes from react-easy-crop (x, y, width, height in pixels).

   Implementation notes:
   - Use Canvas API for client-side cropping
   - Support rotation parameter (0-360 degrees)
   - Output as JPEG blob with 0.95 quality
   - Handle CORS by drawing image to canvas first
  </action>
  <verify>
    - `npm run build` passes
    - react-easy-crop in package.json dependencies
    - imageHelpers.ts exports getCroppedImg and createImage
  </verify>
  <done>
    Image utilities ready for cropping operations, react-easy-crop installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoCropper and PhotoEditor components</name>
  <files>
    src/components/photos/PhotoCropper.tsx
    src/components/photos/PhotoEditor.tsx
  </files>
  <action>
1. Create PhotoCropper.tsx - the core cropping interface:
   ```typescript
   interface PhotoCropperProps {
     image: string;  // URL or dataURL
     aspect?: number;  // Default 16/9
     onCropComplete: (croppedAreaPixels: Area) => void;
   }
   ```

   Features:
   - Use react-easy-crop Cropper component
   - State: crop position {x, y}, zoom (1-3), rotation (0-360)
   - Zoom slider (range input, 1-3)
   - Rotation slider (range input, 0-360) - optional, can hide initially
   - Aspect ratio selector: 16:9 (default), 4:3, 1:1, Free
   - Mobile-friendly: pinch-to-zoom works out of the box
   - Turkish labels: "Yakınlaştır", "Döndür", "Oran"

2. Create PhotoEditor.tsx - modal wrapper:
   ```typescript
   interface PhotoEditorProps {
     isOpen: boolean;
     onClose: () => void;
     imageUrl: string;
     onSave: (croppedBlob: Blob) => Promise<void>;
   }
   ```

   Features:
   - Modal overlay with dark backdrop
   - Contains PhotoCropper
   - "Kaydet" (Save) and "Iptal" (Cancel) buttons
   - Loading state during save
   - On save: call getCroppedImg, then onSave callback
   - Tailwind styling consistent with existing UI
  </action>
  <verify>
    - `npm run build` passes
    - PhotoCropper renders Cropper from react-easy-crop
    - PhotoEditor renders modal with cropper inside
    - Both components export correctly
  </verify>
  <done>
    PhotoCropper and PhotoEditor components created with all required features.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate photo editing into PropertyEdit page</name>
  <files>
    src/pages/PropertyEdit.tsx
    src/components/photos/PhotoGrid.tsx
  </files>
  <action>
1. Update PhotoGrid.tsx to add edit button:
   - Add optional `onEdit?: (photo: PropertyPhoto) => void` prop
   - Show edit button (pencil icon) on hover for each photo
   - Button triggers onEdit with the photo object

2. Update PropertyEdit.tsx:
   - Import PhotoEditor component
   - Add state: `editingPhoto: PropertyPhoto | null`
   - When PhotoGrid triggers onEdit, set editingPhoto
   - Render PhotoEditor modal when editingPhoto is set
   - On save:
     a. Upload cropped blob to Firebase Storage (same path, overwrite)
     b. Update property.photos array with new URL (add cache-buster query param)
     c. Close editor, show success toast
   - Handle errors with toast notification

3. Storage upload logic:
   - Use existing uploadBytes from firebase/storage
   - Path: same as original photo (overwrite)
   - After upload, get download URL
   - Update Firestore property document with new photo URL
  </action>
  <verify>
    - `npm run build` passes
    - PropertyEdit page shows edit button on photo hover
    - Clicking edit opens PhotoEditor modal
    - Cropping and saving works (manual test)
  </verify>
  <done>
    Photo editing integrated into PropertyEdit page. Users can crop photos and save changes.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Navigate to a property with photos, click edit on a photo
3. Crop area can be dragged and resized
4. Zoom slider works
5. Aspect ratio selector changes crop shape
6. Cancel closes without saving
7. Save uploads cropped image and updates property
</verification>

<success_criteria>
- User can click edit button on any property photo
- PhotoEditor modal opens with interactive crop interface
- User can drag crop area, zoom, change aspect ratio
- Save button uploads cropped image to Storage
- Property detail shows updated cropped photo
- Works on mobile with touch/pinch gestures
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-01-SUMMARY.md`
</output>
