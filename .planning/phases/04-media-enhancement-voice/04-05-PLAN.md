---
phase: 04-media-enhancement-voice
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/photos/PhotoGrid.tsx
  - src/pages/PropertyDetail.tsx
autonomous: true
gap_closure: true
requirements: [MULK-09, MULK-10]

must_haves:
  truths:
    - "User can access advanced photo editor UI for sky replacement and perspective correction"
    - "User can click 'Advanced Edit' button on property photo"
    - "AdvancedPhotoEditor modal opens with selected photo"
    - "User can apply sky replacement and perspective correction"
    - "Enhanced photo saves to Firestore and displays in property listing"
  artifacts:
    - path: "src/components/photos/PhotoGrid.tsx"
      provides: "Advanced Edit button in hover overlay"
      min_lines: 200
    - path: "src/pages/PropertyDetail.tsx"
      provides: "AdvancedPhotoEditor integration with state and handlers"
      min_lines: 580
    - path: "src/components/photos/AdvancedPhotoEditor.tsx"
      provides: "Fully wired advanced photo editor modal"
      min_lines: 371
  key_links:
    - from: "src/components/photos/PhotoGrid.tsx"
      to: "handleAdvancedEdit"
      via: "onAdvancedEdit callback"
      pattern: "onAdvancedEdit.*photo"
    - from: "src/pages/PropertyDetail.tsx"
      to: "src/components/photos/AdvancedPhotoEditor.tsx"
      via: "imports and renders component"
      pattern: "AdvancedPhotoEditor.*isOpen"
    - from: "src/pages/PropertyDetail.tsx"
      to: "Firestore updateDoc"
      via: "handleSaveAdvancedEdit saves enhanced URL"
      pattern: "updateDoc.*photos"
---

<objective>
Wire AdvancedPhotoEditor component to the UI so users can access sky replacement and perspective correction features.

Purpose: Close verification gap - AdvancedPhotoEditor exists (371 lines) but is not accessible to users
Output: Users can click "Advanced Edit" button on photos to access AI sky replacement and perspective correction
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-media-enhancement-voice/04-01-SUMMARY.md
@.planning/phases/04-media-enhancement-voice/04-02-SUMMARY.md
@.planning/phases/04-media-enhancement-voice/04-03-SUMMARY.md
@src/components/photos/AdvancedPhotoEditor.tsx
@src/components/photos/PhotoGrid.tsx
@src/pages/PropertyDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Add "Advanced Edit" button to PhotoGrid hover overlay</name>
  <files>src/components/photos/PhotoGrid.tsx</files>
  <action>
Add "Advanced Edit" button to PhotoGrid component's hover overlay, positioned between the "Edit" (Pencil) button and "Enhance" (PhotoEnhanceButton) button.

**Implementation:**
1. Import Wand2 icon from lucide-react for advanced edit button
2. Add onAdvancedEdit prop to PhotoGridProps interface (optional callback accepting PropertyPhoto)
3. Add new button in hover overlay (lines 136-187) after the Pencil button:
   - Use Wand2 icon (5x5 size)
   - Gradient background: from-purple-500 to-pink-500 (matches AdvancedPhotoEditor button colors)
   - White text color
   - Title: "Gelişmiş düzenleyici (Gökyüzü değiştir, Perspektif düzelt)"
   - onClick calls onAdvancedEdit(photo)
   - Only render if onAdvancedEdit prop is provided
4. Keep existing button order: Star → Pencil → Wand2 (new) → PhotoEnhanceButton → Trash2

**Why this approach:**
- Follows established pattern (onEdit prop → handleEditPhoto → PhotoEditor modal)
- Gradient button visually distinguishes from basic edit (Pencil)
- Position between edit and enhance logically groups transformation features

**What to avoid:**
- Do NOT modify PhotoEditor or PhotoEnhanceButton - those work correctly
- Do NOT change existing button styling or positions
- Do NOT add new state to PhotoGrid - keep it presentation-only
  </action>
  <verify>
Build passes: npm run build
grep -q "onAdvancedEdit" src/components/photos/PhotoGrid.tsx
grep -q "Wand2" src/components/photos/PhotoGrid.tsx
  </verify>
  <done>
PhotoGrid has onAdvancedEdit prop and renders Wand2 button in hover overlay when callback provided.
  </done>
</task>

<task type="auto">
  <name>Wire AdvancedPhotoEditor to PropertyDetail with state and handlers</name>
  <files>src/pages/PropertyDetail.tsx</files>
  <action>
Import AdvancedPhotoEditor component and wire it to PropertyDetail page with proper state management and event handlers.

**Implementation:**

1. Import AdvancedPhotoEditor at top:
   ```typescript
   import { AdvancedPhotoEditor } from '../components/photos/AdvancedPhotoEditor'
   ```

2. Add state for advanced editing (after editingPhoto state, around line 34):
   ```typescript
   const [advancedEditingPhoto, setAdvancedEditingPhoto] = useState<PropertyPhoto | null>(null)
   ```

3. Create handleAdvancedEdit handler (after handleEditPhoto, around line 201):
   ```typescript
   const handleAdvancedEdit = (photo: PropertyPhoto) => {
     setAdvancedEditingPhoto(photo)
   }
   ```

4. Create handleSaveAdvancedEdit handler (after handleSaveCroppedPhoto, around line 230):
   ```typescript
   const handleSaveAdvancedEdit = async (enhancedUrl: string) => {
     if (!id || !user || !advancedEditingPhoto || !property?.photos) return

     try {
       // Update photo URL in Firestore with enhanced version
       const updatedPhotos = property.photos.map((photo) =>
         photo.id === advancedEditingPhoto.id
           ? { ...photo, url: enhancedUrl }
           : photo
       )

       const propertyRef = doc(db, `users/${user.uid}/properties`, id)
       await updateDoc(propertyRef, {
         photos: updatedPhotos,
       })

       setProperty({ ...property, photos: updatedPhotos })
       setAdvancedEditingPhoto(null)
     } catch (err) {
       console.error('Error saving advanced edit:', err)
       alert('Fotoğraf kaydedilemedi')
     }
   }
   ```

5. Pass onAdvancedEdit to PhotoGrid (line ~529):
   ```typescript
   <PhotoGrid
     photos={photos}
     onReorder={handleReorderPhotos}
     onSetCover={handleSetCover}
     onDelete={handleDeletePhoto}
     onEdit={handleEditPhoto}
     onAdvancedEdit={handleAdvancedEdit}  // NEW
     onPhotoEnhanced={handlePhotoEnhanced}
     propertyId={id}
     isEditable={true}
   />
   ```

6. Add AdvancedPhotoEditor modal (after PhotoEditor modal, around line 579):
   ```typescript
   {/* Advanced Photo Editor Modal */}
   {advancedEditingPhoto && (
     <AdvancedPhotoEditor
       isOpen={!!advancedEditingPhoto}
       onClose={() => setAdvancedEditingPhoto(null)}
       imageUrl={advancedEditingPhoto.url}
       propertyId={id!}
       photoIndex={advancedEditingPhoto.order}
       onSave={handleSaveAdvancedEdit}
     />
   )}
   ```

**Pattern consistency:**
This follows the exact same pattern as PhotoEditor:
- State: editingPhoto → advancedEditingPhoto
- Handler: handleEditPhoto → handleAdvancedEdit
- Save handler: handleSaveCroppedPhoto → handleSaveAdvancedEdit
- Modal conditional: {editingPhoto && <PhotoEditor />} → {advancedEditingPhoto && <AdvancedPhotoEditor />}

**Why this approach:**
- Reuses proven PhotoEditor integration pattern
- handleSaveAdvancedEdit updates Firestore (AdvancedPhotoEditor's onSave already handles enhanced URL from Cloud Function)
- Proper state cleanup on modal close
  </action>
  <verify>
Build passes: npm run build
grep -q "AdvancedPhotoEditor" src/pages/PropertyDetail.tsx
grep -q "advancedEditingPhoto" src/pages/PropertyDetail.tsx
grep -q "handleAdvancedEdit" src/pages/PropertyDetail.tsx
grep -q "handleSaveAdvancedEdit" src/pages/PropertyDetail.tsx
  </verify>
  <done>
AdvancedPhotoEditor imported and wired to PropertyDetail with state, handlers, and modal rendering. Users can click "Advanced Edit" button to open AdvancedPhotoEditor modal.
  </done>
</task>

<task type="auto">
  <name>Verify integration and commit changes</name>
  <files>src/components/photos/PhotoGrid.tsx, src/pages/PropertyDetail.tsx</files>
  <action>
Verify the complete integration chain and commit the gap closure.

**Verification steps:**
1. Build verification: `npm run build` (must pass without TypeScript errors)
2. Component import verification:
   ```bash
   grep "import.*AdvancedPhotoEditor" src/pages/PropertyDetail.tsx
   ```
3. Button wiring verification:
   ```bash
   grep "onAdvancedEdit" src/components/photos/PhotoGrid.tsx
   grep "onAdvancedEdit.*handleAdvancedEdit" src/pages/PropertyDetail.tsx
   ```
4. State management verification:
   ```bash
   grep "advancedEditingPhoto" src/pages/PropertyDetail.tsx | wc -l  # Should be 6+ occurrences
   ```

**Commit:**
```bash
node /home/cagr/.claude/get-shit-done/bin/gsd-tools.cjs commit "fix(04): wire AdvancedPhotoEditor to UI for sky replacement and perspective correction

Closes verification gap - AdvancedPhotoEditor component (371 lines) was implemented but not accessible to users.

Changes:
- Add 'Advanced Edit' button (Wand2 icon) to PhotoGrid hover overlay
- Wire AdvancedPhotoEditor to PropertyDetail with state and handlers
- Follow same pattern as PhotoEditor integration (state → handler → modal)
- Users can now access sky replacement (MULK-09) and perspective correction (MULK-10)

Requirements: MULK-09, MULK-10" --files src/components/photos/PhotoGrid.tsx src/pages/PropertyDetail.tsx
```

**Integration chain verification:**
User hovers photo → sees Wand2 button → clicks → handleAdvancedEdit sets advancedEditingPhoto → AdvancedPhotoEditor opens → user applies sky/perspective → handleSaveAdvancedEdit updates Firestore → modal closes
  </action>
  <verify>
npm run build (exit code 0)
git log --oneline -1 | grep -q "wire AdvancedPhotoEditor"
grep -q "AdvancedPhotoEditor" src/pages/PropertyDetail.tsx
grep -q "onAdvancedEdit" src/components/photos/PhotoGrid.tsx
  </verify>
  <done>
Build passes, integration verified, changes committed. AdvancedPhotoEditor is now accessible via "Advanced Edit" button in PhotoGrid. Requirements MULK-09 and MULK-10 are unblocked.
  </done>
</task>

</tasks>

<verification>
1. Build passes without TypeScript errors
2. PhotoGrid renders "Advanced Edit" button with Wand2 icon
3. Clicking button opens AdvancedPhotoEditor modal
4. Sky replacement and perspective correction buttons work
5. Saving enhanced photo updates Firestore and UI
6. Modal closes cleanly after save
7. Integration follows PhotoEditor pattern exactly
</verification>

<success_criteria>
- [x] AdvancedPhotoEditor component imported in PropertyDetail
- [x] advancedEditingPhoto state added
- [x] handleAdvancedEdit and handleSaveAdvancedEdit handlers created
- [x] PhotoGrid receives onAdvancedEdit prop
- [x] "Advanced Edit" button (Wand2 icon) renders in PhotoGrid hover overlay
- [x] AdvancedPhotoEditor modal conditionally rendered
- [x] Build passes without errors
- [x] Changes committed to git
- [x] Requirements MULK-09 and MULK-10 unblocked
- [x] Verification gap closed: Users can access advanced photo features
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-enhancement-voice/04-05-SUMMARY.md`
</output>
