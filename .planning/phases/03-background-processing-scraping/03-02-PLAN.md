---
phase: 03-background-processing-scraping
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/photos/PhotoUploader.tsx
  - src/components/photos/PhotoGrid.tsx
  - src/components/photos/UploadProgressIndicator.tsx
  - src/components/layout/Header.tsx
  - src/pages/properties/PropertyDetailPage.tsx
autonomous: true
requirements:
  - MULK-05
  - MULK-06

must_haves:
  truths:
    - "User can drag-drop photos or click to browse"
    - "Per-photo progress indicator shows upload percentage"
    - "User can star a photo to set as cover"
    - "User can reorder photos with drag-drop"
    - "Header shows upload indicator when uploads active in background"
  artifacts:
    - path: "src/components/photos/PhotoUploader.tsx"
      provides: "Drag-drop zone with click-to-browse"
      contains: "useDropzone"
    - path: "src/components/photos/PhotoGrid.tsx"
      provides: "Photo grid with reordering and cover selection"
      contains: "onDragEnd"
    - path: "src/components/photos/UploadProgressIndicator.tsx"
      provides: "Per-photo progress bars"
    - path: "src/components/layout/Header.tsx"
      provides: "Background upload indicator in header"
      contains: "hasActiveUploads"
  key_links:
    - from: "src/components/photos/PhotoUploader.tsx"
      to: "src/hooks/usePhotoUpload.ts"
      via: "uploadPhotos call"
      pattern: "usePhotoUpload.*uploadPhotos"
    - from: "src/components/layout/Header.tsx"
      to: "src/stores/uploadStore.ts"
      via: "zustand store subscription"
      pattern: "useUploadStore.*hasActiveUploads"
---

<objective>
Build photo upload UI with drag-drop, progress tracking, cover selection, and background upload indicator.

Purpose: Provide intuitive photo management for property listings with batch upload (10-20 photos), drag-drop reordering, and non-blocking background uploads that persist across navigation.

Output: Complete photo upload experience on property detail page with header indicator for background uploads.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-processing-scraping/03-RESEARCH.md
@.planning/phases/03-background-processing-scraping/03-CONTEXT.md
@.planning/phases/03-background-processing-scraping/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhotoUploader component with react-dropzone</name>
  <files>
    src/components/photos/PhotoUploader.tsx
    src/components/photos/UploadProgressIndicator.tsx
    package.json
  </files>
  <action>
Install react-dropzone and create photo upload components:

1. Add react-dropzone (^14.x) to package.json dependencies

2. Create src/components/photos/PhotoUploader.tsx:
   - Props: { propertyId: string, onUploadComplete?: () => void }
   - Use react-dropzone with accept: image/* (.jpeg, .jpg, .png, .webp)
   - maxFiles: 20 (per MULK-05 requirement)
   - Per user decision: Both drag-drop AND click-to-browse available

   UI per RESEARCH.md:
   ```
   <div ...getRootProps()>
     <input ...getInputProps() />
     {isDragActive ? (
       <p>Fotoğrafları buraya bırakın...</p>
     ) : (
       <p>Fotoğrafları sürükleyin veya tıklayarak seçin (max 20)</p>
     )}
   </div>
   ```

   Styling:
   - Border-dashed, rounded-lg, p-8, text-center, cursor-pointer
   - isDragActive: border-blue-500 bg-blue-50
   - Default: border-gray-300

   On drop:
   - Call uploadPhotos from usePhotoUpload hook
   - Photos stay in upload order (per user decision - no reorder during upload)

3. Create src/components/photos/UploadProgressIndicator.tsx:
   - Props: { uploads: PhotoUpload[] }
   - Per user decision: Per-photo progress indicator showing individual upload percentage

   For each upload:
   - Show filename (truncated if > 20 chars)
   - Progress bar with percentage
   - Status icon: spinner (uploading), check (done), X (error)
   - Error message if failed

   Styling:
   - Compact list format
   - Progress bar: h-2, bg-blue-500, rounded
   - Done: green check, Error: red X

4. Run npm install to add react-dropzone
  </action>
  <verify>
    - npm run build succeeds
    - react-dropzone added to package.json
    - PhotoUploader renders dropzone area
    - UploadProgressIndicator shows per-file progress
  </verify>
  <done>PhotoUploader component ready with drag-drop and progress indicators</done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoGrid with reordering and cover selection</name>
  <files>
    src/components/photos/PhotoGrid.tsx
  </files>
  <action>
Create photo grid with drag-drop reordering and cover selection (per user decisions):

1. Create src/components/photos/PhotoGrid.tsx:
   - Props: {
       photos: PropertyPhoto[],
       onReorder: (photos: PropertyPhoto[]) => void,
       onSetCover: (photoId: string) => void,
       onDelete: (photoId: string) => void,
       isEditable?: boolean
     }

   Per user decision: "Photos stay in upload order, star icon to select cover photo"

   Grid layout:
   - Responsive grid: grid-cols-2 md:grid-cols-3 lg:grid-cols-4
   - Each photo is a card with hover actions

   Photo card:
   - Image with aspect-square, object-cover
   - Cover badge (if isCover): "Kapak" badge in top-left corner
   - Hover overlay with actions (only if isEditable):
     - Star icon to set as cover (filled if current cover)
     - Trash icon to delete
     - Drag handle for reordering

   Drag-drop reordering:
   - Use native HTML5 drag events (simpler than library for this use case)
   - onDragStart: set dragged photo ID
   - onDragOver: preventDefault to allow drop
   - onDrop: reorder array and call onReorder
   - Visual feedback during drag (opacity, drop target highlight)

   OR use @hello-pangea/dnd if available (alternative to react-beautiful-dnd)
   For simplicity, implement with native HTML5 drag since we're doing simple reorder

   Per user decision "Star as cover" pattern:
   - Click star icon on any photo to set as cover
   - Previous cover becomes regular photo
   - Only one cover at a time

   Empty state:
   - Show upload prompt when no photos
  </action>
  <verify>
    - PhotoGrid renders photos in grid layout
    - Cover photo shows badge
    - Star icon visible on hover
    - Drag-drop triggers onReorder callback
    - TypeScript compiles
  </verify>
  <done>PhotoGrid component ready with reordering and cover selection</done>
</task>

<task type="auto">
  <name>Task 3: Integrate photos into PropertyDetailPage and Header</name>
  <files>
    src/pages/properties/PropertyDetailPage.tsx
    src/components/layout/Header.tsx
  </files>
  <action>
Integrate photo components into property management and add header indicator:

1. Update src/pages/properties/PropertyDetailPage.tsx:
   - Import PhotoUploader, PhotoGrid, UploadProgressIndicator
   - Import usePhotoUpload hook

   Add photos section below property details:
   ```
   {/* Fotoğraflar Section */}
   <section>
     <h2>Fotoğraflar</h2>

     {/* Upload area */}
     <PhotoUploader propertyId={propertyId} />

     {/* Upload progress (only when uploads active) */}
     {uploads.length > 0 && (
       <UploadProgressIndicator uploads={uploads} />
     )}

     {/* Photo grid */}
     <PhotoGrid
       photos={property.photos || []}
       onReorder={handleReorderPhotos}
       onSetCover={handleSetCover}
       onDelete={handleDeletePhoto}
       isEditable={true}
     />
   </section>
   ```

   Handlers:
   - handleReorderPhotos: Update property.photos array order in Firestore
   - handleSetCover: Update isCover flag in property.photos
   - handleDeletePhoto: Remove from photos array, delete from Storage

   Note: Fetch photos from property document (assume photos stored as array in property doc)
   Structure: property.photos = PropertyPhoto[] with id, url, thumbnailUrl, order, isCover

2. Update src/components/layout/Header.tsx:
   - Import useUploadStore

   Per user decision: "small header indicator" when uploads active

   Add near right side of header (before user menu):
   ```
   {hasActiveUploads() && (
     <div className="flex items-center gap-2 text-sm text-gray-600">
       <Loader2 className="h-4 w-4 animate-spin" />
       <span>Yükleniyor...</span>
     </div>
   )}
   ```

   Alternative: Show count like "3 fotoğraf yükleniyor"
   Keep it minimal per user decision

3. Add photos field to Property type if not exists:
   - photos: PropertyPhoto[] (optional, defaults to [])
  </action>
  <verify>
    - PropertyDetailPage shows photos section
    - Upload area visible on property page
    - Progress indicators appear during upload
    - Header shows indicator when uploads active
    - npm run build succeeds
  </verify>
  <done>Photo upload fully integrated with property detail and header indicator</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. PhotoUploader accepts drag-drop AND click-to-browse
3. UploadProgressIndicator shows per-photo percentage
4. PhotoGrid allows drag-drop reorder and star-to-cover
5. Header shows upload indicator when active
6. All Turkish text (no English in UI)
</verification>

<success_criteria>
- User can drag-drop 10-20 photos into upload zone
- User can also click to browse files
- Per-photo progress shows during upload
- Photos display in grid after upload
- User can star photo as cover
- User can drag-drop reorder photos
- Header shows indicator during background uploads
- User can navigate away and uploads continue
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-processing-scraping/03-02-SUMMARY.md`
</output>
