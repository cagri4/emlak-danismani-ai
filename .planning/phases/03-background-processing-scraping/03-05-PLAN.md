---
phase: 03-background-processing-scraping
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/scoring/leadScorer.ts
  - src/hooks/useLeadScore.ts
  - src/types/customer.ts
  - src/components/customers/LeadTemperatureBadge.tsx
  - src/components/dashboard/HotLeadsCard.tsx
  - src/pages/customers/CustomersPage.tsx
  - src/pages/DashboardPage.tsx
autonomous: true
requirements:
  - MUST-05

must_haves:
  truths:
    - "Lead score calculated from interaction date, frequency, and decisions"
    - "Score decays exponentially after 14 days without contact"
    - "User can boost/pin important customers"
    - "Customer list shows color/badge for lead temperature"
    - "Dashboard shows Hot Leads card with top leads"
  artifacts:
    - path: "src/lib/scoring/leadScorer.ts"
      provides: "Lead scoring algorithm with time decay"
      exports: ["calculateLeadScore", "getLeadTemperature"]
    - path: "src/hooks/useLeadScore.ts"
      provides: "Hook to calculate and update lead scores"
      exports: ["useLeadScore"]
    - path: "src/components/customers/LeadTemperatureBadge.tsx"
      provides: "Color badge for lead temperature"
    - path: "src/components/dashboard/HotLeadsCard.tsx"
      provides: "Dashboard card showing top leads"
  key_links:
    - from: "src/lib/scoring/leadScorer.ts"
      to: "date-fns"
      via: "differenceInDays"
      pattern: "differenceInDays.*lastInteraction"
    - from: "src/pages/customers/CustomersPage.tsx"
      to: "src/components/customers/LeadTemperatureBadge.tsx"
      via: "render in list"
      pattern: "LeadTemperatureBadge"
---

<objective>
Implement lead scoring algorithm with time decay and dashboard integration.

Purpose: Automatically prioritize customers based on engagement signals (interaction frequency, decisions) with exponential time decay after 14 days of no contact. Display lead temperature via color badges and highlight hot leads on dashboard.

Output: Lead scoring algorithm, temperature badges, hot leads dashboard card.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-processing-scraping/03-RESEARCH.md
@.planning/phases/03-background-processing-scraping/03-CONTEXT.md
@.planning/phases/02-ai-interface-matching/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead scoring algorithm with time decay</name>
  <files>
    src/lib/scoring/leadScorer.ts
    src/types/customer.ts
  </files>
  <action>
Create lead scoring algorithm per RESEARCH.md Pattern 6 and user decisions:

1. Update src/types/customer.ts to add scoring fields:
   ```typescript
   // Add to existing Customer interface
   leadScore?: number;
   leadTemperature?: 'hot' | 'warm' | 'cold';
   isBoosted?: boolean;  // Manual boost/pin (per user decision)
   lastScoreUpdate?: Date;
   ```

2. Create src/lib/scoring/leadScorer.ts:

   Interface ScoringSignal:
   ```typescript
   interface ScoringSignal {
     lastInteraction: Date;
     interactionCount: number;
     likedProperties: number;      // from match_outcomes
     rejectedProperties: number;   // from match_outcomes
     isBoosted: boolean;
   }
   ```

   Function calculateLeadScore(signal: ScoringSignal): number
   Per user decisions:
   - "Scoring signals: Last interaction date + interaction frequency + decisions (liked/rejected) - all weighted"
   - "Decay: Lead starts cooling after 14 days without communication"

   Algorithm (Claude's discretion on exact weights):
   ```typescript
   const daysSinceContact = differenceInDays(new Date(), signal.lastInteraction);

   // Time decay: exponential decay after 14 days
   // Per RESEARCH.md: ~60% at 30 days, ~36% at 45 days
   const timeFactor = daysSinceContact <= 14
     ? 1.0
     : Math.exp(-0.05 * (daysSinceContact - 14));

   // Weighted signals (Claude's discretion)
   const engagementScore = (
     signal.interactionCount * 2 +      // Each interaction: 2 points
     signal.likedProperties * 5 +        // Each like: 5 points
     signal.rejectedProperties * -1      // Each rejection: -1 point
   );

   // Apply time decay
   let score = Math.max(0, engagementScore * timeFactor);

   // Boost adds fixed bonus (per user decision: "boost/pin feature to mark important")
   if (signal.isBoosted) {
     score += 20;  // Significant but not overwhelming
   }

   return Math.round(score);
   ```

   Function getLeadTemperature(score: number): 'hot' | 'warm' | 'cold'
   Thresholds (Claude's discretion):
   - hot: score >= 30
   - warm: score >= 15 && score < 30
   - cold: score < 15

   Function buildScoringSignal(customer: Customer, outcomes: MatchOutcome[]): ScoringSignal
   - Extract lastInteraction from customer.lastInteractionAt or interactions
   - Count interactions from customer.interactionCount
   - Count liked/rejected from match_outcomes for this customer
   - Get isBoosted from customer.isBoosted
  </action>
  <verify>
    - leadScorer.ts compiles without errors
    - calculateLeadScore returns number
    - getLeadTemperature returns correct enum
    - Time decay formula correct
  </verify>
  <done>Lead scoring algorithm with time decay and boost support ready</done>
</task>

<task type="auto">
  <name>Task 2: Create lead score hook and badge component</name>
  <files>
    src/hooks/useLeadScore.ts
    src/components/customers/LeadTemperatureBadge.tsx
  </files>
  <action>
Create hook for managing lead scores and visual badge:

1. Create src/hooks/useLeadScore.ts:
   - Import scoring functions
   - Import useAuth, useFirestore patterns

   Hook: useLeadScore(customerId?: string)
   Returns:
   - score: number | null
   - temperature: 'hot' | 'warm' | 'cold' | null
   - recalculate: () => Promise<void>
   - toggleBoost: () => Promise<void>
   - isLoading: boolean

   recalculate():
   - Fetch customer data
   - Fetch match outcomes for customer
   - Build signal, calculate score
   - Update customer document with new score and temperature
   - Per user decision pitfall: "Recalculate score on every interaction"

   toggleBoost():
   - Toggle customer.isBoosted
   - Recalculate score after toggle
   - Per user decision: "Boost/pin feature to mark important customers"

   useLeadScores() (alternative hook for list view):
   - Calculate scores for multiple customers efficiently
   - Batch fetch match outcomes
   - Return Map<customerId, { score, temperature }>

2. Create src/components/customers/LeadTemperatureBadge.tsx:
   - Props: { temperature: 'hot' | 'warm' | 'cold', showLabel?: boolean }

   Per user decision: "Color/badge in customer list"

   UI:
   - Hot: Red background, flame icon or "Sıcak" label
   - Warm: Yellow/orange background, "Ilık" label
   - Cold: Blue background, snowflake or "Soğuk" label

   Styling:
   ```typescript
   const styles = {
     hot: 'bg-red-100 text-red-800 border-red-200',
     warm: 'bg-amber-100 text-amber-800 border-amber-200',
     cold: 'bg-blue-100 text-blue-800 border-blue-200',
   };
   ```

   Compact mode (showLabel=false): Just colored dot
   Full mode: Badge with text and optional icon
  </action>
  <verify>
    - useLeadScore hook compiles
    - toggleBoost updates isBoosted field
    - LeadTemperatureBadge renders all three states
    - Colors match user decision (color-coded)
  </verify>
  <done>Lead score hook and temperature badge component ready</done>
</task>

<task type="auto">
  <name>Task 3: Integrate lead scoring into customers page and dashboard</name>
  <files>
    src/pages/customers/CustomersPage.tsx
    src/components/dashboard/HotLeadsCard.tsx
    src/pages/DashboardPage.tsx
  </files>
  <action>
Integrate lead scoring UI into existing pages:

1. Update src/pages/customers/CustomersPage.tsx:
   - Import LeadTemperatureBadge
   - Import useLeadScores (batch hook)

   Add to customer list display:
   - Temperature badge next to customer name
   - Sort option: by lead score (descending)
   - Filter option: by temperature (hot/warm/cold)

   Add boost toggle:
   - Star/pin icon on each customer row
   - Click toggles isBoosted
   - Boosted customers show filled star

   List item structure:
   ```
   [Avatar] [Name] [LeadTemperatureBadge] [Star/Pin] [Urgency] [Actions]
   ```

   Per user decision: "Color/badge in customer list"

2. Create src/components/dashboard/HotLeadsCard.tsx:
   - Props: { customers: Customer[] } or fetch internally

   Per user decision: "Hot Leads card on dashboard"

   UI:
   - Card title: "Sıcak Adaylar" or "Öncelikli Müşteriler"
   - List top 5 hot leads (temperature === 'hot')
   - Each item: name, phone, last contact date, temperature badge
   - Click navigates to customer detail

   If no hot leads:
   - Show encouraging message: "Tüm müşterilerle iletişimde kalın!"

   Sort by: score descending

3. Update src/pages/DashboardPage.tsx:
   - Import HotLeadsCard
   - Add to dashboard grid (alongside existing metric cards)
   - Fetch customers with temperature === 'hot' or score >= 30

   Placement: Consider putting near customer-related metrics
   Grid: May need layout adjustment for new card

4. Trigger score recalculation:
   - When interaction added (in customer detail page)
   - When match outcome recorded (in matching flow)
   - Consider: Scheduled daily recalculation (future enhancement)
  </action>
  <verify>
    - CustomersPage shows temperature badges
    - Sort by lead score works
    - Boost toggle updates customer
    - HotLeadsCard shows on dashboard
    - npm run build succeeds
  </verify>
  <done>Lead scoring integrated into customer list and dashboard</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Lead score calculation uses correct formula with time decay
3. Temperature badges show correct colors
4. Customers page shows badges and allows sorting/filtering
5. Boost toggle works and recalculates score
6. Dashboard shows Hot Leads card
7. All Turkish text in UI
</verification>

<success_criteria>
- Lead score calculated from interactions, likes, rejects
- Score decays after 14 days without contact
- Temperature: hot (30+), warm (15-30), cold (<15)
- User can boost/pin important customers
- Customer list shows colored temperature badges
- Dashboard shows Hot Leads card with top customers
- Score recalculated on new interactions
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-processing-scraping/03-05-SUMMARY.md`
</output>
