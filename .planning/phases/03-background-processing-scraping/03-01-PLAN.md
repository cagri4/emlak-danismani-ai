---
phase: 03-background-processing-scraping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/package.json
  - functions/tsconfig.json
  - functions/src/index.ts
  - functions/src/jobs/imageProcessor.ts
  - functions/src/config.ts
  - firebase.json
  - src/stores/uploadStore.ts
  - src/hooks/usePhotoUpload.ts
  - src/types/photo.ts
autonomous: true
requirements:
  - MULK-05

must_haves:
  truths:
    - "Cloud Functions project initialized with TypeScript"
    - "Storage trigger automatically generates thumbnails on photo upload"
    - "Client can upload photos with progress tracking"
    - "Upload state persists across route navigation via zustand"
  artifacts:
    - path: "functions/package.json"
      provides: "Cloud Functions dependencies (sharp, firebase-functions v2)"
    - path: "functions/src/index.ts"
      provides: "Function exports"
      exports: ["processPropertyPhoto"]
    - path: "functions/src/jobs/imageProcessor.ts"
      provides: "Thumbnail generation and compression"
      contains: "onObjectFinalized"
    - path: "src/stores/uploadStore.ts"
      provides: "Background upload state management"
      exports: ["useUploadStore"]
    - path: "src/hooks/usePhotoUpload.ts"
      provides: "Multi-file upload with progress"
      exports: ["usePhotoUpload"]
  key_links:
    - from: "src/hooks/usePhotoUpload.ts"
      to: "Firebase Storage"
      via: "uploadBytesResumable"
      pattern: "uploadBytesResumable.*properties/"
    - from: "functions/src/jobs/imageProcessor.ts"
      to: "Firebase Storage"
      via: "onObjectFinalized trigger"
      pattern: "onObjectFinalized.*properties/"
---

<objective>
Initialize Firebase Cloud Functions infrastructure with image processing pipeline for property photos.

Purpose: Establish the background job foundation required for photo uploads, portal import, and competitor monitoring. This plan sets up the Cloud Functions project with TypeScript, implements automatic thumbnail generation when photos are uploaded, and creates client-side upload hooks with persistent state.

Output: Working Cloud Functions project with image processor, client upload infrastructure with zustand state persistence.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-processing-scraping/03-RESEARCH.md
@.planning/phases/03-background-processing-scraping/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Cloud Functions with TypeScript and dependencies</name>
  <files>
    functions/package.json
    functions/tsconfig.json
    functions/src/index.ts
    functions/src/config.ts
    firebase.json
    .gitignore
  </files>
  <action>
Create functions/ directory at project root with Firebase Cloud Functions v2 setup:

1. Create functions/package.json with:
   - name: "emlak-functions"
   - engines: { node: "20" }
   - dependencies: firebase-functions (^6.x), firebase-admin (^13.x), sharp (^0.33.x)
   - devDependencies: typescript, @types/node
   - scripts: build, serve, deploy, logs

2. Create functions/tsconfig.json with:
   - compilerOptions: target ES2022, module CommonJS (required for Cloud Functions), strict true
   - outDir: ./lib, rootDir: ./src
   - resolveJsonModule: true

3. Create functions/src/config.ts with:
   - Initialize firebase-admin app
   - Export storage bucket reference
   - Export Firestore db reference
   - Region configuration: europe-west1 (KVKK compliance per user decision)

4. Create functions/src/index.ts with:
   - Export imageProcessor functions
   - Comment placeholders for future exports (scrapers, schedulers)

5. Update firebase.json to add functions configuration:
   - source: "functions"
   - predeploy: npm --prefix functions run build
   - codebase: default
   - runtime: nodejs20
   - region: europe-west1

6. Update .gitignore to add:
   - functions/lib/
   - functions/node_modules/

Note: Do NOT run npm install in functions/ - that will be done during deployment or by user manually.
  </action>
  <verify>
    - functions/package.json exists with correct dependencies
    - functions/tsconfig.json compiles valid TypeScript config
    - firebase.json updated with functions config
    - All files are syntactically correct
  </verify>
  <done>Cloud Functions project structure complete with TypeScript configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create image processor Cloud Function</name>
  <files>
    functions/src/jobs/imageProcessor.ts
    functions/src/index.ts
  </files>
  <action>
Create the image processing function that triggers on Storage uploads:

1. Create functions/src/jobs/imageProcessor.ts:
   - Import onObjectFinalized from firebase-functions/v2/storage
   - Import sharp for image processing
   - Import admin storage from config

   Function: processPropertyPhoto
   - Trigger: onObjectFinalized on properties/* path
   - Region: europe-west1 (per KVKK compliance)
   - Memory: 1GiB (image processing needs memory)
   - Timeout: 120 seconds

   Logic:
   - Skip if not image (check contentType starts with image/)
   - Skip if already processed (filename contains -thumb or -compressed)
   - Download original image from bucket
   - Generate thumbnail:
     - 200x200 max dimension, withoutEnlargement
     - JPEG quality 80
     - Save to {originalPath}-thumb.{ext}
   - Compress original:
     - Keep original dimensions
     - JPEG quality 85 (per user discretion - balance size/quality)
     - Overwrite original file
   - Update property document with thumbnail URL (optional - can be derived from path)
   - Log success with file sizes

   Error handling:
   - Wrap in try-catch
   - Log errors with file path context
   - Don't rethrow (prevent infinite retries on permanent failures)

2. Update functions/src/index.ts:
   - Import and re-export processPropertyPhoto from jobs/imageProcessor
  </action>
  <verify>
    - functions/src/jobs/imageProcessor.ts compiles without TypeScript errors
    - Function exports are valid
    - Sharp import syntax correct
  </verify>
  <done>Image processor function ready, generates thumbnails and compresses on upload</done>
</task>

<task type="auto">
  <name>Task 3: Create client-side upload infrastructure with zustand</name>
  <files>
    src/types/photo.ts
    src/stores/uploadStore.ts
    src/hooks/usePhotoUpload.ts
    package.json
  </files>
  <action>
Install zustand and create client-side upload state management:

1. Add zustand to package.json dependencies (^5.x)

2. Create src/types/photo.ts:
   ```typescript
   export interface PhotoUpload {
     id: string;
     file: File;
     propertyId: string;
     order: number;
     progress: number;
     status: 'pending' | 'uploading' | 'done' | 'error';
     url?: string;
     thumbnailUrl?: string;
     error?: string;
   }

   export interface PropertyPhoto {
     id: string;
     url: string;
     thumbnailUrl?: string;
     order: number;
     isCover: boolean;
     uploadedAt: Date;
   }
   ```

3. Create src/stores/uploadStore.ts using zustand (per RESEARCH.md Pattern 8):
   - State: uploads (PhotoUpload[]), activePropertyId (string | null)
   - Actions:
     - addUploads(files: File[], propertyId: string): Add multiple files to queue
     - updateProgress(id: string, progress: number): Update upload progress
     - setComplete(id: string, url: string): Mark upload done with URL
     - setError(id: string, error: string): Mark upload failed
     - clearCompleted(): Remove completed uploads from list
     - getUploadsForProperty(propertyId: string): Get uploads for specific property
     - hasActiveUploads(): Boolean check for header indicator

   Key: zustand store persists across navigation (unlike React Context)

4. Create src/hooks/usePhotoUpload.ts:
   - Import uploadBytesResumable, ref, getDownloadURL from firebase/storage
   - Import useUploadStore
   - Import storage from lib/firebase

   Hook: usePhotoUpload(propertyId: string)
   - Returns: { uploadPhotos, uploads, isUploading, clearCompleted }

   uploadPhotos(files: File[]):
   - Add files to store with order based on existing count
   - For each file, start uploadBytesResumable to properties/{propertyId}/{id}-{filename}
   - On state_changed: update progress in store
   - On complete: get download URL, update store, update property document
   - On error: set error in store

   Per user decision: Uploads continue in background when user navigates away
   (zustand state persists, upload tasks are async)

5. Run npm install to add zustand
  </action>
  <verify>
    - npm run build succeeds
    - zustand added to package.json
    - src/stores/uploadStore.ts exports useUploadStore
    - src/hooks/usePhotoUpload.ts exports usePhotoUpload
    - TypeScript compilation passes
  </verify>
  <done>Client upload infrastructure ready with persistent state and progress tracking</done>
</task>

</tasks>

<verification>
1. `npm run build` in root succeeds (client code)
2. Cloud Functions TypeScript compiles (check syntax, don't require npm install)
3. zustand store exports useUploadStore
4. usePhotoUpload hook exports with correct return type
5. Image processor function configured with correct trigger path
</verification>

<success_criteria>
- Cloud Functions project initialized at functions/
- Image processor triggers on properties/* uploads
- Client can track upload progress across navigation
- zustand store persists upload state
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-processing-scraping/03-01-SUMMARY.md`
</output>
