---
phase: 06-mobile-pwa-sharing
plan: 04
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/lib/firebase.ts
  - src/hooks/useNotifications.ts
  - src/components/notifications/NotificationPermissionPrompt.tsx
  - public/firebase-messaging-sw.js
  - functions/src/triggers/onPropertyCreated.ts
  - functions/src/triggers/onCustomerCreated.ts
  - functions/src/index.ts
autonomous: false
requirements:
  - MOBL-06
  - MOBL-07

user_setup:
  - service: firebase-cloud-messaging
    why: "Push notifications require VAPID keys"
    env_vars:
      - name: VITE_FIREBASE_VAPID_KEY
        source: "Firebase Console -> Project Settings -> Cloud Messaging -> Web Push certificates -> Generate key pair"
    dashboard_config:
      - task: "Generate Web Push certificate"
        location: "Firebase Console -> Project Settings -> Cloud Messaging tab -> Web configuration section"

must_haves:
  truths:
    - "User can grant notification permission via in-app prompt"
    - "User receives push notification when new property matches their customer"
    - "User receives push notification when new customer has matching properties"
    - "Notifications work when app is in background"
    - "Foreground notifications show as toast"
  artifacts:
    - path: "src/lib/firebase.ts"
      provides: "Firebase Messaging initialization"
      contains: "getMessaging"
    - path: "src/hooks/useNotifications.ts"
      provides: "Notification permission and token management"
      exports: ["useNotifications"]
    - path: "public/firebase-messaging-sw.js"
      provides: "Service worker for background FCM messages"
      contains: "messaging.onBackgroundMessage"
    - path: "functions/src/triggers/onPropertyCreated.ts"
      provides: "Updated trigger with FCM push"
      contains: "messaging.send"
  key_links:
    - from: "src/hooks/useNotifications.ts"
      to: "firebase/messaging"
      via: "getToken and onMessage"
      pattern: "getToken"
    - from: "functions/src/triggers/onPropertyCreated.ts"
      to: "firebase-admin/messaging"
      via: "admin.messaging().send"
      pattern: "messaging\\(\\)\\.send"
    - from: "public/firebase-messaging-sw.js"
      to: "firebase-messaging-compat"
      via: "importScripts"
      pattern: "onBackgroundMessage"
---

<objective>
Implement Firebase Cloud Messaging (FCM) for push notifications on match events.

Purpose: Real estate agents need to be notified immediately when a new property matches their customer or when a new customer has matching properties. Push notifications ensure they don't miss opportunities.

Output: FCM integrated with permission prompt, background notifications via service worker, and Cloud Functions sending notifications on match events.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mobile-pwa-sharing/06-RESEARCH.md
@.planning/phases/06-mobile-pwa-sharing/06-01-SUMMARY.md

# Existing trigger files to update
@functions/src/triggers/onPropertyCreated.ts
@functions/src/triggers/onCustomerCreated.ts
@functions/src/index.ts

# Existing firebase setup
@src/lib/firebase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up FCM client with permission prompt</name>
  <files>
    src/lib/firebase.ts
    src/hooks/useNotifications.ts
    src/components/notifications/NotificationPermissionPrompt.tsx
  </files>
  <action>
1. Update src/lib/firebase.ts:
   - Import getMessaging, getToken, onMessage from 'firebase/messaging'
   - Initialize messaging: `export const messaging = getMessaging(app)`
   - Wrap in try-catch (messaging may not be supported in all browsers)

2. Create src/hooks/useNotifications.ts:
   - State: hasPermission (boolean), token (string | null), isLoading (boolean)
   - On mount: Check Notification.permission state
   - requestPermission(): async function
     - Call Notification.requestPermission()
     - If granted, get FCM token with VAPID key:
       ```typescript
       const token = await getToken(messaging, {
         vapidKey: import.meta.env.VITE_FIREBASE_VAPID_KEY
       })
       ```
     - Save token to user's Firestore document: users/{uid}/fcmTokens/{token}
     - Include device info: platform, browser, createdAt
   - setupForegroundHandler():
     - Use onMessage(messaging, callback) to handle foreground messages
     - Show toast notification using sonner
   - Return: { hasPermission, token, isLoading, requestPermission }

3. Create src/components/notifications/NotificationPermissionPrompt.tsx:
   - Use useNotifications hook
   - Show card prompting user to enable notifications (only if permission not yet asked)
   - Turkish text: "Bildirimleri Ac" button, explanation of benefits
   - "Yeni eslesmeler icin aninda bildirim alin"
   - Styling: card with bell icon, enable button, dismiss button
   - Save dismissal to localStorage (don't show again for 7 days)
   - Place in dashboard or main layout
  </action>
  <verify>
    npm run build passes
    Hook initializes without errors
    Permission prompt appears for users who haven't granted permission
    Token is retrieved after permission granted
  </verify>
  <done>
    FCM client set up, permission prompt working, tokens saved to Firestore
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FCM service worker for background notifications</name>
  <files>
    public/firebase-messaging-sw.js
  </files>
  <action>
1. Create public/firebase-messaging-sw.js:
   - Use compat version for service worker (required):
     ```javascript
     importScripts('https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js')
     importScripts('https://www.gstatic.com/firebasejs/12.9.0/firebase-messaging-compat.js')
     ```
   - Initialize Firebase with same config (must be hardcoded, not from env):
     ```javascript
     firebase.initializeApp({
       apiKey: "...",
       projectId: "emlak-danismani-ai",
       messagingSenderId: "...",
       appId: "..."
     })
     ```
   - Get messaging instance and handle background messages:
     ```javascript
     const messaging = firebase.messaging()

     messaging.onBackgroundMessage((payload) => {
       console.log('Background message:', payload)

       const notificationTitle = payload.notification?.title || 'Emlak AI'
       const notificationOptions = {
         body: payload.notification?.body || 'Yeni bildirim',
         icon: '/icon-192.png',
         badge: '/icon-192.png',
         data: payload.data
       }

       self.registration.showNotification(notificationTitle, notificationOptions)
     })
     ```

2. Handle notification click to open app:
   ```javascript
   self.addEventListener('notificationclick', (event) => {
     event.notification.close()

     const urlToOpen = event.notification.data?.url || '/'

     event.waitUntil(
       clients.matchAll({ type: 'window' }).then((windowClients) => {
         // Focus existing window or open new one
         for (const client of windowClients) {
           if (client.url === urlToOpen && 'focus' in client) {
             return client.focus()
           }
         }
         return clients.openWindow(urlToOpen)
       })
     )
   })
   ```

3. IMPORTANT: Firebase config values must be hardcoded in service worker (no import.meta.env access)
   - Read values from existing .env file
   - Document that these need to be updated if project changes
  </action>
  <verify>
    Service worker loads without errors in DevTools > Application > Service Workers
    Background notification received when app in background tab
    Clicking notification opens app
  </verify>
  <done>
    FCM service worker handles background notifications, click opens app
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Cloud Function triggers to send FCM notifications</name>
  <files>
    functions/src/triggers/onPropertyCreated.ts
    functions/src/triggers/onCustomerCreated.ts
    functions/src/index.ts
  </files>
  <action>
1. Update functions/src/triggers/onPropertyCreated.ts:
   - After creating in-app notification, check if user has FCM tokens
   - Query users/{userId}/fcmTokens collection
   - For each token, send FCM message:
     ```typescript
     import { getMessaging } from 'firebase-admin/messaging'

     const messaging = getMessaging()

     await messaging.send({
       token: fcmToken,
       notification: {
         title: `Yeni Mulk: ${propertyTitle}`,
         body: `${customerName} icin %${score} eslesen mulk eklendi`,
       },
       data: {
         type: 'property_match',
         propertyId,
         customerId,
         url: `/properties/${propertyId}`
       },
       webpush: {
         fcmOptions: {
           link: `/properties/${propertyId}`
         }
       }
     })
     ```
   - Handle token errors (remove invalid tokens from Firestore)
   - Fire-and-forget pattern (don't block on FCM send failures)

2. Update functions/src/triggers/onCustomerCreated.ts:
   - Same pattern: query FCM tokens, send notification
   - Title: "Yeni Musteri: {customerName}"
   - Body: "{N} eslesen mulk bulundu"
   - Link to customer detail page

3. Update functions/src/index.ts if needed to export messaging-related utilities

4. Handle errors gracefully:
   - messaging/invalid-registration-token: Delete token from Firestore
   - messaging/registration-token-not-registered: Delete token from Firestore
   - Other errors: Log and continue (don't fail the trigger)
  </action>
  <verify>
    cd functions && npm run build passes
    Create new property with matching customer - FCM notification received
    Create new customer with matching properties - FCM notification received
    Invalid tokens cleaned up from Firestore
  </verify>
  <done>
    Cloud Function triggers send FCM push notifications for match events
  </done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` and `cd functions && npm run build` exit 0
2. Permission flow: User prompted for notification permission, can grant/deny
3. Token storage: FCM token saved to Firestore after permission granted
4. Foreground: Notification shows as toast when app is open
5. Background: Push notification appears in system tray when app closed/minimized
6. Click action: Clicking notification opens app to relevant page
7. Match notification: Creating property triggers FCM to matching customers' tokens
</verification>

<success_criteria>
- FCM initialized in firebase.ts with messaging export
- useNotifications hook manages permission and token
- NotificationPermissionPrompt shows Turkish UI for enabling notifications
- firebase-messaging-sw.js handles background messages
- onPropertyCreated and onCustomerCreated triggers send FCM notifications
- Invalid FCM tokens cleaned up automatically
</success_criteria>

<output>
After completion, create `.planning/phases/06-mobile-pwa-sharing/06-04-SUMMARY.md`
</output>
