---
phase: 06-mobile-pwa-sharing
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/lib/firebase.ts
  - src/hooks/useOnlineStatus.ts
  - src/components/layout/OfflineBanner.tsx
  - src/stores/uploadStore.ts
  - src/App.tsx
autonomous: true
requirements:
  - MOBL-03
  - MOBL-04

must_haves:
  truths:
    - "User can view previously loaded properties while offline"
    - "User can view previously loaded customers while offline"
    - "Offline indicator banner appears when connection lost"
    - "Changes made offline sync automatically when connection restored"
    - "Upload state persists across page refreshes"
  artifacts:
    - path: "src/lib/firebase.ts"
      provides: "Firestore with persistentLocalCache enabled"
      contains: "persistentLocalCache"
    - path: "src/hooks/useOnlineStatus.ts"
      provides: "Reactive online/offline status hook"
      exports: ["useOnlineStatus"]
    - path: "src/components/layout/OfflineBanner.tsx"
      provides: "Offline notification banner"
      exports: ["OfflineBanner"]
    - path: "src/stores/uploadStore.ts"
      provides: "Upload state with IndexedDB persistence"
      contains: "persist"
  key_links:
    - from: "src/lib/firebase.ts"
      to: "firebase/firestore"
      via: "initializeFirestore with localCache"
      pattern: "initializeFirestore"
    - from: "src/App.tsx"
      to: "src/components/layout/OfflineBanner.tsx"
      via: "component import and render"
      pattern: "OfflineBanner"
    - from: "src/stores/uploadStore.ts"
      to: "idb-keyval"
      via: "persist middleware storage"
      pattern: "createJSONStorage"
---

<objective>
Enable offline data persistence using Firestore's persistentLocalCache and add offline status UI.

Purpose: Real estate agents often work in rural areas without reliable internet. They need to view property and customer data offline, and have changes sync when back online.

Output: Firestore caches data locally, offline banner shows connection status, upload state persists to IndexedDB.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mobile-pwa-sharing/06-RESEARCH.md
@.planning/phases/06-mobile-pwa-sharing/06-01-SUMMARY.md

# Existing files to modify
@src/lib/firebase.ts
@src/stores/uploadStore.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Firestore offline persistence with persistentLocalCache</name>
  <files>
    src/lib/firebase.ts
  </files>
  <action>
1. Update firebase.ts to use initializeFirestore instead of getFirestore:
   - Import initializeFirestore, persistentLocalCache from 'firebase/firestore'
   - Replace: `export const db = getFirestore(app)`
   - With:
     ```typescript
     export const db = initializeFirestore(app, {
       localCache: persistentLocalCache({})
     })
     ```
   - Use single-tab mode (simpler, no multi-tab flicker issues)
   - Keep emulator connection logic unchanged (emulator supports offline cache)

2. Important: Do NOT use the deprecated enableIndexedDbPersistence() API

3. Note: Firestore automatically:
   - Caches all read documents to IndexedDB
   - Queues writes when offline
   - Syncs when connection restored (last-write-wins)
  </action>
  <verify>
    npm run build passes
    App loads without Firestore initialization errors
    In DevTools Application > IndexedDB, firestore-related database appears after navigating to properties
  </verify>
  <done>
    Firestore uses persistent local cache, data available offline after initial load
  </done>
</task>

<task type="auto">
  <name>Task 2: Create online status hook and offline banner</name>
  <files>
    src/hooks/useOnlineStatus.ts
    src/components/layout/OfflineBanner.tsx
    src/App.tsx
  </files>
  <action>
1. Install idb-keyval (needed for next task, might as well do now):
   ```bash
   npm install idb-keyval
   ```

2. Create src/hooks/useOnlineStatus.ts:
   - Use navigator.onLine for initial state
   - Add event listeners for 'online' and 'offline' events
   - Clean up listeners on unmount
   - Return boolean isOnline

3. Create src/components/layout/OfflineBanner.tsx:
   - Use useOnlineStatus hook
   - When offline, show fixed banner at top of screen
   - Turkish text: "Cevrimdisi calisiyorsunuz. Degisiklikler baglanti kurulunca senkronize edilecek."
   - Styling: fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 z-50
   - Include wifi-off icon from lucide-react
   - Only show when offline (return null when online)

4. Add OfflineBanner to App.tsx:
   - Render at the root level, appears on all pages
   - Place before main content so it pushes content down when visible
  </action>
  <verify>
    npm run build passes
    In DevTools Network tab, toggle "Offline" mode
    Offline banner appears immediately when going offline
    Banner disappears when going back online
  </verify>
  <done>
    Offline banner shows "Cevrimdisi calisiyorsunuz" when connection lost, disappears when restored
  </done>
</task>

<task type="auto">
  <name>Task 3: Add IndexedDB persistence to upload store</name>
  <files>
    src/stores/uploadStore.ts
  </files>
  <action>
1. Update uploadStore.ts to persist state to IndexedDB:
   - Import persist, createJSONStorage from 'zustand/middleware'
   - Import get, set, del from 'idb-keyval'
   - Create custom storage adapter using idb-keyval:
     ```typescript
     import { StateStorage } from 'zustand/middleware'
     import { get, set, del } from 'idb-keyval'

     const idbStorage: StateStorage = {
       getItem: async (name) => (await get(name)) || null,
       setItem: async (name, value) => set(name, value),
       removeItem: async (name) => del(name),
     }
     ```
   - Wrap store with persist middleware:
     ```typescript
     export const useUploadStore = create<UploadState>()(
       persist(
         (set, get) => ({
           // existing store implementation
         }),
         {
           name: 'upload-store',
           storage: createJSONStorage(() => idbStorage),
         }
       )
     )
     ```

2. Keep all existing store logic unchanged, just wrap with persist

3. This ensures:
   - Upload progress survives page refresh
   - Pending uploads can resume after browser close/reopen
   - Works in service worker context (localStorage doesn't)
  </action>
  <verify>
    npm run build passes
    Start an upload, refresh the page, upload state still visible
    In DevTools Application > IndexedDB, 'upload-store' entry appears
  </verify>
  <done>
    Upload state persists to IndexedDB, survives page refresh and browser restart
  </done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` exits 0
2. Firestore offline: Toggle offline in DevTools, navigate to properties, data still loads from cache
3. Offline banner: Shows when offline, disappears when online
4. Upload persistence: Start upload, refresh page, upload state preserved
5. No console errors related to Firestore initialization or IndexedDB
</verification>

<success_criteria>
- Firestore uses initializeFirestore with persistentLocalCache
- Properties and customers viewable when offline (after initial load)
- Offline banner appears with Turkish text when connection lost
- Upload store persists to IndexedDB via idb-keyval
- Changes made offline sync when connection restored (Firestore handles automatically)
</success_criteria>

<output>
After completion, create `.planning/phases/06-mobile-pwa-sharing/06-02-SUMMARY.md`
</output>
