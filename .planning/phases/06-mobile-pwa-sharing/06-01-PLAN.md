---
phase: 06-mobile-pwa-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/pwa/ReloadPrompt.tsx
  - src/hooks/usePWAInstall.ts
  - src/components/layout/InstallPrompt.tsx
  - src/App.tsx
  - public/icon-192.png
  - public/icon-512.png
  - public/apple-touch-icon.png
  - index.html
autonomous: true
requirements:
  - MOBL-01
  - MOBL-02

must_haves:
  truths:
    - "App can be installed to home screen on Android/Chrome"
    - "App shows install prompt for eligible users"
    - "Installed app runs in standalone mode without browser chrome"
    - "Service worker update notification appears when new version available"
    - "App is responsive on mobile devices"
  artifacts:
    - path: "vite.config.ts"
      provides: "PWA plugin configuration with manifest and workbox"
      contains: "VitePWA"
    - path: "src/pwa/ReloadPrompt.tsx"
      provides: "Service worker update notification UI"
      exports: ["ReloadPrompt"]
    - path: "src/hooks/usePWAInstall.ts"
      provides: "PWA install prompt hook"
      exports: ["usePWAInstall"]
    - path: "src/components/layout/InstallPrompt.tsx"
      provides: "Install banner with iOS instructions fallback"
      exports: ["InstallPrompt"]
  key_links:
    - from: "vite.config.ts"
      to: "vite-plugin-pwa"
      via: "VitePWA plugin registration"
      pattern: "VitePWA\\("
    - from: "src/App.tsx"
      to: "src/pwa/ReloadPrompt.tsx"
      via: "component import"
      pattern: "ReloadPrompt"
    - from: "src/components/layout/InstallPrompt.tsx"
      to: "src/hooks/usePWAInstall.ts"
      via: "hook usage"
      pattern: "usePWAInstall"
---

<objective>
Set up PWA foundation with vite-plugin-pwa, service worker registration, and install prompt UI.

Purpose: Enable users to install the app on their phone home screen for a native-like experience. This is the foundation for all PWA features including offline support and push notifications.

Output: Working PWA that can be installed, with update notifications and responsive mobile design.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mobile-pwa-sharing/06-RESEARCH.md

# Existing files to modify
@vite.config.ts
@src/App.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure vite-plugin-pwa with manifest and service worker</name>
  <files>
    vite.config.ts
    public/icon-192.png
    public/icon-512.png
    public/apple-touch-icon.png
    index.html
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install vite-plugin-pwa workbox-window
   ```

2. Create PWA icons in public/:
   - icon-192.png (192x192, any maskable)
   - icon-512.png (512x512, any maskable)
   - apple-touch-icon.png (180x180, for iOS Safari)
   Use a simple house/building icon with app branding colors (sky-500 #0EA5E9 as background)

3. Update vite.config.ts to add VitePWA plugin:
   - registerType: 'prompt' (show update prompt to user)
   - manifest.name: 'Emlak Danismani AI'
   - manifest.short_name: 'Emlak AI'
   - manifest.theme_color: '#0EA5E9' (sky-500)
   - manifest.background_color: '#ffffff'
   - manifest.display: 'standalone'
   - manifest.orientation: 'portrait'
   - Icons array with both sizes
   - workbox.globPatterns for static assets
   - workbox.runtimeCaching for Firebase Storage images (CacheFirst, 30 days)
   - devOptions.enabled: true for development testing

4. Update index.html:
   - Add apple-touch-icon link
   - Add theme-color meta tag
   - Ensure viewport meta has width=device-width, initial-scale=1.0, viewport-fit=cover
  </action>
  <verify>
    npm run build completes without errors
    dist/manifest.webmanifest exists after build
    dist/sw.js exists after build
  </verify>
  <done>
    PWA manifest and service worker generated on build, icons present in public/
  </done>
</task>

<task type="auto">
  <name>Task 2: Create service worker update notification component</name>
  <files>
    src/pwa/ReloadPrompt.tsx
    src/App.tsx
  </files>
  <action>
1. Create src/pwa/ReloadPrompt.tsx following vite-plugin-pwa React pattern:
   - Import useRegisterSW from 'virtual:pwa-register/react'
   - Track offlineReady and needRefresh states
   - Show toast-style notification at bottom-right when update available
   - Turkish text: "Uygulama guncellendi" for offline ready, "Yeni versiyon mevcut" for update
   - "Yenile" button calls updateServiceWorker(true)
   - "Kapat" button dismisses notification
   - Use Tailwind classes: fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 z-50

2. Add TypeScript declaration for virtual module (if needed):
   - Add to src/vite-env.d.ts: declare module 'virtual:pwa-register/react'

3. Import and render ReloadPrompt in App.tsx:
   - Add at root level alongside other global components
   - Should render on all pages
  </action>
  <verify>
    npm run build passes
    ReloadPrompt component renders without errors in dev mode
    When service worker updates, notification appears (test by modifying code and rebuilding)
  </verify>
  <done>
    Service worker update notification appears when new version available, user can click to reload
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PWA install prompt hook and UI component</name>
  <files>
    src/hooks/usePWAInstall.ts
    src/components/layout/InstallPrompt.tsx
    src/App.tsx
  </files>
  <action>
1. Create src/hooks/usePWAInstall.ts:
   - Store beforeinstallprompt event in state
   - Track isInstallable (event received), isInstalled (display-mode: standalone)
   - Expose promptInstall() function that calls deferredPrompt.prompt()
   - Handle userChoice to track acceptance
   - Detect iOS with regex on userAgent
   - Return { isInstallable, isInstalled, isIOS, promptInstall }

2. Create src/components/layout/InstallPrompt.tsx:
   - Use usePWAInstall hook
   - Show banner at top of app when installable and not installed
   - For Chromium: Show "Uygulamayi Yukle" button
   - For iOS Safari: Show manual instructions "Paylas > Ana Ekrana Ekle"
   - Include dismiss button that sets localStorage flag to hide for 7 days
   - Turkish text throughout
   - Styling: fixed top-0 left-0 right-0 bg-sky-500 text-white p-3 z-40

3. Integrate InstallPrompt into App.tsx:
   - Render after header/navigation
   - Should only appear once per session until dismissed
  </action>
  <verify>
    npm run build passes
    In Chrome on Android (or Chrome DevTools mobile emulation), install banner appears
    Clicking "Yukle" triggers browser install prompt
    On iOS Safari, manual instructions shown
    Dismissing banner hides it for 7 days
  </verify>
  <done>
    Users see install prompt on eligible browsers, iOS users see manual instructions, dismissal persists
  </done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` exits 0
2. PWA assets generated: dist/manifest.webmanifest and dist/sw.js exist
3. Lighthouse PWA audit passes core checks (installable, icons, manifest)
4. Install prompt appears in Chrome mobile emulation
5. Update notification works when service worker changes
</verification>

<success_criteria>
- vite-plugin-pwa configured with Turkish manifest metadata
- Service worker registered with CacheFirst for images
- ReloadPrompt shows when update available
- InstallPrompt shows on eligible browsers with iOS fallback
- All icons present (192, 512, apple-touch-icon)
- App can be added to home screen in Chrome
</success_criteria>

<output>
After completion, create `.planning/phases/06-mobile-pwa-sharing/06-01-SUMMARY.md`
</output>
