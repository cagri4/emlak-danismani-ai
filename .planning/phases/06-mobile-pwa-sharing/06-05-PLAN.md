---
phase: 06-mobile-pwa-sharing
plan: 05
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - src/lib/share.ts
  - src/pages/properties/PropertySharePage.tsx
  - src/components/properties/ShareButton.tsx
  - src/components/properties/PropertyDetail.tsx
  - src/App.tsx
  - functions/src/http/generateShareImage.ts
  - functions/src/index.ts
autonomous: false
requirements:
  - ILET-01
  - ILET-02

must_haves:
  truths:
    - "User can share property to WhatsApp with one click"
    - "Shared link shows rich preview with photo, title, price"
    - "Share image is optimized for WhatsApp (1200x630px)"
    - "Contact link included in shared message"
    - "Web Share API used on supported devices"
  artifacts:
    - path: "src/lib/share.ts"
      provides: "WhatsApp sharing utilities"
      exports: ["shareToWhatsApp", "generateShareUrl"]
    - path: "src/pages/properties/PropertySharePage.tsx"
      provides: "Public property page with OG meta tags"
      exports: ["PropertySharePage"]
    - path: "src/components/properties/ShareButton.tsx"
      provides: "Share button component"
      exports: ["ShareButton"]
    - path: "functions/src/http/generateShareImage.ts"
      provides: "Dynamic OG image generator"
      exports: ["generateShareImage"]
  key_links:
    - from: "src/components/properties/ShareButton.tsx"
      to: "src/lib/share.ts"
      via: "shareToWhatsApp function"
      pattern: "shareToWhatsApp"
    - from: "src/pages/properties/PropertySharePage.tsx"
      to: "functions/src/http/generateShareImage.ts"
      via: "OG image URL reference"
      pattern: "og:image"
    - from: "src/components/properties/PropertyDetail.tsx"
      to: "src/components/properties/ShareButton.tsx"
      via: "component usage"
      pattern: "ShareButton"
---

<objective>
Implement WhatsApp sharing with rich preview cards for property listings.

Purpose: Real estate agents share property listings with clients via WhatsApp. Rich previews with photos and details increase click-through rates and look professional.

Output: Share button that opens WhatsApp with property link, public share page with Open Graph meta tags, and dynamic image generation for previews.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mobile-pwa-sharing/06-RESEARCH.md
@.planning/phases/06-mobile-pwa-sharing/06-01-SUMMARY.md
@.planning/phases/06-mobile-pwa-sharing/06-02-SUMMARY.md

# Existing property detail
@src/components/properties/PropertyDetail.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create share utilities and public share page</name>
  <files>
    src/lib/share.ts
    src/pages/properties/PropertySharePage.tsx
    src/App.tsx
  </files>
  <action>
1. Create src/lib/share.ts:
   - generateShareUrl(propertyId: string): string
     - Return: `${window.location.origin}/share/${propertyId}`
   - formatShareMessage(property): string
     - Format: "{title} - {price} TL\n{rooms}, {area}m2, {district}, {city}\n\n{url}"
     - Turkish formatting for price (2.000.000 TL)
   - shareToWhatsApp(property): void
     - Try Web Share API first (better mobile UX):
       ```typescript
       if (navigator.share) {
         await navigator.share({
           title: property.title,
           text: formatShareMessage(property),
           url: generateShareUrl(property.id)
         })
       } else {
         // Fallback to WhatsApp URL scheme
         const text = encodeURIComponent(formatShareMessage(property))
         window.open(`https://api.whatsapp.com/send?text=${text}`, '_blank')
       }
       ```
   - copyShareLink(propertyId): Promise<void>
     - Copy URL to clipboard using navigator.clipboard.writeText
     - Fallback to document.execCommand('copy') for older browsers

2. Create src/pages/properties/PropertySharePage.tsx:
   - Route: /share/:propertyId (public, no auth required)
   - Fetch property data from Firestore (need to add public read rule or use Cloud Function)
   - Render property card with:
     - Cover photo (large)
     - Title, price
     - Location (city, district)
     - Rooms, area
     - Contact button (WhatsApp link to agent)
   - Include react-helmet-async for dynamic meta tags:
     - og:title = property.title
     - og:description = "{rooms}, {area}m2, {price} TL"
     - og:image = dynamic image URL (from Cloud Function)
     - og:url = current URL
     - og:type = "website"
   - NOTE: Since this is a SPA, OG tags may not work for crawlers. Consider SSR or prerendering for production.

3. Add route to App.tsx:
   - Add /share/:propertyId route pointing to PropertySharePage
   - This route should not require authentication
  </action>
  <verify>
    npm run build passes
    /share/{propertyId} route loads and displays property
    Meta tags appear in document head
    Web Share API triggers on mobile
  </verify>
  <done>
    Share utilities created, public share page with OG tags, route registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dynamic share image generator Cloud Function</name>
  <files>
    functions/src/http/generateShareImage.ts
    functions/src/index.ts
  </files>
  <action>
1. Install sharp in functions (if not already):
   ```bash
   cd functions && npm install sharp canvas
   ```

2. Create functions/src/http/generateShareImage.ts:
   - HTTP Cloud Function: GET /generateShareImage?propertyId={id}&userId={userId}
   - Fetch property data from Firestore
   - Generate 1200x630px image using sharp:
     - Background: white or gradient
     - Property cover photo (resized to fit left side)
     - Text overlay on right side:
       - Title (bold, large)
       - Price (highlighted)
       - Location
       - Rooms/area
     - App logo/branding at bottom
   - Cache for 1 hour with Cache-Control header
   - Return image/jpeg content type

3. Alternative simpler approach (recommended for MVP):
   - Just return the property's cover photo resized to 1200x630
   - Skip text overlay for now (complex with sharp)
   - Can enhance later with canvas or Cloudinary

4. Export from functions/src/index.ts:
   ```typescript
   export { generateShareImage } from './http/generateShareImage'
   ```

5. Usage in PropertySharePage:
   - og:image = `https://{region}-{project}.cloudfunctions.net/generateShareImage?propertyId={id}&userId={userId}`
  </action>
  <verify>
    cd functions && npm run build passes
    Calling the function URL returns a JPEG image
    Image dimensions are 1200x630
    WhatsApp shows image preview when sharing link
  </verify>
  <done>
    Cloud Function generates share image from property cover photo
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ShareButton component and integrate into PropertyDetail</name>
  <files>
    src/components/properties/ShareButton.tsx
    src/components/properties/PropertyDetail.tsx
  </files>
  <action>
1. Create src/components/properties/ShareButton.tsx:
   - Props: property (Property type)
   - Dropdown menu with share options:
     - WhatsApp share (primary, prominent)
     - Copy link
     - Native share (if supported)
   - Use lucide-react icons: Share2, MessageCircle, Copy, Link
   - Turkish labels: "WhatsApp'ta Paylas", "Linki Kopyala", "Paylas"
   - Show toast on successful copy
   - Styling: Green WhatsApp-colored button or icon button
   - For dropdown, can use simple state toggle or existing UI component

2. Integrate into PropertyDetail.tsx:
   - Add ShareButton next to edit/delete actions
   - Position in header area of property detail
   - Pass property object to ShareButton

3. Share button states:
   - Default: Share icon
   - Hover: Show dropdown
   - Click WhatsApp: Opens WhatsApp or Web Share
   - Click Copy: Copies link, shows success toast
  </action>
  <verify>
    npm run build passes
    ShareButton appears on property detail page
    Clicking WhatsApp option opens share dialog
    Clicking copy link copies URL and shows toast
    Toast shows Turkish confirmation: "Link kopyalandi"
  </verify>
  <done>
    ShareButton with WhatsApp and copy options integrated into PropertyDetail
  </done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` and `cd functions && npm run build` exit 0
2. Share page: /share/{propertyId} shows property publicly
3. OG tags: Inspect page source, og:image/title/description present
4. WhatsApp share: Opens WhatsApp with formatted message
5. Copy link: Copies URL, shows toast confirmation
6. Share image: Cloud Function returns resized property photo
7. Rich preview: Pasting share link in WhatsApp shows image preview (may require deployed URL for testing)
</verification>

<success_criteria>
- shareToWhatsApp uses Web Share API with WhatsApp fallback
- PropertySharePage displays property publicly at /share/{propertyId}
- OG meta tags set for rich link previews
- generateShareImage Cloud Function produces 1200x630 JPEG
- ShareButton dropdown with WhatsApp and copy link options
- Turkish UI labels throughout
- Share button visible on property detail page
</success_criteria>

<output>
After completion, create `.planning/phases/06-mobile-pwa-sharing/06-05-SUMMARY.md`
</output>
