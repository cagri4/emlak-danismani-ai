---
phase: 06-mobile-pwa-sharing
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/hooks/useCamera.ts
  - src/components/photos/CameraCapture.tsx
  - src/components/photos/PhotoUploader.tsx
autonomous: true
requirements:
  - MOBL-05

must_haves:
  truths:
    - "User can capture photo with phone camera directly in app"
    - "User can switch between front and rear camera"
    - "Captured photo is compressed before upload"
    - "Camera feature falls back to file input on unsupported devices"
    - "Photos upload to existing Firebase Storage infrastructure"
  artifacts:
    - path: "src/hooks/useCamera.ts"
      provides: "Camera access hook with capture functionality"
      exports: ["useCamera"]
    - path: "src/components/photos/CameraCapture.tsx"
      provides: "Camera viewfinder and capture UI"
      exports: ["CameraCapture"]
    - path: "src/components/photos/PhotoUploader.tsx"
      provides: "Updated photo uploader with camera option"
      contains: "CameraCapture"
  key_links:
    - from: "src/hooks/useCamera.ts"
      to: "navigator.mediaDevices.getUserMedia"
      via: "camera stream access"
      pattern: "getUserMedia"
    - from: "src/components/photos/CameraCapture.tsx"
      to: "src/hooks/useCamera.ts"
      via: "hook usage"
      pattern: "useCamera"
    - from: "src/components/photos/PhotoUploader.tsx"
      to: "src/components/photos/CameraCapture.tsx"
      via: "component integration"
      pattern: "CameraCapture"
---

<objective>
Enable mobile camera capture for property photo uploads with client-side compression.

Purpose: Real estate agents take property photos on-site with their phones. Direct camera capture is faster than gallery selection and ensures fresh, high-quality images.

Output: Camera capture UI with viewfinder, front/rear toggle, compression, integrated into existing photo upload flow.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mobile-pwa-sharing/06-RESEARCH.md
@.planning/phases/06-mobile-pwa-sharing/06-01-SUMMARY.md

# Existing photo upload infrastructure
@src/components/photos/PhotoUploader.tsx
@src/hooks/usePhotoUpload.ts
@src/stores/uploadStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create camera access hook with capture functionality</name>
  <files>
    src/hooks/useCamera.ts
  </files>
  <action>
1. Install browser-image-compression:
   ```bash
   npm install browser-image-compression
   ```

2. Create src/hooks/useCamera.ts:
   - State: stream (MediaStream | null), isActive (boolean), facingMode ('user' | 'environment'), error (string | null)
   - startCamera(facing?: 'user' | 'environment'): async function
     - Request camera with navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false })
     - Store stream in state
     - Handle errors: NotAllowedError (permission denied), NotFoundError (no camera)
   - stopCamera(): stop all tracks, clear stream state
   - switchCamera(): toggle facingMode, restart stream
   - capturePhoto(): async function
     - Create video element, attach stream, play
     - Create canvas at video dimensions
     - Draw video frame to canvas
     - Convert to blob with canvas.toBlob('image/jpeg', 0.85)
     - Stop camera after capture
     - Compress using browser-image-compression:
       ```typescript
       import imageCompression from 'browser-image-compression'
       const compressed = await imageCompression(file, {
         maxSizeMB: 0.5,
         maxWidthOrHeight: 1920,
         useWebWorker: true
       })
       ```
     - Return compressed File object
   - isSupported: boolean (check if getUserMedia exists)
   - Export: { stream, isActive, facingMode, error, startCamera, stopCamera, switchCamera, capturePhoto, isSupported }

3. Handle HTTPS requirement:
   - getUserMedia requires HTTPS (except localhost)
   - Return helpful error message if not HTTPS
  </action>
  <verify>
    npm run build passes
    Hook exports all expected functions and state
    TypeScript types are correct
  </verify>
  <done>
    useCamera hook provides camera access, capture, compression functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Create camera capture UI component</name>
  <files>
    src/components/photos/CameraCapture.tsx
  </files>
  <action>
1. Create src/components/photos/CameraCapture.tsx:
   - Props: onCapture(file: File), onClose()
   - Use useCamera hook
   - Full-screen modal overlay when active
   - Video element displaying camera stream
   - Controls at bottom:
     - Large circular capture button (center)
     - Camera switch button (left) - shows only if multiple cameras
     - Close/cancel button (right)
   - Turkish labels: "Cek" (capture), "Kapat" (close)
   - Loading state while camera initializing
   - Error state with Turkish messages:
     - "Kamera izni reddedildi" for NotAllowedError
     - "Kamera bulunamadi" for NotFoundError
     - "Kamera icin HTTPS gerekli" for non-secure context
   - Styling:
     - Fixed inset-0 bg-black z-50
     - Video: object-cover w-full h-full
     - Controls: absolute bottom-8 left-0 right-0 flex justify-center items-center gap-8
     - Capture button: w-16 h-16 rounded-full bg-white border-4 border-gray-300

2. Clean up camera stream on unmount

3. Show flash animation on capture (brief white overlay)
  </action>
  <verify>
    npm run build passes
    Component renders camera viewfinder when opened
    Capture button takes photo and calls onCapture
    Camera switch toggles between front/rear
    Close button stops camera and closes modal
  </verify>
  <done>
    Full-screen camera UI with viewfinder, capture, switch, and close functionality
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate camera capture into PhotoUploader</name>
  <files>
    src/components/photos/PhotoUploader.tsx
  </files>
  <action>
1. Update PhotoUploader.tsx to add camera option:
   - Import CameraCapture component
   - Add state: showCamera (boolean)
   - Add camera button next to existing upload area:
     - Camera icon (lucide-react)
     - Text: "Fotograf Cek"
     - Only show if useCamera().isSupported is true
   - When camera button clicked, set showCamera = true
   - Render CameraCapture as modal when showCamera is true
   - onCapture handler:
     - Receive File from CameraCapture
     - Add to files array same as drag-drop
     - Trigger upload using existing usePhotoUpload hook
     - Close camera modal
   - onClose handler:
     - Set showCamera = false

2. Layout update:
   - Existing drop zone on left/top
   - Camera button on right/bottom (or in drop zone as secondary action)
   - On mobile: camera button more prominent

3. Add HTML5 file input fallback for camera:
   - If getUserMedia not supported, show:
   - `<input type="file" accept="image/*" capture="environment">`
   - This opens native camera on mobile devices
  </action>
  <verify>
    npm run build passes
    PhotoUploader shows camera button on supported devices
    Clicking camera opens CameraCapture modal
    Captured photo appears in upload queue
    Photo uploads to Firebase Storage correctly
    On unsupported devices, file input with capture attribute shown
  </verify>
  <done>
    PhotoUploader integrates camera capture, photos compress and upload through existing infrastructure
  </done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` exits 0
2. Camera permission: Requesting camera shows browser permission prompt
3. Viewfinder: Camera stream displays in full-screen modal
4. Capture: Taking photo captures current frame, compresses it
5. Upload: Captured photo uploads through existing photo upload infrastructure
6. Fallback: On desktop or unsupported browsers, file input appears
7. Compression: Original 4MB+ phone photos compress to <500KB
</verification>

<success_criteria>
- useCamera hook provides camera access, capture, and compression
- CameraCapture component shows full-screen viewfinder with controls
- PhotoUploader integrates camera option alongside drag-drop
- Captured photos compress to max 500KB before upload
- Fallback to file input with capture attribute on unsupported devices
- Turkish UI labels throughout
</success_criteria>

<output>
After completion, create `.planning/phases/06-mobile-pwa-sharing/06-03-SUMMARY.md`
</output>
