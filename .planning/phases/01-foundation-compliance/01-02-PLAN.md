---
phase: 01-foundation-compliance
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/pages/KVKKConsent.tsx
  - src/components/auth/KVKKModal.tsx
  - src/hooks/useKVKKConsent.ts
  - src/types/property.ts
  - src/lib/validations.ts
  - src/hooks/useProperties.ts
  - src/pages/PropertyAdd.tsx
  - src/pages/PropertyEdit.tsx
  - src/pages/PropertyDetail.tsx
  - src/components/property/PropertyForm.tsx
  - src/components/auth/ProtectedRoute.tsx
  - src/pages/Settings.tsx
autonomous: true
requirements:
  - ALTI-04
  - MULK-01
  - MULK-02
  - MULK-03
  - MULK-04

must_haves:
  truths:
    - "User must accept KVKK consent on first login to access system"
    - "User can scroll through KVKK text and only then accept"
    - "User who rejects KVKK cannot access system"
    - "User can manage KVKK preferences from settings"
    - "User can add a new property with type, location, price, rooms, area, features"
    - "User can edit existing property details"
    - "User can delete a property"
    - "User can change property status (aktif/opsiyonlu/satildi/kiralandı)"
  artifacts:
    - path: "src/pages/KVKKConsent.tsx"
      provides: "KVKK consent page with scroll-to-enable"
      min_lines: 60
    - path: "src/hooks/useKVKKConsent.ts"
      provides: "KVKK consent state management"
      exports: ["useKVKKConsent"]
    - path: "src/types/property.ts"
      provides: "Property type definitions"
      exports: ["Property", "PropertyStatus", "PropertyType"]
    - path: "src/hooks/useProperties.ts"
      provides: "Property CRUD operations"
      exports: ["useProperties"]
    - path: "src/components/property/PropertyForm.tsx"
      provides: "Reusable property form for add/edit"
      min_lines: 100
  key_links:
    - from: "src/pages/KVKKConsent.tsx"
      to: "firestore"
      via: "setDoc to users/{userId}.kvkkConsent"
      pattern: "setDoc.*kvkkConsent"
    - from: "src/hooks/useProperties.ts"
      to: "firestore"
      via: "collection users/{userId}/properties"
      pattern: "users.*properties"
    - from: "src/components/auth/ProtectedRoute.tsx"
      to: "useKVKKConsent"
      via: "redirect to /kvkk if consent not given"
      pattern: "needsConsent.*kvkk"
---

<objective>
Implement KVKK consent flow and property CRUD operations with Firestore.

Purpose: KVKK compliance is mandatory for Turkish market - users cannot proceed without accepting. Property CRUD is the core functionality that all other features build upon.

Output: KVKK consent modal with scroll-to-enable, settings page for consent management, complete property create/read/update/delete functionality.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-compliance/01-RESEARCH.md
@.planning/phases/01-foundation-compliance/01-CONTEXT.md
@.planning/phases/01-foundation-compliance/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement KVKK Consent Flow</name>
  <files>
    src/pages/KVKKConsent.tsx
    src/components/auth/KVKKModal.tsx
    src/hooks/useKVKKConsent.ts
    src/components/auth/ProtectedRoute.tsx
    src/pages/Settings.tsx
    src/App.tsx
  </files>
  <action>
Create src/hooks/useKVKKConsent.ts:
- Check if user has kvkkConsent in Firestore /users/{userId}
- Return { needsConsent: boolean, saveConsent: () => Promise, consentData: object | null }
- saveConsent saves: { acceptedAt: serverTimestamp(), version: '1.0' }

Create src/pages/KVKKConsent.tsx (per user decision: scroll-to-enable, mandatory):
- Full KVKK "Aydınlatma Metni" in Turkish (proper legal text about data processing)
- Scrollable container with ref to track scroll position
- "Okudum, Kabul Ediyorum" button - DISABLED until user scrolls to bottom
- Visual indicator: "Sonuna kadar kaydırın" text when button disabled
- On accept: call saveConsent(), redirect to /dashboard
- NO reject button - show only text: "KVKK onayı zorunludur. Kabul etmezseniz sistemi kullanamazsınız."
- Optional: "Çıkış Yap" link for users who don't want to accept

Update src/components/auth/ProtectedRoute.tsx:
- After auth check and email verification check, add KVKK consent check
- Use useKVKKConsent hook
- If needsConsent is true, redirect to /kvkk
- Render children only when all checks pass

Create src/pages/Settings.tsx (per user decision: manage permissions later):
- Page accessible from dashboard/header
- Section: "KVKK İzinleri"
- Show when consent was given: "Onay tarihi: {date}"
- "İzinlerimi Güncelle" button opens modal to view/modify consents
- For now, only show informational text (actual permission toggles in future phase)
- Section: "Hesap Bilgileri" - show user email, name

Update src/App.tsx:
- Add /kvkk route pointing to KVKKConsent.tsx
- Add /settings route (protected)
  </action>
  <verify>
1. Log in with new user - automatically redirected to /kvkk
2. Try clicking accept button before scrolling - button disabled
3. Scroll to bottom - button becomes enabled
4. Accept - redirected to /dashboard
5. Refresh page - goes directly to dashboard (consent saved)
6. Visit /settings - see KVKK consent date
  </verify>
  <done>
KVKK consent flow blocks access until accepted. Scroll-to-enable prevents blind acceptance. Consent stored in Firestore with timestamp. Settings page shows consent status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define Property Types and Schemas</name>
  <files>
    src/types/property.ts
    src/lib/validations.ts
  </files>
  <action>
Create src/types/property.ts:
```typescript
export type PropertyType = 'daire' | 'villa' | 'arsa' | 'işyeri' | 'müstakil' | 'rezidans';

export type PropertyStatus = 'aktif' | 'opsiyonlu' | 'satıldı' | 'kiralandı';

export type ListingType = 'satılık' | 'kiralık';

export interface PropertyLocation {
  city: string;
  district: string;
  neighborhood?: string;
}

export interface Property {
  id: string;
  title: string;
  type: PropertyType;
  listingType: ListingType;
  status: PropertyStatus;
  price: number;
  location: PropertyLocation;
  area: number; // m²
  rooms?: string; // e.g., "3+1", "2+1", "stüdyo"
  floor?: number;
  totalFloors?: number;
  buildingAge?: number;
  features: string[];
  description?: string;
  aiDescription?: string;
  imageUrl?: string; // Optional - Phase 3 will add uploads
  createdAt: Date;
  updatedAt: Date;
  userId: string;
}

// For form handling (without id and timestamps)
export type PropertyFormData = Omit<Property, 'id' | 'createdAt' | 'updatedAt' | 'userId'>;
```

Update src/lib/validations.ts - add propertySchema:
```typescript
export const propertySchema = z.object({
  title: z.string().min(10, 'Başlık en az 10 karakter olmalı').max(100),
  type: z.enum(['daire', 'villa', 'arsa', 'işyeri', 'müstakil', 'rezidans']),
  listingType: z.enum(['satılık', 'kiralık']),
  status: z.enum(['aktif', 'opsiyonlu', 'satıldı', 'kiralandı']).default('aktif'),
  price: z.number().positive('Fiyat pozitif olmalı'),
  location: z.object({
    city: z.string().min(1, 'Şehir zorunlu'),
    district: z.string().min(1, 'İlçe zorunlu'),
    neighborhood: z.string().optional(),
  }),
  area: z.number().positive('Alan pozitif olmalı'),
  rooms: z.string().optional(), // "3+1", "2+1" etc
  floor: z.number().int().optional(),
  totalFloors: z.number().int().optional(),
  buildingAge: z.number().int().min(0).optional(),
  features: z.array(z.string()).default([]),
  description: z.string().optional(),
  imageUrl: z.string().url().optional().or(z.literal('')),
});

export type PropertyFormData = z.infer<typeof propertySchema>;
```

Define common Turkish cities list for dropdown (top 20 cities).
Define common property features list in Turkish (asansör, otopark, güvenlik, havuz, etc.).
  </action>
  <verify>
TypeScript compiles without errors.
Property types cover all required fields from user decisions (tip, konum, fiyat, oda sayısı, m², özellikler).
Zod schema validates all fields correctly.
  </verify>
  <done>
Property and PropertyFormData types defined. Zod validation schema with Turkish error messages. Type-safe foundation for property CRUD operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Property CRUD with Firestore</name>
  <files>
    src/hooks/useProperties.ts
    src/components/property/PropertyForm.tsx
    src/pages/PropertyAdd.tsx
    src/pages/PropertyEdit.tsx
    src/pages/PropertyDetail.tsx
    src/App.tsx
  </files>
  <action>
Create src/hooks/useProperties.ts:
- Hook that takes userId from useAuth
- addProperty(data: PropertyFormData) -> adds to users/{userId}/properties with serverTimestamp
- updateProperty(propertyId, data: Partial<PropertyFormData>) -> updates document
- deleteProperty(propertyId) -> deletes document with confirmation
- updateStatus(propertyId, status: PropertyStatus) -> quick status update
- getProperties(filters?: { status?, type?, listingType? }) -> query with optional filters
- getProperty(propertyId) -> single document fetch
- useRealtime: boolean option for onSnapshot listener vs one-time fetch
- Return { properties, loading, error, addProperty, updateProperty, deleteProperty, updateStatus, refetch }

Create src/components/property/PropertyForm.tsx:
- Reusable form for both add and edit
- Props: { defaultValues?: PropertyFormData, onSubmit: (data) => Promise, isLoading: boolean }
- Fields organized in sections:
  - Temel Bilgiler: title, type (select), listingType (radio: satılık/kiralık)
  - Konum: city (select from Turkish cities), district (input), neighborhood (optional input)
  - Detaylar: price (number with TL suffix), area (number with m² suffix), rooms (select: stüdyo, 1+0, 1+1, 2+1, 3+1, 4+1, 5+1, 6+), floor, totalFloors, buildingAge
  - Özellikler: multi-select checkboxes for common features (asansör, otopark, güvenlik, havuz, balkon, teras, eşyalı, klima, doğalgaz)
  - Açıklama: textarea for manual description
  - Durum: status select (only shown in edit mode)
- Use React Hook Form + Zod resolver
- Turkish labels and error messages
- Submit button: "Kaydet" for edit, "Mülk Ekle" for add

Create src/pages/PropertyAdd.tsx:
- Page title: "Yeni Mülk Ekle"
- Render PropertyForm with onSubmit calling addProperty
- On success: show toast "Mülk eklendi", redirect to /properties

Create src/pages/PropertyEdit.tsx:
- Fetch property by ID from URL params
- Page title: "Mülk Düzenle"
- Render PropertyForm with defaultValues and onSubmit calling updateProperty
- On success: show toast "Mülk güncellendi", redirect to /properties/:id

Create src/pages/PropertyDetail.tsx:
- Fetch property by ID from URL params
- Display all property information in readable format
- Action buttons: "Düzenle" (link to edit), "Sil" (with confirmation dialog)
- Status change dropdown (quick status update without going to edit)
- Delete confirmation: "Bu mülkü silmek istediğinizden emin misiniz?"
- On delete: redirect to /properties

Update src/App.tsx:
- Add routes: /properties/new, /properties/:id, /properties/:id/edit
  </action>
  <verify>
1. Navigate to /properties/new - see property form
2. Fill form and submit - property created, redirected
3. Navigate to /properties/:id - see property details
4. Click "Düzenle" - see edit form with pre-filled values
5. Change status from dropdown - status updates immediately
6. Click "Sil" and confirm - property deleted
7. Verify in Firestore console: documents created under users/{userId}/properties
  </verify>
  <done>
Property form handles both create and edit. CRUD operations work via Firestore. Status changes via dropdown on detail page. Delete with confirmation. All operations scoped to authenticated user.
  </done>
</task>

</tasks>

<verification>
1. New user flow: register -> verify email -> KVKK consent -> dashboard
2. KVKK consent: scroll requirement works, button disabled until bottom reached
3. Add property: form validates, creates Firestore document
4. Edit property: loads existing data, updates document
5. Delete property: confirmation shown, document deleted
6. Status change: dropdown on detail page updates status immediately
7. Firestore rules: cannot access other users' properties (test with Firebase emulator)
</verification>

<success_criteria>
- KVKK consent blocks access until accepted with scroll-to-enable
- Consent stored in Firestore with timestamp
- Settings page shows consent date
- Property form validates all required fields with Turkish messages
- Properties stored under users/{userId}/properties in Firestore
- CRUD operations work: create, read, update, delete
- Status can be changed to aktif/opsiyonlu/satıldı/kiralandı
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-02-SUMMARY.md`
</output>
