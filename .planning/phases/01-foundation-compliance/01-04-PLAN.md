---
phase: 01-foundation-compliance
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - firestore.indexes.json
autonomous: true
requirements: [MULK-03]
gap_closure: true

must_haves:
  truths:
    - "Property filtering by city works without Firestore errors"
    - "Property filtering by status works without Firestore errors"
    - "Property filtering by type works without Firestore errors"
    - "Property filtering by listingType works without Firestore errors"
  artifacts:
    - path: "firestore.indexes.json"
      provides: "Composite indexes for filtered queries"
      contains: "location.city"
  key_links:
    - from: "src/hooks/useProperties.ts"
      to: "Firestore"
      via: "composite index"
      pattern: "where.*orderBy"
---

<objective>
Add missing Firestore composite indexes to fix property filtering errors.

Purpose: The property list filtering fails when combining where() clauses (city, status, type, listingType) with orderBy('createdAt') because Firestore requires composite indexes for such queries. The firestore.indexes.json file is currently empty.

Output: Updated firestore.indexes.json with all required composite indexes deployed to Firebase.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-compliance/01-UAT.md
@src/hooks/useProperties.ts
@firestore.indexes.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add composite indexes to firestore.indexes.json</name>
  <files>firestore.indexes.json</files>
  <action>
Update firestore.indexes.json with composite indexes for all filter + orderBy combinations used in useProperties.ts.

The collection path is `users/{userId}/properties` (subcollection).

Required indexes (each combining a filter field with createdAt descending):

1. `location.city` + `createdAt` (DESC) - for city filter
2. `status` + `createdAt` (DESC) - for status filter
3. `type` + `createdAt` (DESC) - for property type filter
4. `listingType` + `createdAt` (DESC) - for listing type filter

Each index needs:
- collectionGroup: "properties" (for subcollection queries)
- queryScope: "COLLECTION"
- fields array with the filter field (ASCENDING) and createdAt (DESCENDING)

Example structure for one index:
```json
{
  "collectionGroup": "properties",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "location.city", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```
  </action>
  <verify>
Validate JSON syntax: `cat firestore.indexes.json | jq .`
Confirm 4 indexes are defined: `cat firestore.indexes.json | jq '.indexes | length'` returns 4
  </verify>
  <done>firestore.indexes.json contains 4 composite indexes covering all filter combinations in useProperties.ts</done>
</task>

<task type="auto">
  <name>Task 2: Deploy indexes to Firebase</name>
  <files>firestore.indexes.json</files>
  <action>
Deploy the Firestore indexes using Firebase CLI:

```bash
firebase deploy --only firestore:indexes
```

This will create the composite indexes in Firebase. Note: Index creation can take several minutes to complete in the background. The deploy command will succeed immediately, but the indexes will show as "Building" status until ready.

If firebase CLI is not logged in, the user will need to run `firebase login` first.
  </action>
  <verify>
Run `firebase deploy --only firestore:indexes` and confirm it completes without errors.
After deployment, the indexes will be visible in Firebase Console under Firestore > Indexes.
  </verify>
  <done>Firestore indexes deployed successfully. Property filtering with city, status, type, and listingType will work once indexes finish building (typically 2-5 minutes).</done>
</task>

</tasks>

<verification>
1. JSON syntax valid: `cat firestore.indexes.json | jq .` exits 0
2. Index count correct: `cat firestore.indexes.json | jq '.indexes | length'` returns 4
3. Firebase deploy succeeds: `firebase deploy --only firestore:indexes` exits 0
4. Manual test: In the app, apply a city filter to the property list - should load without "Mulkler yuklenirken hata olustu" error (may need to wait 2-5 min for index to build)
</verification>

<success_criteria>
- firestore.indexes.json contains 4 composite indexes
- Indexes deployed to Firebase
- Property filtering by city no longer throws Firestore error
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-04-SUMMARY.md`
</output>
