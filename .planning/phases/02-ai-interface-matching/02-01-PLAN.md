---
phase: 02-ai-interface-matching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/customer.ts
  - src/hooks/useCustomers.ts
  - src/lib/validations.ts
  - src/pages/Customers.tsx
  - src/pages/CustomerAdd.tsx
  - src/pages/CustomerDetail.tsx
  - src/components/customer/CustomerForm.tsx
  - src/components/customer/CustomerCard.tsx
  - src/App.tsx
  - src/components/layout/Sidebar.tsx
autonomous: true
requirements:
  - MUST-01
  - MUST-02
  - MUST-03
  - MUST-04

must_haves:
  truths:
    - "User can add a customer with just a name"
    - "User can add customer preferences (location, budget, type)"
    - "User can add notes to a customer"
    - "System logs customer interactions with timestamps"
    - "Customer list shows all customers with quick view"
  artifacts:
    - path: "src/types/customer.ts"
      provides: "Customer, CustomerPreferences, Interaction types"
      contains: "interface Customer"
    - path: "src/hooks/useCustomers.ts"
      provides: "Customer CRUD operations with Firestore"
      exports: ["useCustomers"]
    - path: "src/pages/Customers.tsx"
      provides: "Customer list page"
      min_lines: 50
    - path: "src/pages/CustomerDetail.tsx"
      provides: "Customer detail with notes and interactions"
      min_lines: 100
  key_links:
    - from: "src/hooks/useCustomers.ts"
      to: "firestore"
      via: "collection users/{userId}/customers"
      pattern: "collection.*customers"
    - from: "src/pages/CustomerDetail.tsx"
      to: "src/hooks/useCustomers.ts"
      via: "useCustomers hook"
      pattern: "useCustomers"
---

<objective>
Create customer management foundation with Firestore persistence, enabling users to add customers with minimal data (just name), manage preferences, add notes, and track interaction history.

Purpose: Customer data is required for the matching engine and conversational AI. This plan establishes the data layer and basic UI for customer management.
Output: Customer types, Firestore hooks, customer CRUD pages, sidebar navigation update.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-interface-matching/02-RESEARCH.md
@.planning/phases/01-foundation-compliance/01-02-SUMMARY.md

# Existing code patterns to follow
@src/types/property.ts
@src/hooks/useProperties.ts
@src/pages/Properties.tsx
@src/pages/PropertyDetail.tsx
@src/components/property/PropertyForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Customer Types and Firestore Hook</name>
  <files>
    src/types/customer.ts
    src/hooks/useCustomers.ts
    src/lib/validations.ts
  </files>
  <action>
Create customer type definitions following the property pattern from Phase 1:

**src/types/customer.ts:**
```typescript
export interface CustomerPreferences {
  location: string[];        // Cities/districts interested in
  budget: {
    min: number;
    max: number;
  };
  propertyType: string[];    // daire, villa, arsa, etc
  rooms?: string[];          // 2+1, 3+1, etc
  minArea?: number;
  maxArea?: number;
  urgency: 'low' | 'medium' | 'high';
  notes?: string;            // Free-form preference notes
}

export interface Interaction {
  id: string;
  type: 'chat_message' | 'phone_call' | 'property_shown' | 'note' | 'match_result';
  content: string;
  propertyId?: string;       // If interaction involves a property
  conversationId?: string;   // If from chat
  timestamp: Date;
  metadata?: Record<string, any>;
}

export interface Customer {
  id: string;
  name: string;
  phone?: string;
  email?: string;
  preferences: CustomerPreferences;
  interactionCount: number;  // Denormalized for quick display
  lastInteraction?: Date;
  createdAt: Date;
  updatedAt: Date;
  userId: string;
}

export type CustomerFormData = Omit<Customer, 'id' | 'createdAt' | 'updatedAt' | 'userId' | 'interactionCount' | 'lastInteraction'>;
```

**src/hooks/useCustomers.ts:**
Create hook following useProperties pattern:
- addCustomer(data) - minimum required: name only, others optional
- updateCustomer(id, data) - partial update
- deleteCustomer(id)
- getCustomer(id) - single fetch
- addInteraction(customerId, interaction) - add to subcollection, update interactionCount
- getInteractions(customerId, limit) - fetch recent interactions
- Real-time listener for customers list
- Store in users/{userId}/customers subcollection
- Interactions in users/{userId}/customers/{customerId}/interactions

**src/lib/validations.ts:**
Add customerSchema with Zod:
- name: required, min 2 chars
- phone: optional, Turkish phone format
- email: optional, valid email
- preferences.location: array of strings
- preferences.budget: min/max positive numbers
- preferences.urgency: enum
- Turkish error messages
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Types are exported correctly
- Hook exports all required functions
  </verify>
  <done>
- Customer and Interaction types defined
- useCustomers hook provides CRUD + interaction methods
- Validation schema ready with Turkish messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Customer Pages and Components</name>
  <files>
    src/components/customer/CustomerCard.tsx
    src/components/customer/CustomerForm.tsx
    src/pages/Customers.tsx
    src/pages/CustomerAdd.tsx
    src/pages/CustomerDetail.tsx
  </files>
  <action>
Create customer UI components following property page patterns:

**src/components/customer/CustomerCard.tsx:**
- Display customer name, phone, email
- Show preference summary (budget range, locations)
- Urgency indicator (color-coded: green low, yellow medium, red high)
- Last interaction date
- Click navigates to detail page

**src/components/customer/CustomerForm.tsx:**
- Reusable for add/edit modes
- Sections:
  1. Temel Bilgiler: name (required), phone, email
  2. Tercihler: location (multi-select), budget (min/max), property type (multi-select), rooms (multi-select), area range
  3. Aciliyet: urgency radio (Düşük/Orta/Yüksek)
  4. Notlar: free-form textarea for preference notes
- React Hook Form + Zod validation
- Turkish labels throughout

**src/pages/Customers.tsx:**
- Grid display of CustomerCards
- Empty state: "Henüz müşteri eklenmemiş"
- "Yeni Müşteri Ekle" button
- Real-time updates via useCustomers

**src/pages/CustomerAdd.tsx:**
- Render CustomerForm
- On submit: addCustomer, redirect to /customers
- Back button

**src/pages/CustomerDetail.tsx:**
- Customer info display
- Preferences section with all details
- Interaction timeline (chronological list)
- "Not Ekle" button with inline form
- Quick actions: Edit, Delete (with confirmation)
- Display match history if any
  </action>
  <verify>
- `npm run build` succeeds
- Navigate to /customers shows empty state
- Add customer form renders all fields
- Customer detail page layout correct
  </verify>
  <done>
- Customer cards display in grid
- Add customer creates document in Firestore
- Customer detail shows info and interactions
- Notes can be added to customers
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Routes and Navigation</name>
  <files>
    src/App.tsx
    src/components/layout/Sidebar.tsx
  </files>
  <action>
**src/components/layout/Sidebar.tsx:**
Add "Müşteriler" navigation item:
- Icon: Users from lucide-react
- Path: /customers
- Position: after "Mülkler" in navigation

**src/App.tsx:**
Add routes:
- /customers - Customers list page
- /customers/new - CustomerAdd page
- /customers/:id - CustomerDetail page
- /customers/:id/edit - CustomerEdit page (reuse CustomerAdd with edit mode)

All routes protected with ProtectedRoute wrapper.
  </action>
  <verify>
- Sidebar shows "Müşteriler" link
- Clicking navigates to /customers
- All customer routes accessible when authenticated
- `npm run dev` shows no console errors
  </verify>
  <done>
- Navigation includes customer section
- All customer routes work
- Customer CRUD flow complete
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` succeeds without errors
2. `npx tsc --noEmit` passes
3. Navigate to /customers shows list (empty initially)
4. Add customer with just name works
5. Add customer with full preferences works
6. Customer detail shows all info
7. Adding note creates interaction in timeline
8. Edit customer updates Firestore
9. Delete customer removes from list
</verification>

<success_criteria>
- Customer can be added with just name (MUST-01)
- Customer preferences can be saved (MUST-02)
- Notes can be added to customer (MUST-03)
- Interactions logged with timestamps (MUST-04)
- All customer data scoped to authenticated user
- Turkish language throughout
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-interface-matching/02-01-SUMMARY.md`
</output>
