---
phase: 05-telegram-bot-publishing
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/publishing/publishers/sahibinden.ts
  - functions/src/publishing/publishers/hepsiemlak.ts
  - functions/src/publishing/publishers/emlakjet.ts
  - functions/src/publishing/types.ts
autonomous: false
gap_closure: true
requirements: [PORT-05, PORT-06, PORT-07]

must_haves:
  truths:
    - "Portal publishers have complete category mapping for Turkish property types"
    - "Portal publishers handle location selection (city/district dropdowns)"
    - "Portal publishers include photo upload mechanics"
    - "Portal publishers handle CAPTCHA gracefully (fail with clear message)"
  artifacts:
    - path: "functions/src/publishing/publishers/sahibinden.ts"
      provides: "Complete sahibinden.com publishing automation"
      contains: "categoryMapping"
    - path: "functions/src/publishing/publishers/hepsiemlak.ts"
      provides: "Complete hepsiemlak publishing automation"
      contains: "categoryMapping"
    - path: "functions/src/publishing/publishers/emlakjet.ts"
      provides: "Complete emlakjet publishing automation"
      contains: "categoryMapping"
  key_links:
    - from: "functions/src/publishing/publishers/sahibinden.ts"
      to: "functions/src/publishing/photoResizer.ts"
      via: "resizeForPortal import"
      pattern: "resizeForPortal"
---

<objective>
Complete the skeleton portal publisher implementations by adding category mapping, location selection, photo upload mechanics, and CAPTCHA handling to all three Turkish portal publishers.

Purpose: Close Gap 2 from verification - publishers exist as stubs with TODO markers for critical functionality
Output: Production-ready publisher implementations for sahibinden.com, hepsiemlak, and emlakjet
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-telegram-bot-publishing/05-05-SUMMARY.md
@.planning/phases/05-telegram-bot-publishing/05-RESEARCH.md
@functions/src/publishing/publishers/sahibinden.ts
@functions/src/publishing/publishers/hepsiemlak.ts
@functions/src/publishing/publishers/emlakjet.ts
@functions/src/publishing/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete sahibinden.com publisher implementation</name>
  <files>functions/src/publishing/publishers/sahibinden.ts</files>
  <action>
Replace TODO markers with working implementations:

1. **Category Mapping** - Create categoryMapping object:
   ```typescript
   const categoryMapping: Record<string, { main: string; sub: string }> = {
     'daire': { main: 'emlak', sub: 'konut-satilik-daire' },
     'villa': { main: 'emlak', sub: 'konut-satilik-villa' },
     'mustakil': { main: 'emlak', sub: 'konut-satilik-mustakil-ev' },
     'arsa': { main: 'emlak', sub: 'arsa-satilik' },
     'isyeri': { main: 'emlak', sub: 'isyeri-satilik' },
     // Add kiralik variants based on listing.listingType
   };
   ```
   Map listing.propertyType to sahibinden category selectors.

2. **Location Selection** - Implement city/district dropdown automation:
   - Wait for and select city from dropdown: `await page.selectOption('#city', listing.location.city)`
   - Wait for district dropdown to populate
   - Select district: `await page.selectOption('#district', listing.location.district)`
   - Handle case where district not found (log warning, continue)

3. **Photo Upload** - Implement file input upload:
   - Get resized photos from resizeForPortal first
   - Use `await page.setInputFiles('input[type="file"][accept*="image"]', photoBuffers)`
   - Wait for upload confirmation (progress bar disappears or success indicator)
   - Handle upload failures gracefully

4. **CAPTCHA Handling** - Detect and fail gracefully:
   - Check for CAPTCHA element: `const hasCaptcha = await page.locator('.captcha, .g-recaptcha').count() > 0`
   - If CAPTCHA detected, return: `{ success: false, error: 'CAPTCHA algılandi. Lutfen portal uzerinden manuel olarak tamamlayin.' }`
   - Include debug screenshot path in error message

5. **Form Field Completion** - Fill all required fields:
   - rooms (oda sayisi)
   - area (m2)
   - floor (kat) if applicable
   - buildingAge (bina yasi) if applicable
   - features (ozellikler - checkboxes)

Gap reason: Skeleton implementation with 4 TODOs for category mapping, location selection, photo upload, CAPTCHA handling
  </action>
  <verify>
1. Run `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build`
2. No TODO markers remain in sahibinden.ts
3. categoryMapping object exists with at least 5 property type mappings
4. page.selectOption calls exist for city/district
5. page.setInputFiles call exists for photo upload
6. CAPTCHA detection logic exists
  </verify>
  <done>
sahibinden.ts has no TODO markers, includes category mapping, location selection, photo upload, and CAPTCHA handling, TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete hepsiemlak and emlakjet publisher implementations</name>
  <files>
functions/src/publishing/publishers/hepsiemlak.ts
functions/src/publishing/publishers/emlakjet.ts
  </files>
  <action>
Apply same pattern as sahibinden.ts but with portal-specific selectors:

**For hepsiemlak.ts:**
1. Category mapping with hepsiemlak-specific category IDs/URLs
2. Location: `/ilan-ver/emlak/konut/satilik/[city]/[district]` URL pattern or form selectors
3. Photo upload: Look for their specific file input selector
4. CAPTCHA: Check for hepsiemlak's CAPTCHA implementation
5. Form fields: rooms, area, floor, buildingAge, features with hepsiemlak selectors

**For emlakjet.ts:**
1. Category mapping with emlakjet-specific category structure
2. Location: Form dropdowns or URL-based category selection
3. Photo upload: Their specific upload mechanism
4. CAPTCHA: Check for emlakjet's verification
5. Form fields: Required emlakjet fields

**Common patterns for both:**
- Use randomDelay(500, 1000) between form interactions to avoid detection
- Wait for dynamic content with waitForSelector or waitForNavigation
- Graceful error handling with debug screenshots
- Return clear Turkish error messages

**Note:** Portal selectors may need adjustment based on actual portal structure. Use reasonable guesses based on common patterns:
- City/district: `select[name*="city"]`, `select[name*="district"]`
- Photo input: `input[type="file"]`, `.photo-upload input`
- Submit: `button[type="submit"]`, `.submit-btn`

Gap reason: Skeleton implementations with 5 TODOs each for critical functionality
  </action>
  <verify>
1. Run `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build`
2. No TODO markers remain in hepsiemlak.ts or emlakjet.ts
3. Both files have categoryMapping objects
4. Both files have location selection logic
5. Both files have photo upload logic
6. Both files have CAPTCHA detection
  </verify>
  <done>
hepsiemlak.ts and emlakjet.ts have no TODO markers, include complete implementations, TypeScript compiles
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify portal publisher implementations</name>
  <what-built>
Complete portal publisher implementations for sahibinden.com, hepsiemlak, and emlakjet with:
- Category mapping for Turkish property types
- Location selection (city/district)
- Photo upload mechanics
- CAPTCHA detection and graceful failure
  </what-built>
  <how-to-verify>
1. Review the three publisher files for completeness
2. Check that no TODO markers remain
3. Verify category mappings cover common property types (daire, villa, arsa, isyeri)
4. Confirm CAPTCHA handling returns user-friendly Turkish error message

**IMPORTANT:** Live testing against actual portals requires:
- Valid portal accounts with credentials
- Test listing data
- Caution to avoid creating unwanted real listings

If you want to proceed with live testing, provide portal credentials and confirm test data.
  </how-to-verify>
  <resume-signal>Type "approved" if implementation looks complete, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build` - TypeScript compilation succeeds
2. `grep -r "TODO" functions/src/publishing/publishers/` returns empty (no TODOs remain)
3. All three publishers have categoryMapping objects
4. All three publishers handle CAPTCHA detection
5. All three publishers use resizeForPortal before uploading photos
</verification>

<success_criteria>
- All three publishers (sahibinden, hepsiemlak, emlakjet) have complete implementations
- No TODO markers remain in any publisher file
- Category mapping covers at least 5 property types per portal
- CAPTCHA detected returns graceful Turkish error message
- TypeScript compiles without errors
- Gap 2 from VERIFICATION.md is closed: PORT-05, PORT-06, PORT-07 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-08-SUMMARY.md`
</output>
