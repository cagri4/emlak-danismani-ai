---
phase: 05-telegram-bot-publishing
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/triggers/onPropertyCreated.ts
  - functions/src/triggers/onCustomerCreated.ts
autonomous: true
gap_closure: true
requirements: [ILET-05]

must_haves:
  truths:
    - "New property creation triggers Telegram notification to matching customers with telegramChatId"
    - "New customer creation triggers Telegram notification with suggested properties"
    - "Customers without telegramChatId only receive in-app notifications"
  artifacts:
    - path: "functions/src/triggers/onPropertyCreated.ts"
      provides: "Telegram notification integration for property matches"
      contains: "sendTelegramNotification"
    - path: "functions/src/triggers/onCustomerCreated.ts"
      provides: "Telegram notification integration for property suggestions"
      contains: "sendTelegramNotification"
  key_links:
    - from: "functions/src/triggers/onPropertyCreated.ts"
      to: "functions/src/telegram/notifications.ts"
      via: "import sendTelegramNotification"
      pattern: "import.*sendTelegramNotification"
    - from: "functions/src/triggers/onCustomerCreated.ts"
      to: "functions/src/telegram/notifications.ts"
      via: "import sendTelegramNotification"
      pattern: "import.*sendTelegramNotification"
---

<objective>
Wire existing sendTelegramNotification function to Firestore matching triggers so customers with telegramChatId receive Telegram notifications for new property matches.

Purpose: Close Gap 1 from verification - sendTelegramNotification exists but is never called by triggers
Output: Updated trigger functions that send Telegram notifications alongside in-app notifications
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-telegram-bot-publishing/05-03-SUMMARY.md
@functions/src/triggers/onPropertyCreated.ts
@functions/src/triggers/onCustomerCreated.ts
@functions/src/telegram/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sendTelegramNotification to onPropertyCreated trigger</name>
  <files>functions/src/triggers/onPropertyCreated.ts</files>
  <action>
1. Import sendTelegramNotification from '../telegram/notifications'
2. Update Customer interface to include optional telegramChatId field (type: number)
3. After creating in-app notification for each match, check if customer has telegramChatId
4. If telegramChatId exists, call sendTelegramNotification with:
   - chatId: customer.telegramChatId
   - message: Turkish formatted message with property details and match score
   - Example message format: "Yeni mulk eslesmesi! [title] - [location] - [price] TL (%[score] eslesme)"
5. Use parseMode: 'HTML' for formatting if desired
6. Do NOT await sendTelegramNotification - fire and forget to avoid blocking trigger
7. Add error handling that logs but does not fail the trigger on Telegram errors

Gap reason: sendTelegramNotification function exists but is never called by triggers
Reference: functions/src/telegram/notifications.ts exports sendTelegramNotification(chatId, message, options)
  </action>
  <verify>
1. Run `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build`
2. Grep for sendTelegramNotification import in onPropertyCreated.ts
3. Grep for telegramChatId check in the notification loop
  </verify>
  <done>
onPropertyCreated trigger imports and calls sendTelegramNotification for customers with telegramChatId, TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sendTelegramNotification to onCustomerCreated trigger</name>
  <files>functions/src/triggers/onCustomerCreated.ts</files>
  <action>
1. Import sendTelegramNotification from '../telegram/notifications'
2. Update Customer interface to include optional telegramChatId field (type: number)
3. After creating in-app notification with property suggestions, check if customer has telegramChatId
4. If telegramChatId exists, call sendTelegramNotification with:
   - chatId: customer.telegramChatId
   - message: Turkish formatted message listing suggested properties
   - Example format: "Hoş geldiniz! Sizin için [N] mülk önerisi: [property1] (%score), [property2] (%score)..."
5. Use parseMode: 'HTML' for formatting if desired
6. Do NOT await sendTelegramNotification - fire and forget to avoid blocking trigger
7. Add error handling that logs but does not fail the trigger on Telegram errors

Gap reason: sendTelegramNotification function exists but is never called by triggers
Reference: functions/src/telegram/notifications.ts exports sendTelegramNotification(chatId, message, options)
  </action>
  <verify>
1. Run `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build`
2. Grep for sendTelegramNotification import in onCustomerCreated.ts
3. Grep for telegramChatId check after notification creation
  </verify>
  <done>
onCustomerCreated trigger imports and calls sendTelegramNotification for customers with telegramChatId, TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd /home/cagr/Masaüstü/emlak-danismani-ai-asistanı/functions && npm run build` - TypeScript compilation succeeds
2. Both trigger files import sendTelegramNotification
3. Both trigger files check for customer.telegramChatId before sending
4. Telegram notification failures do not break the trigger execution (logged only)
</verification>

<success_criteria>
- sendTelegramNotification is called in both onPropertyCreated and onCustomerCreated triggers
- Customers WITH telegramChatId receive both in-app AND Telegram notifications
- Customers WITHOUT telegramChatId receive only in-app notifications (no errors)
- TypeScript compiles without errors
- Gap 1 from VERIFICATION.md is closed: ILET-05 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-07-SUMMARY.md`
</output>
