---
phase: 05-telegram-bot-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/telegram/bot.ts
  - functions/src/telegram/commands/start.ts
  - functions/src/telegram/commands/help.ts
  - functions/src/telegram/notifications.ts
  - functions/src/index.ts
  - functions/package.json
autonomous: true
requirements:
  - ILET-05

must_haves:
  truths:
    - "Telegram webhook endpoint receives messages from Telegram API"
    - "User can start bot with /start and receive welcome message"
    - "System can send Telegram notifications programmatically"
  artifacts:
    - path: "functions/src/telegram/bot.ts"
      provides: "grammY bot instance with webhook handler"
      exports: ["bot", "telegramWebhook"]
    - path: "functions/src/telegram/notifications.ts"
      provides: "Telegram notification sender function"
      exports: ["sendTelegramNotification"]
  key_links:
    - from: "functions/src/index.ts"
      to: "telegramWebhook"
      via: "export"
      pattern: "export.*telegramWebhook"
    - from: "functions/src/telegram/bot.ts"
      to: "grammy"
      via: "Bot import"
      pattern: "import.*Bot.*grammy"

user_setup:
  - service: telegram
    why: "Telegram bot requires bot token from BotFather"
    env_vars:
      - name: TELEGRAM_BOT_TOKEN
        source: "Telegram @BotFather -> /newbot -> copy token"
    dashboard_config:
      - task: "Create new bot via /newbot command"
        location: "Telegram -> @BotFather"
      - task: "Set webhook URL after deploy"
        location: "curl https://api.telegram.org/bot<TOKEN>/setWebhook?url=<FUNCTION_URL>"
---

<objective>
Create Telegram bot foundation with grammY framework and webhook-based deployment on Firebase Cloud Functions.

Purpose: Enable Telegram as a communication channel for the real estate CRM, allowing users to receive notifications and interact with the system via Telegram.

Output: Working Telegram bot webhook endpoint, basic /start and /help commands, and notification sender function.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-telegram-bot-publishing/05-RESEARCH.md
@functions/src/index.ts
@functions/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install grammY and create bot instance</name>
  <files>
    functions/package.json
    functions/src/telegram/bot.ts
  </files>
  <action>
1. Install grammY in functions directory:
   ```bash
   cd functions && npm install grammy@^1.0.0
   ```

2. Create functions/src/telegram/bot.ts:
   - Import Bot and webhookCallback from grammy
   - Import onRequest from firebase-functions/v2/https
   - Create Bot instance with process.env.TELEGRAM_BOT_TOKEN
   - Export bot instance for use in other modules
   - Create telegramWebhook HTTPS function using webhookCallback(bot, "https")
   - Use region "europe-west1" for KVKK compliance
   - Add error handling for missing token

Bot setup pattern:
```typescript
const bot = new Bot(process.env.TELEGRAM_BOT_TOKEN || "");
// Register commands before creating webhook
bot.command("start", handleStart);
bot.command("help", handleHelp);
// Default handler for unknown messages
bot.on("message", (ctx) => ctx.reply("Bilinmeyen komut. /help yazarak yardim alabilirsiniz."));
```
  </action>
  <verify>
    - functions/src/telegram/bot.ts exists with Bot import from grammy
    - package.json contains grammy dependency
    - TypeScript compiles: cd functions && npm run build
  </verify>
  <done>grammY installed and bot instance created with webhook handler exported</done>
</task>

<task type="auto">
  <name>Task 2: Implement /start and /help commands</name>
  <files>
    functions/src/telegram/commands/start.ts
    functions/src/telegram/commands/help.ts
    functions/src/telegram/bot.ts
  </files>
  <action>
1. Create functions/src/telegram/commands/start.ts:
   - Export handleStart async function that takes grammY Context
   - Send Turkish welcome message:
     ```
     Merhaba! Emlak asistanina hosgeldiniz.

     Bu bot ile:
     - Mulk arayabilirsiniz (/ara)
     - Mulk durumunu guncelleyebilirsiniz (/durum)
     - Bildirim alabilirsiniz

     /help yazarak tum komutlari gorebilirsiniz.
     ```
   - Save user's telegramChatId to Firestore for future notifications (if user is linked)
   - For now, just log ctx.chat.id - user linking will be added later

2. Create functions/src/telegram/commands/help.ts:
   - Export handleHelp async function
   - List all available commands in Turkish:
     ```
     Mevcut komutlar:

     /ara [sorgu] - Mulk ara (ornek: /ara Cankaya 3+1 daire)
     /durum [id] [yeni_durum] - Mulk durumunu guncelle
     /eslesmeler - Son eslesmelerimi goster
     /help - Bu yardim mesajini goster
     ```

3. Update bot.ts to import and register command handlers
  </action>
  <verify>
    - cd functions && npm run build compiles without errors
    - start.ts and help.ts exist in functions/src/telegram/commands/
  </verify>
  <done>/start returns Turkish welcome message, /help lists available commands</done>
</task>

<task type="auto">
  <name>Task 3: Create notification sender and export webhook</name>
  <files>
    functions/src/telegram/notifications.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/telegram/notifications.ts:
   - Import Bot from grammy
   - Create reusable sendTelegramNotification function:
     ```typescript
     export async function sendTelegramNotification(
       chatId: number | string,
       message: string,
       options?: { parseMode?: 'HTML' | 'Markdown' }
     ): Promise<boolean>
     ```
   - Create bot instance for sending (can reuse from bot.ts or create new)
   - Handle Telegram API errors gracefully (chat not found, blocked by user)
   - Return true on success, false on failure
   - Truncate messages longer than 4096 characters with ellipsis

2. Update functions/src/index.ts:
   - Add export for telegramWebhook from telegram/bot
   - Keep existing exports (processPropertyPhoto, enhancePropertyPhoto, etc.)

3. Add TypeScript type for chat ID (number from Telegram API)
  </action>
  <verify>
    - cd functions && npm run build compiles successfully
    - functions/src/index.ts exports telegramWebhook
    - notifications.ts exports sendTelegramNotification
  </verify>
  <done>Notification sender function ready, webhook exported from index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd functions && npm run build` succeeds
2. Function exports: grep for "telegramWebhook" in functions/lib/index.js
3. grammY installed: check functions/package.json for grammy dependency
</verification>

<success_criteria>
- grammY package installed in functions/package.json
- Bot instance created with webhook handler
- /start and /help commands implemented with Turkish messages
- sendTelegramNotification function ready for use by triggers
- telegramWebhook exported from functions/src/index.ts
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-01-SUMMARY.md`
</output>
