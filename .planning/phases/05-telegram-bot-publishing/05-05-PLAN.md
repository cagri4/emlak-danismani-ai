---
phase: 05-telegram-bot-publishing
plan: 05
type: execute
wave: 2
depends_on:
  - 05-04
files_modified:
  - functions/src/publishing/publishers/sahibinden.ts
  - functions/src/publishing/publishers/hepsiemlak.ts
  - functions/src/publishing/publishers/emlakjet.ts
  - functions/src/publishing/publishProperty.ts
  - functions/src/index.ts
autonomous: false
requirements:
  - PORT-05
  - PORT-06
  - PORT-07

user_setup:
  - service: sahibinden
    why: "Portal requires user credentials for publishing"
    env_vars:
      - name: SAHIBINDEN_EMAIL
        source: "User's sahibinden.com account email"
      - name: SAHIBINDEN_PASSWORD
        source: "User's sahibinden.com account password"
  - service: hepsiemlak
    why: "Portal requires user credentials for publishing"
    env_vars:
      - name: HEPSIEMLAK_EMAIL
        source: "User's hepsiemlak.com account email"
      - name: HEPSIEMLAK_PASSWORD
        source: "User's hepsiemlak.com account password"
  - service: emlakjet
    why: "Portal requires user credentials for publishing"
    env_vars:
      - name: EMLAKJET_EMAIL
        source: "User's emlakjet.com account email"
      - name: EMLAKJET_PASSWORD
        source: "User's emlakjet.com account password"

must_haves:
  truths:
    - "User can publish listing to sahibinden.com"
    - "User can publish listing to hepsiemlak"
    - "User can publish listing to emlakjet"
  artifacts:
    - path: "functions/src/publishing/publishers/sahibinden.ts"
      provides: "Sahibinden.com Playwright publisher"
      exports: ["publishToSahibinden"]
    - path: "functions/src/publishing/publishers/hepsiemlak.ts"
      provides: "Hepsiemlak Playwright publisher"
      exports: ["publishToHepsiemlak"]
    - path: "functions/src/publishing/publishers/emlakjet.ts"
      provides: "Emlakjet Playwright publisher"
      exports: ["publishToEmlakjet"]
  key_links:
    - from: "functions/src/publishing/publishProperty.ts"
      to: "functions/src/publishing/publishers/*"
      via: "portal-specific publisher calls"
      pattern: "publishTo(Sahibinden|Hepsiemlak|Emlakjet)"
---

<objective>
Implement Playwright-based publishers for Turkish real estate portals using existing scraper infrastructure.

Purpose: Enable automated listing publication to sahibinden.com, hepsiemlak, and emlakjet from the system.

Output: Cloud Function for publishing with portal-specific Playwright automations.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-telegram-bot-publishing/05-RESEARCH.md
@.planning/phases/05-telegram-bot-publishing/05-04-SUMMARY.md
@functions/src/scrapers/common.ts
@functions/src/scrapers/sahibinden.ts
@functions/src/publishing/photoResizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sahibinden.com publisher</name>
  <files>
    functions/src/publishing/publishers/sahibinden.ts
  </files>
  <action>
1. Create functions/src/publishing/publishers/ directory

2. Create functions/src/publishing/publishers/sahibinden.ts:
   - Import createBrowser, randomDelay from scrapers/common
   - Import resizeForPortal from publishing/photoResizer
   - Import ListingData, PublishingResult from publishing/types

3. Implement publishToSahibinden function:
   ```typescript
   export async function publishToSahibinden(
     listing: ListingData,
     credentials: { email: string; password: string }
   ): Promise<PublishingResult> {
     const { browser, page } = await createBrowser();

     try {
       // 1. Navigate to login page
       await page.goto('https://www.sahibinden.com/giris');
       await randomDelay(2000, 3000);

       // 2. Login
       await page.fill('input[name="email"]', credentials.email);
       await page.fill('input[name="password"]', credentials.password);
       await page.click('button[type="submit"]');
       await page.waitForNavigation({ waitUntil: 'networkidle' });

       // 3. Check login success
       const loginError = await page.locator('.login-error').count();
       if (loginError > 0) {
         return { success: false, error: 'Giris basarisiz. Lutfen bilgilerinizi kontrol edin.' };
       }

       // 4. Navigate to listing creation
       await page.goto('https://www.sahibinden.com/ilan-ver');
       await randomDelay(1000, 2000);

       // 5. Select category (emlak -> konut -> satilik/kiralik)
       await page.click('[data-category="emlak"]');
       await randomDelay(500, 1000);
       // Map propertyType to sahibinden category
       // This is simplified - real implementation needs category mapping

       // 6. Fill form fields
       await page.fill('#title', listing.title);
       await page.fill('#price', String(listing.price));
       await page.fill('#description', listing.description);
       // ... additional fields based on portal form structure

       // 7. Upload photos (placeholder - needs actual implementation)
       // NOTE: Photo upload implementation depends on sahibinden's form structure
       // This may require inputFiles or drag-drop simulation

       // 8. Submit form
       await page.click('button.submit-listing');

       // 9. Wait for confirmation and get listing URL
       await page.waitForURL(/\/ilan\/\d+/, { timeout: 30000 });
       const listingUrl = page.url();
       const listingId = listingUrl.match(/\/ilan\/\d+-([^\/]+)/)?.[1];

       return {
         success: true,
         portalListingId: listingId,
         portalListingUrl: listingUrl
       };
     } catch (error) {
       // Screenshot for debugging
       await page.screenshot({ path: '/tmp/sahibinden-error.png' });
       console.error('Sahibinden publishing error:', error);
       return {
         success: false,
         error: `Yayinlama hatasi: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`
       };
     } finally {
       await browser.close();
     }
   }
   ```

4. Add TODO comments for:
   - Category mapping (propertyType -> sahibinden categories)
   - Location selection (city/district dropdowns)
   - Photo upload flow (file input or drag-drop)
   - CAPTCHA handling (may need manual intervention)
  </action>
  <verify>
    - cd functions && npm run build compiles
    - sahibinden.ts exports publishToSahibinden
    - Uses createBrowser from scrapers/common
  </verify>
  <done>Sahibinden.com publisher skeleton with login and form submission</done>
</task>

<task type="auto">
  <name>Task 2: Create hepsiemlak and emlakjet publishers</name>
  <files>
    functions/src/publishing/publishers/hepsiemlak.ts
    functions/src/publishing/publishers/emlakjet.ts
  </files>
  <action>
1. Create functions/src/publishing/publishers/hepsiemlak.ts:
   - Same pattern as sahibinden publisher
   - Login URL: https://www.hepsiemlak.com/giris
   - Listing URL: https://www.hepsiemlak.com/ilan-ver
   - Adapt selectors for hepsiemlak form structure
   - Add TODO comments for portal-specific implementation details

2. Create functions/src/publishing/publishers/emlakjet.ts:
   - Same pattern as sahibinden publisher
   - Login URL: https://www.emlakjet.com/uye-girisi
   - Listing URL: https://www.emlakjet.com/ilan-ver
   - Adapt selectors for emlakjet form structure
   - Note: emlakjet may have API transfer system for partners

3. Common error handling in both:
   - Screenshot on error for debugging
   - Turkish error messages
   - Login failure detection
   - Form validation error detection
   - Timeout handling (30s default)

4. Structure both files similar to sahibinden:
   ```typescript
   export async function publishToHepsiemlak(
     listing: ListingData,
     credentials: { email: string; password: string }
   ): Promise<PublishingResult> {
     // Similar implementation...
   }

   export async function publishToEmlakjet(
     listing: ListingData,
     credentials: { email: string; password: string }
   ): Promise<PublishingResult> {
     // Similar implementation...
   }
   ```
  </action>
  <verify>
    - cd functions && npm run build compiles
    - hepsiemlak.ts exports publishToHepsiemlak
    - emlakjet.ts exports publishToEmlakjet
  </verify>
  <done>Hepsiemlak and emlakjet publishers with login and form submission</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Create unified publish function and verify setup</name>
  <what-built>
Publishing infrastructure with Cloud Function callable for portal publishing:
- Portal-specific publishers for sahibinden, hepsiemlak, emlakjet
- Photo resizing before upload
- Unified publishProperty Cloud Function
- Error handling with Turkish messages
  </what-built>
  <files>
    functions/src/publishing/publishProperty.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/publishing/publishProperty.ts:
   ```typescript
   import { onCall, HttpsError } from 'firebase-functions/v2/https';
   import { publishToSahibinden } from './publishers/sahibinden';
   import { publishToHepsiemlak } from './publishers/hepsiemlak';
   import { publishToEmlakjet } from './publishers/emlakjet';
   import { generatePortalPhotos } from './photoResizer';
   import { PortalType, ListingData, PublishingResult } from './types';

   export const publishProperty = onCall(
     { region: 'europe-west1', memory: '2GiB', timeoutSeconds: 300 },
     async (request) => {
       const { portal, listing, credentials } = request.data as {
         portal: PortalType;
         listing: ListingData;
         credentials: { email: string; password: string };
       };

       // Validate input
       if (!portal || !listing || !credentials) {
         throw new HttpsError('invalid-argument', 'Portal, listing, ve credentials gerekli');
       }

       // Resize photos for portal
       const resizedPhotos = await generatePortalPhotos(listing.photoUrls, portal);
       console.log(`Resized ${resizedPhotos.length} photos for ${portal}`);

       // Publish to selected portal
       let result: PublishingResult;
       switch (portal) {
         case 'sahibinden':
           result = await publishToSahibinden(listing, credentials);
           break;
         case 'hepsiemlak':
           result = await publishToHepsiemlak(listing, credentials);
           break;
         case 'emlakjet':
           result = await publishToEmlakjet(listing, credentials);
           break;
         default:
           throw new HttpsError('invalid-argument', `Gecersiz portal: ${portal}`);
       }

       return result;
     }
   );
   ```

2. Update functions/src/index.ts:
   - Add export: `export { publishProperty } from './publishing/publishProperty';`

3. Verify TypeScript compiles: cd functions && npm run build
  </action>
  <how-to-verify>
1. Check TypeScript compilation: `cd functions && npm run build`
2. Verify exports in lib/index.js include publishProperty
3. Review publisher files for correct structure
4. NOTE: Actual portal publishing requires:
   - Portal credentials configured
   - Firebase Functions deployed
   - Portal form selectors may need adjustment based on current portal HTML
  </how-to-verify>
  <resume-signal>Type "approved" to confirm publishing infrastructure is ready, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd functions && npm run build` succeeds
2. All three publishers implemented with same interface
3. publishProperty Cloud Function exported
4. Photo resizing integrated before upload
</verification>

<success_criteria>
- publishToSahibinden, publishToHepsiemlak, publishToEmlakjet functions implemented
- All publishers use existing createBrowser infrastructure
- publishProperty Cloud Function callable with portal selection
- Error handling with Turkish messages and debug screenshots
- Photo resizing called before portal upload
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-05-SUMMARY.md`
</output>
