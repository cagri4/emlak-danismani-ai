---
phase: 05-telegram-bot-publishing
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/ai/pricePredictor.ts
  - functions/src/ai/valuationReport.ts
  - functions/src/index.ts
  - src/components/property/ValuationCard.tsx
  - src/hooks/useValuation.ts
autonomous: true
requirements:
  - ESLE-06
  - ESLE-07

must_haves:
  truths:
    - "AI generates price suggestion based on market data"
    - "User can view valuation report with reasoning"
    - "Price suggestion includes confidence level"
  artifacts:
    - path: "functions/src/ai/pricePredictor.ts"
      provides: "Claude-powered price prediction"
      exports: ["generatePriceSuggestion"]
    - path: "functions/src/ai/valuationReport.ts"
      provides: "AI valuation report generator"
      exports: ["generateValuationReport"]
    - path: "src/components/property/ValuationCard.tsx"
      provides: "UI component for valuation display"
      exports: ["ValuationCard"]
  key_links:
    - from: "functions/src/ai/pricePredictor.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude API"
      pattern: "anthropic.*messages\\.create"
    - from: "src/components/property/ValuationCard.tsx"
      to: "src/hooks/useValuation.ts"
      via: "hook import"
      pattern: "useValuation"
---

<objective>
Implement AI-powered price suggestions and valuation reports using Claude API with market data from competitor monitoring.

Purpose: Help real estate agents price properties competitively based on market analysis and property features.

Output: Price prediction Cloud Function, valuation report generator, and React UI component.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-telegram-bot-publishing/05-RESEARCH.md
@.planning/phases/03-background-processing-scraping/03-04-SUMMARY.md
@functions/src/jobs/imageProcessor.ts
@src/types/property.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create price prediction Cloud Function</name>
  <files>
    functions/src/ai/pricePredictor.ts
  </files>
  <action>
1. Create functions/src/ai/ directory

2. Create functions/src/ai/pricePredictor.ts:
   ```typescript
   import { onCall, HttpsError } from 'firebase-functions/v2/https';
   import { getFirestore } from 'firebase-admin/firestore';
   import Anthropic from '@anthropic-ai/sdk';

   interface PriceSuggestion {
     suggestedPrice: number;
     priceRange: { min: number; max: number };
     reasoning: string;
     marketTrend: 'yukselis' | 'durgun' | 'dusus';
     confidence: 'yuksek' | 'orta' | 'dusuk';
     comparableProperties: Array<{
       title: string;
       price: number;
       similarity: string;
     }>;
   }

   export const generatePriceSuggestion = onCall(
     { region: 'europe-west1', memory: '512MiB' },
     async (request) => {
       const { propertyId, userId } = request.data;

       if (!propertyId || !userId) {
         throw new HttpsError('invalid-argument', 'propertyId ve userId gerekli');
       }

       const db = getFirestore();

       // Get property details
       const propertyDoc = await db
         .collection('users').doc(userId)
         .collection('properties').doc(propertyId)
         .get();

       if (!propertyDoc.exists) {
         throw new HttpsError('not-found', 'Mulk bulunamadi');
       }

       const property = propertyDoc.data()!;

       // Get market data from notifications (competitor monitoring results)
       const notificationsSnap = await db
         .collection('users').doc(userId)
         .collection('notifications')
         .where('type', '==', 'competitor_listing')
         .orderBy('createdAt', 'desc')
         .limit(20)
         .get();

       const marketData = notificationsSnap.docs
         .map(doc => doc.data().data)
         .filter(d => d && d.price && d.location);

       // Build prompt for Claude
       const anthropic = new Anthropic({
         apiKey: process.env.ANTHROPIC_API_KEY
       });

       const prompt = `Sen bir Turkiye emlak piyasasi uzmanƒ± danƒ±≈ümanƒ±sƒ±n. Asagidaki mulk icin piyasa verilerine dayanarak fiyat onerisi yap.

MULK BILGILERI:
- Tip: ${property.type}
- Oda: ${property.rooms || 'Belirtilmemis'}
- Alan: ${property.area}m2
- Konum: ${property.location.district || ''}, ${property.location.city}
- Ozellikler: ${property.features?.join(', ') || 'Yok'}
- Bina Yasi: ${property.buildingAge || 'Belirtilmemis'} yil

PIYASA VERILERI (son 20 rakip ilan):
${marketData.length > 0
  ? marketData.map((m: any) =>
    `- ${m.price?.toLocaleString('tr-TR')} TL, ${m.area}m2, ${m.location?.district || m.location?.city}`
  ).join('\n')
  : 'Piyasa verisi bulunamadi - genel piyasa bilgisine gore degerlendir'}

Lutfen su JSON formatinda yanit ver (SADECE JSON, baska bir sey yazma):
{
  "suggestedPrice": number,
  "priceRange": { "min": number, "max": number },
  "reasoning": "string (Turkce, 2-3 cumle)",
  "marketTrend": "yukselis" | "durgun" | "dusus",
  "confidence": "yuksek" | "orta" | "dusuk",
  "comparableProperties": [
    { "title": "string", "price": number, "similarity": "string" }
  ]
}`;

       const response = await anthropic.messages.create({
         model: 'claude-sonnet-4-20250514',
         max_tokens: 2048,
         messages: [{ role: 'user', content: prompt }]
       });

       const content = response.content[0];
       if (content.type !== 'text') {
         throw new HttpsError('internal', 'AI yaniti alinamadi');
       }

       try {
         const suggestion: PriceSuggestion = JSON.parse(content.text);
         return suggestion;
       } catch {
         throw new HttpsError('internal', 'AI yaniti parse edilemedi');
       }
     }
   );
   ```
  </action>
  <verify>
    - cd functions && npm run build compiles
    - pricePredictor.ts exports generatePriceSuggestion
    - Claude API integration with structured JSON output
  </verify>
  <done>Price prediction Cloud Function using Claude API and market data</done>
</task>

<task type="auto">
  <name>Task 2: Create valuation report generator</name>
  <files>
    functions/src/ai/valuationReport.ts
    functions/src/index.ts
  </files>
  <action>
1. Create functions/src/ai/valuationReport.ts:
   ```typescript
   import { onCall, HttpsError } from 'firebase-functions/v2/https';
   import { getFirestore } from 'firebase-admin/firestore';
   import Anthropic from '@anthropic-ai/sdk';

   interface ValuationReport {
     propertyId: string;
     generatedAt: Date;
     estimatedValue: number;
     valueRange: { min: number; max: number };
     marketAnalysis: string;
     strengths: string[];
     weaknesses: string[];
     recommendations: string[];
     comparativeAnalysis: string;
     marketTrend: string;
     confidence: 'yuksek' | 'orta' | 'dusuk';
   }

   export const generateValuationReport = onCall(
     { region: 'europe-west1', memory: '512MiB' },
     async (request) => {
       const { propertyId, userId } = request.data;

       if (!propertyId || !userId) {
         throw new HttpsError('invalid-argument', 'propertyId ve userId gerekli');
       }

       const db = getFirestore();
       const propertyDoc = await db
         .collection('users').doc(userId)
         .collection('properties').doc(propertyId)
         .get();

       if (!propertyDoc.exists) {
         throw new HttpsError('not-found', 'Mulk bulunamadi');
       }

       const property = propertyDoc.data()!;

       // Get competitor data
       const notificationsSnap = await db
         .collection('users').doc(userId)
         .collection('notifications')
         .where('type', '==', 'competitor_listing')
         .orderBy('createdAt', 'desc')
         .limit(30)
         .get();

       const marketData = notificationsSnap.docs
         .map(doc => doc.data().data)
         .filter(d => d?.price);

       const anthropic = new Anthropic({
         apiKey: process.env.ANTHROPIC_API_KEY
       });

       const prompt = `Sen bir Turkiye emlak degerleme uzmanisin. Asagidaki mulk icin detayli degerleme raporu hazirla.

MULK:
- Baslik: ${property.title}
- Tip: ${property.type}
- Oda: ${property.rooms || 'Belirtilmemis'}
- Alan: ${property.area}m2
- Konum: ${property.location.neighborhood || ''} ${property.location.district || ''}, ${property.location.city}
- Ozellikler: ${property.features?.join(', ') || 'Yok'}
- Kat: ${property.floor || 'Belirtilmemis'}/${property.totalFloors || 'Belirtilmemis'}
- Bina Yasi: ${property.buildingAge || 'Belirtilmemis'} yil
- Mevcut Fiyat: ${property.price?.toLocaleString('tr-TR')} TL

PIYASA VERILERI:
${marketData.slice(0, 15).map((m: any) =>
  `- ${m.title || 'Ilan'}: ${m.price?.toLocaleString('tr-TR')} TL, ${m.area}m2`
).join('\n') || 'Veri yok'}

Su JSON formatinda yanit ver:
{
  "estimatedValue": number,
  "valueRange": { "min": number, "max": number },
  "marketAnalysis": "string (3-4 cumle, piyasa durumu)",
  "strengths": ["string", "string", "string"],
  "weaknesses": ["string", "string"],
  "recommendations": ["string", "string"],
  "comparativeAnalysis": "string (2-3 cumle, benzer mulklerle karsilastirma)",
  "marketTrend": "string (1 cumle, piyasa trendi)",
  "confidence": "yuksek" | "orta" | "dusuk"
}`;

       const response = await anthropic.messages.create({
         model: 'claude-sonnet-4-20250514',
         max_tokens: 4096,
         messages: [{ role: 'user', content: prompt }]
       });

       const content = response.content[0];
       if (content.type !== 'text') {
         throw new HttpsError('internal', 'AI yaniti alinamadi');
       }

       try {
         const report = JSON.parse(content.text);
         return {
           ...report,
           propertyId,
           generatedAt: new Date()
         } as ValuationReport;
       } catch {
         throw new HttpsError('internal', 'AI yaniti parse edilemedi');
       }
     }
   );
   ```

2. Update functions/src/index.ts:
   - Add exports:
     ```typescript
     export { generatePriceSuggestion } from './ai/pricePredictor';
     export { generateValuationReport } from './ai/valuationReport';
     ```
  </action>
  <verify>
    - cd functions && npm run build compiles
    - valuationReport.ts exports generateValuationReport
    - Both AI functions exported from index.ts
  </verify>
  <done>Valuation report generator with detailed market analysis</done>
</task>

<task type="auto">
  <name>Task 3: Create React UI components</name>
  <files>
    src/hooks/useValuation.ts
    src/components/property/ValuationCard.tsx
  </files>
  <action>
1. Create src/hooks/useValuation.ts:
   ```typescript
   import { useState, useCallback } from 'react';
   import { httpsCallable } from 'firebase/functions';
   import { functions } from '@/lib/firebase';
   import { useAuth } from '@/contexts/AuthContext';

   interface PriceSuggestion {
     suggestedPrice: number;
     priceRange: { min: number; max: number };
     reasoning: string;
     marketTrend: 'yukselis' | 'durgun' | 'dusus';
     confidence: 'yuksek' | 'orta' | 'dusuk';
     comparableProperties: Array<{
       title: string;
       price: number;
       similarity: string;
     }>;
   }

   interface ValuationReport {
     propertyId: string;
     estimatedValue: number;
     valueRange: { min: number; max: number };
     marketAnalysis: string;
     strengths: string[];
     weaknesses: string[];
     recommendations: string[];
     comparativeAnalysis: string;
     marketTrend: string;
     confidence: 'yuksek' | 'orta' | 'dusuk';
   }

   export function useValuation(propertyId: string) {
     const { user } = useAuth();
     const [priceSuggestion, setPriceSuggestion] = useState<PriceSuggestion | null>(null);
     const [valuationReport, setValuationReport] = useState<ValuationReport | null>(null);
     const [loading, setLoading] = useState(false);
     const [error, setError] = useState<string | null>(null);

     const fetchPriceSuggestion = useCallback(async () => {
       if (!user) return;
       setLoading(true);
       setError(null);

       try {
         const fn = httpsCallable(functions, 'generatePriceSuggestion');
         const result = await fn({ propertyId, userId: user.uid });
         setPriceSuggestion(result.data as PriceSuggestion);
       } catch (err) {
         setError('Fiyat onerisi alinamadi');
         console.error(err);
       } finally {
         setLoading(false);
       }
     }, [propertyId, user]);

     const fetchValuationReport = useCallback(async () => {
       if (!user) return;
       setLoading(true);
       setError(null);

       try {
         const fn = httpsCallable(functions, 'generateValuationReport');
         const result = await fn({ propertyId, userId: user.uid });
         setValuationReport(result.data as ValuationReport);
       } catch (err) {
         setError('Degerleme raporu alinamadi');
         console.error(err);
       } finally {
         setLoading(false);
       }
     }, [propertyId, user]);

     return {
       priceSuggestion,
       valuationReport,
       loading,
       error,
       fetchPriceSuggestion,
       fetchValuationReport
     };
   }
   ```

2. Create src/components/property/ValuationCard.tsx:
   ```typescript
   import { useState } from 'react';
   import { useValuation } from '@/hooks/useValuation';

   interface ValuationCardProps {
     propertyId: string;
     currentPrice: number;
   }

   export function ValuationCard({ propertyId, currentPrice }: ValuationCardProps) {
     const {
       priceSuggestion,
       valuationReport,
       loading,
       error,
       fetchPriceSuggestion,
       fetchValuationReport
     } = useValuation(propertyId);

     const [showReport, setShowReport] = useState(false);

     const confidenceColors = {
       yuksek: 'text-green-600',
       orta: 'text-yellow-600',
       dusuk: 'text-red-600'
     };

     const trendIcons = {
       yukselis: 'üìà',
       durgun: '‚û°Ô∏è',
       dusus: 'üìâ'
     };

     return (
       <div className="bg-white rounded-lg shadow-md p-6">
         <h3 className="text-lg font-semibold mb-4">AI Degerleme</h3>

         {!priceSuggestion && !loading && (
           <button
             onClick={fetchPriceSuggestion}
             className="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700"
           >
             Fiyat Onerisi Al
           </button>
         )}

         {loading && (
           <div className="text-center py-4">
             <div className="animate-spin w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto" />
             <p className="text-gray-500 mt-2">AI analiz ediyor...</p>
           </div>
         )}

         {error && (
           <p className="text-red-500 text-center">{error}</p>
         )}

         {priceSuggestion && (
           <div className="space-y-4">
             <div className="text-center">
               <p className="text-gray-500">Onerilen Fiyat</p>
               <p className="text-3xl font-bold text-purple-600">
                 {priceSuggestion.suggestedPrice.toLocaleString('tr-TR')} TL
               </p>
               <p className="text-sm text-gray-400">
                 {priceSuggestion.priceRange.min.toLocaleString('tr-TR')} -
                 {priceSuggestion.priceRange.max.toLocaleString('tr-TR')} TL
               </p>
             </div>

             <div className="flex justify-between text-sm">
               <span>Piyasa Trendi: {trendIcons[priceSuggestion.marketTrend]}</span>
               <span className={confidenceColors[priceSuggestion.confidence]}>
                 Guven: {priceSuggestion.confidence.toUpperCase()}
               </span>
             </div>

             <p className="text-gray-600 text-sm">{priceSuggestion.reasoning}</p>

             {!showReport && (
               <button
                 onClick={() => {
                   setShowReport(true);
                   fetchValuationReport();
                 }}
                 className="w-full border border-purple-600 text-purple-600 py-2 px-4 rounded-lg hover:bg-purple-50"
               >
                 Detayli Rapor Goster
               </button>
             )}
           </div>
         )}

         {valuationReport && showReport && (
           <div className="mt-4 pt-4 border-t space-y-3">
             <h4 className="font-semibold">Degerleme Raporu</h4>

             <div>
               <p className="text-sm font-medium text-gray-700">Piyasa Analizi</p>
               <p className="text-sm text-gray-600">{valuationReport.marketAnalysis}</p>
             </div>

             <div>
               <p className="text-sm font-medium text-green-700">Guclu Yonler</p>
               <ul className="text-sm text-gray-600 list-disc list-inside">
                 {valuationReport.strengths.map((s, i) => <li key={i}>{s}</li>)}
               </ul>
             </div>

             <div>
               <p className="text-sm font-medium text-red-700">Zayif Yonler</p>
               <ul className="text-sm text-gray-600 list-disc list-inside">
                 {valuationReport.weaknesses.map((w, i) => <li key={i}>{w}</li>)}
               </ul>
             </div>

             <div>
               <p className="text-sm font-medium text-blue-700">Oneriler</p>
               <ul className="text-sm text-gray-600 list-disc list-inside">
                 {valuationReport.recommendations.map((r, i) => <li key={i}>{r}</li>)}
               </ul>
             </div>
           </div>
         )}
       </div>
     );
   }
   ```
  </action>
  <verify>
    - npm run build compiles (client)
    - ValuationCard.tsx exports component
    - useValuation.ts hook works with both Cloud Functions
  </verify>
  <done>React components for displaying AI valuation with price suggestion and full report</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd functions && npm run build` and `npm run build` both succeed
2. Cloud Functions exported from index.ts
3. Claude API integration with Turkish prompts
4. React components use hooks correctly
</verification>

<success_criteria>
- generatePriceSuggestion returns price with range, reasoning, trend, and confidence
- generateValuationReport returns comprehensive analysis with strengths/weaknesses
- ValuationCard displays AI recommendations with Turkish labels
- Confidence levels and market trends shown with visual indicators
- Error handling with Turkish messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-06-SUMMARY.md`
</output>
