---
phase: 05-telegram-bot-publishing
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - functions/src/telegram/commands/search.ts
  - functions/src/telegram/commands/status.ts
  - functions/src/telegram/commands/matches.ts
  - functions/src/telegram/bot.ts
autonomous: true
requirements:
  - ILET-03
  - ILET-04

must_haves:
  truths:
    - "User can search properties via Telegram with natural language"
    - "User can update property status from Telegram"
    - "User can view recent matches from Telegram"
  artifacts:
    - path: "functions/src/telegram/commands/search.ts"
      provides: "Natural language property search via Claude AI"
      exports: ["handleSearch"]
    - path: "functions/src/telegram/commands/status.ts"
      provides: "Property status update command"
      exports: ["handleStatus"]
  key_links:
    - from: "functions/src/telegram/commands/search.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude API for query parsing"
      pattern: "anthropic.*messages\\.create"
    - from: "functions/src/telegram/commands/status.ts"
      to: "firebase-admin/firestore"
      via: "Firestore property update"
      pattern: "db.*properties.*update"
---

<objective>
Implement Telegram bot commands for property search using natural language and property status updates.

Purpose: Allow real estate agents to search their portfolio and update property statuses directly from Telegram without accessing the web interface.

Output: Working /ara (search), /durum (status update), and /eslesmeler (matches) commands.
</objective>

<execution_context>
@/home/cagr/.claude/get-shit-done/workflows/execute-plan.md
@/home/cagr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-telegram-bot-publishing/05-RESEARCH.md
@.planning/phases/05-telegram-bot-publishing/05-01-SUMMARY.md
@functions/src/telegram/bot.ts
@src/types/property.ts
@src/lib/matching/scoring-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /ara command with Claude AI parsing</name>
  <files>
    functions/src/telegram/commands/search.ts
    functions/src/telegram/bot.ts
  </files>
  <action>
1. Create functions/src/telegram/commands/search.ts:
   - Export handleSearch async function (grammY Context)
   - Extract query from message: ctx.message.text.replace("/ara", "").trim()
   - If no query, reply with usage: "Kullanim: /ara Cankaya'da 3+1 daire 5M'ye kadar"
   - Use Claude API to parse natural Turkish query into structured filters:
     ```typescript
     const response = await anthropic.messages.create({
       model: "claude-sonnet-4-20250514",
       max_tokens: 1024,
       messages: [{
         role: "user",
         content: `Parse this Turkish property search query into JSON filters:
         "${query}"

         Return ONLY valid JSON:
         {
           "location": { "city": "string or null", "district": "string or null" },
           "propertyType": "daire" | "villa" | "arsa" | "isyeri" | null,
           "rooms": "string or null",
           "maxPrice": number | null,
           "minPrice": number | null
         }`
       }]
     });
     ```

2. Query Firestore with parsed filters:
   - Get user's properties from users/{userId}/properties
   - Apply filters (propertyType, location.city, location.district)
   - Filter by price range client-side (existing pattern)
   - Limit to 5 results

3. Format and send results:
   - For each property, format as:
     ```
     [emoji] {title}
     [money] {price} TL
     [area] {area}m2 - {rooms}
     [location] {district}, {city}
     ```
   - If no results: "Aramaniza uygun mulk bulunamadi."
   - Truncate long lists with "... ve {N} mulk daha"

4. Handle user authentication:
   - For now, use a placeholder userId from ctx.from.id
   - Real user linking will require /link command (future enhancement)
   - Log warning if no user found: "Hesabiniz henuz baglanmadi. Web uygulamasindan Telegram'i baglayabilirsiniz."
  </action>
  <verify>
    - cd functions && npm run build compiles
    - search.ts exports handleSearch function
    - Claude API integration present with structured output parsing
  </verify>
  <done>/ara command parses Turkish natural language queries and returns matching properties</done>
</task>

<task type="auto">
  <name>Task 2: Implement /durum command for status updates</name>
  <files>
    functions/src/telegram/commands/status.ts
    functions/src/telegram/bot.ts
  </files>
  <action>
1. Create functions/src/telegram/commands/status.ts:
   - Export handleStatus async function
   - Parse command: /durum [property_id_or_title] [new_status]
   - Valid statuses: aktif, opsiyonlu, satildi, kiralandi
   - Map Turkish status variations (satıldı -> satildi, etc.)

2. Property identification:
   - If numeric ID provided, use directly
   - If text provided, search by title (fuzzy match with fuzzball)
   - If ambiguous, list matching properties and ask user to specify

3. Update property in Firestore:
   - Validate status is valid PropertyStatus type
   - Update status and updatedAt timestamp
   - Reply with confirmation: "{title} durumu '{status}' olarak guncellendi."

4. Error handling:
   - "Mulk bulunamadi" if no match
   - "Gecersiz durum. Gecerli durumlar: aktif, opsiyonlu, satildi, kiralandi"
   - "Birden fazla eslesme bulundu: ..." for ambiguous matches

5. Usage help if no args: "/durum [mulk_adi] [yeni_durum]"
  </action>
  <verify>
    - cd functions && npm run build compiles
    - status.ts exports handleStatus
    - Status validation for PropertyStatus types present
  </verify>
  <done>/durum command updates property status with Turkish confirmation messages</done>
</task>

<task type="auto">
  <name>Task 3: Implement /eslesmeler command and register all commands</name>
  <files>
    functions/src/telegram/commands/matches.ts
    functions/src/telegram/bot.ts
  </files>
  <action>
1. Create functions/src/telegram/commands/matches.ts:
   - Export handleMatches async function
   - Get user's recent match results from Firestore (last 5)
   - Query users/{userId}/match_outcomes ordered by timestamp desc
   - Format each match:
     ```
     Musteri: {customer_name}
     Mulk: {property_title}
     Eslesme: {score}%
     Tarih: {date}
     ```
   - If no matches: "Henuz esleme yok."

2. Update functions/src/telegram/bot.ts:
   - Import all command handlers: handleSearch, handleStatus, handleMatches
   - Register commands in bot setup:
     ```typescript
     bot.command("ara", handleSearch);
     bot.command("durum", handleStatus);
     bot.command("eslesmeler", handleMatches);
     ```
   - Add commands to BotFather suggestion (in help text)

3. Add proper error handling wrapper:
   - Catch all command errors and reply with Turkish error message
   - Log errors for debugging
   - Never let errors crash the webhook handler
  </action>
  <verify>
    - cd functions && npm run build compiles
    - bot.ts registers all command handlers
    - matches.ts exports handleMatches
  </verify>
  <done>All Telegram commands registered and working with proper error handling</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd functions && npm run build` succeeds
2. All commands registered in bot.ts
3. Claude API integration in search.ts for natural language parsing
4. Firestore integration for property queries and status updates
</verification>

<success_criteria>
- /ara command accepts Turkish natural language and returns matching properties
- /durum command updates property status with confirmation
- /eslesmeler shows recent match results
- All commands handle errors gracefully with Turkish messages
- User authentication placeholder ready for future /link command
</success_criteria>

<output>
After completion, create `.planning/phases/05-telegram-bot-publishing/05-02-SUMMARY.md`
</output>
